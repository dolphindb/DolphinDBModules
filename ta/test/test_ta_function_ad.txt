#include "setup/settings.txt"
use ta

precision=5
nan=double()
@testing:case="test_ta_function_ad_use_ticks1_contextby"
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec ta::ad(high, low, close, vol) from tickTB where sym=`tick1
rs1=[-12841.2244186 ,  30317.82604651,   -737.5998439 ,   1147.44725288,
       -23284.64522646,  21945.89477354,  54422.5994638 ,  95739.15660666]
assert 1, eqObj(tick1, rs1, precision)

tick2=exec ta::ad(high, low, close, vol) from tickTB where sym=`tick2
rs2=[             nan,              nan,              nan,
                    nan,              nan,              nan,
         12649.69      ,   31124.225     ,   38314.039     ,
         57238.574     ,   79481.93204878,   60328.40204878,
         26585.68204878,   -2880.26577731,  205279.19448936,
        522799.35448936,  602091.20161265,  456060.82252174,
        363541.84533864,  280385.92133864,  244265.98573864,
        402398.38542285,  285072.26956919,  157315.9762621 ,
        290328.78352526,  532041.02352526,  453072.23773579,
        314650.54173579,  425631.37295406,  461087.02998924,
        314135.4665564 ,  148925.0465564 ,  258217.73120756,
        123370.35120756,    5943.18170139, -104504.60829861,
       -115270.75029861,  -88356.55816746,   -8658.08091471,
         98895.2444699 ,   33755.44122204,  -67860.58360555,
       -194352.29360555, -272770.96838816, -195565.90146508,
       -302851.2316873 , -299796.50960809, -329979.03103667,
       -317320.4216249 , -246849.55382829, -312579.21613598,
       -225461.5754217 , -279260.83234477, -264754.07428026,
       -243173.88161839, -104374.11915462, -170696.74613875,
       -197250.11918222, -121173.55613875,  -95227.61677704,
        183024.50322296,  262163.53994427,  215812.77119427,
        143942.30157163,  204020.50232634,  270690.43194173,
        285986.39533156,  233613.75533156,  158447.81442247,
        252774.25817247,  135514.07857247,  160440.25571533,
        213565.40301262,  266550.23477733,  178464.35687035,
        259388.10348052,  302482.15503896,  300035.08375691,
        287549.59895691,  137314.25220691,   49364.41816197,
        108941.78350444,  145966.6671408 ,  102248.62643904,
        132212.77178788,  122743.92878788,   71934.51878788,
         64358.98928788,   33634.14928788,   -3265.72603679,
         -5899.22803679,  -14891.06603679,   21345.99583821,
         78984.49218741,   52082.27552075,   75114.87392075,
         60117.50392075,  100836.16912075,   95351.10283503,
         90767.74007641]
assert 2, eqObj(tick2, rs2, precision)

tick3=exec ta::ad(high, low, close, vol) from tickTB where sym=`tick3
rs3=[-13161.72628571,  -9967.46495238,  21301.60724945,  -9915.56654617,
       -30695.56254617]
assert 3, eqObj(tick3, rs3,precision)

tick4=exec ta::ad(high, low, close, vol) from tickTB where sym=`tick4
rs4=[ 27253.97280702,  73326.96021442,  57961.87266726,  82813.76266726,
        55395.65179006,  77254.43845673,  45454.77417101,  38932.61494025,
        75739.3043908 ,  81134.49307004,  84724.28428955,  78716.63896109,
        87063.83096109,  57355.90903126,  32325.19903126,  73167.60903126,
        52703.73441588,  24542.34441588,  30536.03836649,  89201.59836649,
        57646.06426123,  55345.53056558,  74595.86056558,  95928.04316832,
        84732.0378742 , 105844.1778742 , 101756.22258008, 109598.44924675,
       134164.47085965, 117358.87085965, 127857.5263391 , 108843.3138391 ,
        90808.89717244,  91743.88217244, 103710.60217244, 104982.36055082,
       112039.8008734 , 128831.94667985, 142558.7325622 , 178129.36333143,
       243419.63670493, 220358.70579584, 210453.19670493, 222544.06937159,
       211483.10830776, 204853.64713129, 205780.51513129, 192658.08513129,
       179787.89547612, 194874.24110112, 215666.45445776, 217474.02328129,
       210626.57116365, 206849.52300038, 206849.52300038, 155472.31300038,
       171261.60550038, 181777.29111442, 172354.28569775, 156489.8043252 ,
       155487.5855752 , 163777.20348565, 170033.51062851, 155383.42062851,
       164548.16200782, 165160.85400782, 144200.46400782, 160459.13525782,
       151997.2798732 , 145586.5798732 , 136145.23314593, 127936.17981259,
       134010.89341259, 147497.33745515, 188819.65745515, 182052.02876662,
       176745.83645893, 179208.34708393, 198241.56304138, 216642.65213229,
       219795.30773229, 196534.7982586 , 244040.29768717, 266884.50483003,
       275130.29908535, 270946.80479964, 282861.02447705, 271787.28647705,
       261050.06284069, 258923.48534069, 247645.82344196, 264034.21104196,
       267530.54640781, 267074.60293842, 271713.31466256, 330822.73466256,
       357502.67175933, 335781.73541787, 330742.41129089, 343159.14305559]
assert 4, eqObj(tick4, rs4, precision)

tick5=exec ta::ad(high, low, close, vol) from tickTB where sym=`tick5
rs5=[ 1.64362059e+05,  1.48302384e+05,  1.66985143e+05,  2.40243254e+05,
        1.93061644e+05,  2.20348402e+05,  1.85187264e+05,  1.82188511e+05,
        1.79000119e+05,  1.98667418e+05,  1.67569849e+05,  1.80974811e+05,
        2.31457587e+05,  1.82047346e+05,  1.36646796e+05,  1.80153114e+05,
        1.77817135e+05,  1.75522870e+05,  1.41446080e+05,  1.53833364e+05,
        1.55548494e+05,  1.35943794e+05,  1.26845440e+05,  1.56346472e+05,
        1.66757545e+05,  1.67905984e+05,  1.69160485e+05,  1.74168893e+05,
        1.91165369e+05,  1.98060242e+05,  1.78121458e+05,  2.02996452e+05,
        1.94213562e+05,  1.54459648e+05,  1.54459648e+05,  1.69743691e+05,
        1.70484794e+05,  1.68446188e+05,  1.95708489e+05,  1.97274369e+05,
        2.28182205e+05,  1.87467425e+05,  1.77952447e+05,  1.81640242e+05,
        2.27732202e+05,  1.92916407e+05,  1.87450624e+05,  1.81579376e+05,
        1.60812264e+05,  1.39433119e+05,  1.45041961e+05,  1.66509693e+05,
        1.61164728e+05,  1.47006446e+05,  1.59592502e+05,  1.55106572e+05,
        1.43043598e+05,  1.55803772e+05,  1.47334938e+05,  1.41311320e+05,
        1.44364244e+05,  1.51273357e+05,  1.72760358e+05,  1.75577860e+05,
        1.53480444e+05,  1.62520894e+05,  1.71081420e+05,  1.61371482e+05,
        1.67144676e+05,  1.59080166e+05,  1.44173644e+05,  1.31489344e+05,
        1.26347261e+05,  1.31043272e+05,  1.51399416e+05,  2.00045566e+05,
        1.83926788e+05,  1.80825555e+05,  1.94370261e+05,  2.12663108e+05,
        2.32102700e+05,  2.61703692e+05,  1.97430882e+05,  2.20356118e+05,
        2.16163713e+05,  2.32012082e+05,  2.84868072e+05,  3.58740472e+05,
        1.73362507e+05,  1.62259171e+05,  2.35284951e+05,  1.83548062e+05,
        5.85680669e+04,  1.30739374e+04,  5.82566592e+03, -9.39078666e+03,
        5.86205824e+01, -2.11794009e+04, -2.37774309e+04, -5.48615967e+03]
assert 5, eqObj(tick5,rs5, 3)

maBySym=(exec ta::ad(high, low, close, vol) from tickTB context by sym ).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(maBySym, rs, 3)


@testing:case="test_ta_function_ad"
close=[1,2,3,3.5,3.6,3,2,1,10,9,8,1,2,3,5,3,2,4,1,2,9,6.7,100,10,20].take(50)
high=[2,12,13,6.5,6.6,13,21,12,110,19,8,11,12,23,5,13,21,14,11,3,19,11.7,101,11,25].take(50)
low=[0.1,0.2,0.3,3.5,1.6,1.3,1,0,6,2,5,0,1.2,1.3,3,3,1.2,0,1,2,0.9,2.7,60,9,15].take(50)
volume = [10.0,20,30,30,60,30,20,10,10,90,80,10,20,30,50,30,20,40,10,20,90,60,100,10,10].take(50)
x = ad(high, low, close, volume)
y = [  -0.52631579,  -14.42462087,  -31.66871536,  -61.66871536,
        -73.66871536,  -94.95076664, -112.95076664, -121.28409998,
       -130.51486921, -146.39722215,  -66.39722215,  -74.57904033,
        -91.61607737, -116.91561654,  -66.91561654,  -96.91561654,
       -115.29945492, -132.44231207, -142.44231207, -162.44231207,
       -171.88982588, -178.55649254,  -83.43454133,  -83.43454133,
        -83.43454133,  -83.96085711,  -97.8591622 , -115.10325669,
       -145.10325669, -157.10325669, -178.38530797, -196.38530797,
       -204.7186413 , -213.94941053, -229.83176347, -149.83176347,
       -158.01358166, -175.05061869, -200.35015786, -150.35015786,
       -180.35015786, -198.73399625, -215.87685339, -225.87685339,
       -245.87685339, -255.3243672 , -261.99103387, -166.86908265,
       -166.86908265, -166.86908265]
assert 1, eqObj(x, y, 6)
