#include "setup/settings.txt"
use ta
//midpoint(inReal, optInTimePeriod)

precision=5
@testing:case="test_ta_function_midpoint_use_ticks_specify_timeperiod=10"
timePeriod=10
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec midPoint(close, timePeriod) from tickTB where sym=`tick1
rs1 = array(DOUBLE, size(tick1), size(tick1), NULL)
assert 1, eqObj(tick1, rs1, precision)

// different with talib when NULL in time_period window
tick2=exec midPoint(close, timePeriod) from tickTB where sym=`tick2
rs2 = [, , , , , , , , , ,  ,  , , , , 12.805, 12.96, 12.96, 12.96, 12.96, 12.96, 12.96, 12.96, 15.395, 15.395, 15.395, 15.23, 15.23, 15.115, 15.485, 15.485, 15.485, 15.485, 15.115, 15.115, 14.865, 14.665, 14.66, 14.66, 14.345, 13.535, 13.53, 12.705, 12.255, 12.255, 12.255, 12.21, 12.21, 12.21, 12.21, 11.98, 11.345, 11.28, 11.28, 11.525, 11.715, 11.835, 11.835, 11.97, 11.97, 12.87, 12.995, 13., 13.27, 13.585, 13.675, 13.675, 13.79, 13.79, 14.37, 14.37, 14.37, 14.425, 14.595, 14.595, 14.595, 14.725, 14.725, 14.725, 14.39, 13.985, 13.985, 13.985, 13.935, 13.935, 13.935, 13.905, 13.64, 12.845, 12.335, 12.325, 12.185, 12.02, 12.02, 11.94, 11.94, 11.7, 11.66, 11.66, 11.66]
assert 2, eqObj(tick2, rs2, precision);

tick3=exec midPoint(close, timePeriod) from tickTB where sym=`tick3
rs3 = array(DOUBLE, size(tick3), size(tick3), NULL)
assert 3, eqObj(tick3, rs3, precision)

tick4=exec midPoint(close, timePeriod) from tickTB where sym=`tick4
rs4 = [ , , , , , , , , , 11.665, 11.665, 11.665, 11.665, 11.25, 10.725, 10.725, 10.725, 10.59, 10.59, 10.59, 10.295, 10.115, 9.64, 9.585, 9.635, 9.645, 9.645, 9.69, 9.74, 9.835, 9.86, 10.3, 10.465, 10.535,  10.535, 10.535, 10.535, 10.535, 10.535, 10.705, 10.735, 10.735, 10.78, 10.815, 10.815, 10.565, 10.565, 10.08, 9.68, 9.68, 9.455, 9.315, 9.315, 9.25, 8.985, 8.985, 8.985, 8.985, 9.11, 8.715, 8.61, 8.61, 8.61, 8.565, 8.175, 8.175, 7.88, 7.525, 7.265, 7.13, 6.87, 6.85, 6.69, 6.69, 6.69, 6.42, 6.42, 6.33, 6.44, 6.565, 6.565, 6.565, 6.81, 7.19, 7.19, 7.19, 7.235, 7.345, 7.345, 7.345, 7.18, 7.18, 7.18, 7.085, 7.04, 7.04, 7.03, 7.03, 7.03, 7.03 ]
assert 4, eqObj(tick4, rs4, precision)

tick5=exec midPoint(close, timePeriod) from tickTB where sym=`tick5
rs5 = [ , , , , , , , , , 10.09, 10.09, 10.09, 10.09, 9.75, 9.28, 9.28, 9.28, 9.28, 9.06, 9.06, 9.06, 9.06, 8.52, 8.275, 8.275, 8.275, 8.275, 8.12, 8.18, 8.23, 8.23, 8.29, 8.72, 8.755, 8.76, 8.76, 8.76, 8.76, 8.785, 8.805, 8.825, 8.87, 8.87, 8.885, 9.06, 9.09, 9.08, 9.02, 8.6, 8.26, 8.26, 8.26, 8.26, 8.26, 8.08, 7.89, 7.83, 7.475, 7.475, 7.38, 7.36, 7.36, 7.36, 7.36, 7.32, 7.195, 7.195, 7.145, 7.145, 7.105, 6.805, 6.57, 6.57, 6.32, 6.32, 6.32, 6.12, 6.12, 6.005, 5.805, 5.9, 5.975, 5.975, 6.08, 6.29, 6.29, 6.445, 6.84, 6.915, 6.915, 7.005, 7.175, 7.175, 7.175, 7.2, 7.515, 7.595, 7.595, 7.565, 7.565]
assert 5, eqObj(tick5, rs5, precision)

midpointBySym = (exec midPoint(close, timePeriod) from tickTB context by sym).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(midpointBySym, rs, precision)

@testing:case="test_ta_function_midpoint_use_ticks_take40"
timePeriod=10
close = 1..40
tick1 = midPoint(close, timePeriod)
rs1 = [ , , , , , , , , , 5.5, 6.5, 7.5, 8.5, 9.5, 10.5, 11.5, 12.5, 13.5, 14.5, 15.5, 16.5, 17.5, 18.5, 19.5, 20.5, 21.5, 22.5, 23.5, 24.5, 25.5, 26.5, 27.5, 28.5, 29.5, 30.5, 31.5, 32.5, 33.5, 34.5, 35.5]
assert 1, eqObj(tick1, rs1, precision)

@testing:case="test_ta_function_midpoint_use_ticks_rand40"
timePeriod=10
close = [0.88004015, 0.36995343, 0.62203677, 0.88048967, 0.42871947, 0.25172133, 0.73376668, 0.50154779, 0.7667593, 0.91706729, 0.02341192, 0.12936362, 0.97538709, 0.30105016, 0.14285162, 0.00943651, 0.90928448, 0.37642867, 0.47983819, 0.35337849, 0.08833076, 0.49402081, 0.80629061, 0.25490584, 0.8499114, 0.28358796, 0.20181581, 0.41250942, 0.30640445, 0.82749753, 0.48304785, 0.29693986, 0.67527946, 0.51149582, 0.63056224, 0.82044577, 0.905032, 0.98154483, 0.48088229, 0.41311918]
tick1=midPoint(close, timePeriod)
rs1 = [ , , , , , , , , , 0.58439431, 0.47023961, 0.47023961, 0.49939951, 0.49939951, 0.49939951, 0.4924118, 0.4924118, 0.4924118, 0.4924118, 0.4924118, 0.4924118, 0.4924118, 0.45936049, 0.45936049, 0.45936049, 0.49880762, 0.46912108, 0.46912108, 0.46912108, 0.46912108, 0.5258636, 0.5258636, 0.5258636, 0.5258636, 0.51465667, 0.51465667, 0.60098593, 0.63924234, 0.63924234, 0.63924234]
assert 1, eqObj(tick1, rs1, precision)

@testing:case="test_ta_function_midpoint_use_ticks_bigarray"
timePeriod=10
close = bigarray(DOUBLE,0,2000000).append!(1..2000000)
tick1 = midPoint(close, timePeriod)
rs1 = array(DOUBLE, 9, size(close), NULL).append!(array(DOUBLE, 0, size(close), NULL).append!(5 .. 1999995) + 0.5)
assert 1, eqObj(tick1, rs1, precision)
