#include "setup/settings.txt"
use ta

precision=5
nan=double()
@testing:case="test_ta_function_mavp_contextby"
tickTB=loadText(DATA_DIR+"/ticks1.csv")
update tickTB set periods=1..size(tickTB.close)
tick1=exec ta::mavp(close, periods, 2,2,0) from tickTB where sym=`tick1
rs1=[   nan, 12.75 , 13.03 , 12.995, 12.64 , 12.865, 13.955, 14.605]
assert 1, eqObj(tick1, rs1, precision)

tick2=exec ta::mavp(close, periods, 2,2,0) from tickTB where sym=`tick2
rs2=[   nan,    nan,    nan,    nan,    nan,    nan,    nan, 14.865,
       15.83 , 15.99 , 12.97 , 10.14 ,  9.73 ,  9.375, 11.95 , 15.36 ,
       16.37 , 16.345, 16.18 , 15.81 , 15.265, 15.655, 15.585, 14.615,
       14.365, 15.32 , 15.995, 15.865, 15.94 , 16.46 , 16.515, 15.39 ,
       14.575, 13.985, 13.435, 13.185, 12.7  , 12.495, 12.78 , 13.255,
       13.505, 13.34 , 12.475, 11.39 , 11.21 , 11.445, 11.13 , 10.965,
       11.1  , 11.36 , 11.33 , 11.385, 11.68 , 11.655, 11.93 , 12.39 ,
       12.595, 12.595, 12.73 , 12.845, 13.45 , 14.215, 14.155, 14.025,
       14.335, 14.68 , 14.615, 14.475, 14.465, 14.58 , 14.555, 14.31 ,
       14.485, 14.85 , 14.82 , 14.785, 15.055, 15.19 , 15.11 , 14.31 ,
       13.155, 12.965, 13.185, 12.92 , 12.755, 12.77 , 12.69 , 12.46 ,
       12.175, 11.805, 11.47 , 11.32 , 11.445, 11.925, 11.95 , 11.89 ,
       11.92 , 11.92 , 12.05 , 11.995]
assert 2, eqObj(tick2, rs2, precision)

tick3=exec ta::mavp(close, periods, 2,2,0) from tickTB where sym=`tick3
rs3=[   nan, 26.3  , 26.445, 26.215, 24.84 ]
assert 3, eqObj(tick3, rs3,precision)

tick4=exec ta::mavp(close, periods, 2,2,0) from tickTB where sym=`tick4
rs4=[   nan, 11.74 , 11.995, 12.01 , 11.74 , 11.455, 11.435, 11.255,
       11.55 , 11.945, 12.005, 11.705, 11.41 , 10.955,  9.955,  9.9  ,
       10.275,  9.67 ,  9.215,  9.735,  9.755,  9.055,  9.24 ,  9.845,
       10.24 , 10.48 , 10.385, 10.43 , 10.63 , 10.775, 10.895, 10.735,
       10.35 , 10.195, 10.335, 10.37 , 10.35 , 10.61 , 10.855, 11.07 ,
       11.29 , 11.095, 10.625, 10.485, 10.525, 10.135,  9.815,  9.33 ,
        8.44 ,  8.335,  8.98 ,  9.305,  9.21 ,  9.085,  9.48 ,  9.435,
        9.045,  9.075,  8.645,  7.895,  7.395,  7.48 ,  7.735,  7.5  ,
        7.265,  7.42 ,  7.135,  6.865,  6.85 ,  6.595,  6.2  ,  5.92 ,
        5.885,  6.02 ,  6.48 ,  6.77 ,  6.675,  6.645,  6.85 ,  7.135,
        7.215,  7.04 ,  7.18 ,  7.615,  7.685,  7.445,  7.4  ,  7.48 ,
        7.335,  7.185,  6.87 ,  6.61 ,  6.645,  6.68 ,  6.755,  7.14 ,
        7.445,  7.225,  6.895,  6.78 ]
assert 4, eqObj(tick4, rs4, precision)

tick5=exec ta::mavp(close, periods, 2,2,0) from tickTB where sym=`tick5
rs5=[   nan, 10.265, 10.26 , 10.34 , 10.14 ,  9.925,  9.975,  9.825,
        9.725,  9.86 ,  9.87 ,  9.74 ,  9.915,  9.75 ,  8.95 ,  8.67 ,
        8.855,  8.89 ,  8.485,  8.12 ,  8.23 ,  8.19 ,  7.87 ,  7.995,
        8.405,  8.46 ,  8.55 ,  8.55 ,  8.61 ,  8.79 ,  8.735,  8.795,
        9.015,  8.76 ,  8.465,  8.575,  8.7  ,  8.765,  8.96 ,  9.14 ,
        9.18 ,  9.245,  9.225,  9.085,  9.23 ,  9.27 ,  8.9  ,  8.65 ,
        8.17 ,  7.41 ,  7.25 ,  7.615,  7.825,  7.73 ,  7.745,  7.84 ,
        7.555,  7.415,  7.36 ,  7.04 ,  6.86 ,  6.925,  7.205,  7.475,
        7.225,  6.985,  7.18 ,  7.015,  6.815,  6.775,  6.36 ,  5.825,
        5.61 ,  5.49 ,  5.455,  5.84 ,  6.1  ,  6.03 ,  6.03 ,  6.17 ,
        6.355,  6.525,  6.45 ,  6.35 ,  6.315,  6.255,  6.595,  7.255,
        7.485,  7.22 ,  7.425,  7.95 ,  8.065,  7.705,  7.395,  7.26 ,
        7.165,  7.22 ,  7.125,  7.065]
assert 5, eqObj(tick5,rs5, 3)

maBySym=(exec ta::mavp(close, periods, 2,2,0) from tickTB context by sym ).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(maBySym, rs, 3)

@testing:case="test_ta_function_mavp"
precision = 5
real = [0.76334978, 0.524085, 0.47371943, 0.05529655, 0.73936437]
periods = 1..5
out = [       nan, 0.64371739, 0.49890221, 0.26450799, 0.39733046]
assert 1, eqObj(mavp(real,periods,2, 2,0), out, precision)

@testing:case="test_ta_function_mavp_withNull"
precision = 5
real = [NULL, 0.524085, 0.47371943, 0.05529655, 0.73936437]
periods = [1, NULL, 3, 4, 5]
out =[       nan,        nan,        nan, 0.26450799, 0.39733046]
ta=mavp(real,periods,2, 2,0)
rs=take(nan,3).append!(ta.subarray(3:))
assert 1, eqObj(rs, out, precision)


