
#include "setup/settings.txt"

use ta

//linearreg(close, timeperiod=14)

@testing:case="test_ta_function_linearreg"
x = [89.79, 11.58, 99.9, 81.11, 84.69, 31.38, 60.9, 83.3, 97.26, 98.67]

validate = [ , , , , 85.28, 66.61, 46.05, 64.394, 86.918, 108.49 ]
assert 1,eqObj(ta::linearreg(x, 5), validate, 6)

validate = [ , , , , , 59.87190476, 64.78047619, 59.47952381, 80.6852381, 96.74333333]
assert 2,eqObj(ta::linearreg(x, 6), validate, 6)

validate = [ , , , , , , 58.94857143, 74.06178571, 74.00607143, 90.65928571]
assert 3,eqObj(ta::linearreg(x, 7), validate, 6)

close = [5.18, 71.01, 76.28, 5.92, 52.97, 16.45, 92.88, 7.37, 79.39, 15.82]
t = table(take(`A`B, 10) as sym, close)
re = exec ta::linearreg(close, 5) from t
validate = [ , , , , 48.37, 18.04,  57.646, 43.68,  58.564, 39.432]
assert 4,eqObj(re, validate, 6)


@testing:case="test_ta_function_linearreg_context_by"
tick = loadText(DATA_DIR + "/ticks1.csv")
res = select sym, ta::linearreg(close, 10) as linearreg from tick context by sym 
tick1 = exec linearreg from res where sym = `tick1
validate1 = take(double(), 8)
assert 1, eqObj(tick1, validate1, 6)
tick2 = exec linearreg from res where sym = `tick2
validate2 = [ , , , , , ,
  , , , , , ,
  , , ,11.94981818, 13.41309091, 14.72545455,
 16.29927273, 17.38181818, 17.39072727, 17.36036364, 16.55527273, 15.074,
 14.55454545, 14.83363636, 15.18890909, 15.40909091, 15.80254545, 16.26018182,
 16.40272727, 16.10272727, 15.68309091, 14.69763636, 13.86672727, 13.192,
 12.52890909, 12.02,       11.95145455, 12.32345455, 12.79927273, 12.93563636,
 12.71145455, 12.09127273, 11.80581818, 11.49072727, 10.98345455, 10.64363636,
 10.51054545, 10.72363636, 10.87654545, 11.29890909, 11.52290909, 11.58072727,
 11.89381818, 12.28490909, 12.51054545, 12.67581818, 12.87090909, 13.04181818,
 13.48090909, 13.97109091, 14.178,      14.29836364, 14.57090909, 14.85127273,
 14.91109091, 14.87436364, 14.77618182, 14.67563636, 14.61290909, 14.52854545,
 14.55236364, 14.63218182, 14.66927273, 14.81,       14.99618182, 15.12618182,
 15.17509091, 14.728,      13.99836364, 13.47472727, 13.11381818, 12.69490909,
 12.41854545, 12.22127273, 12.21745455, 12.17327273, 12.23836364, 11.93872727,
 11.58363636, 11.28818182, 11.28690909, 11.40690909, 11.46545455, 11.63781818,
 11.78109091, 11.94545455, 12.12345455, 12.11545455]
assert 2, eqObj(tick2, validate2, 6)
tick3 = exec linearreg from res where sym = `tick3
validate3 = take(double(), 5)
assert 3, eqObj(tick3, validate3, 6)
tick4 = exec linearreg from res where sym = `tick4
validate4 = [ , , , , , , , , , 11.63709091, 11.694,      11.64236364,
 11.60127273, 11.30509091, 10.58018182, 10.32672727, 10.02254545,  9.40563636,
  9.078,       9.23309091,  9.18436364,  8.98127273,  9.23145455,  9.50109091,
  9.74527273, 10.12763636, 10.39290909, 10.55236364, 10.69090909, 11.00418182,
 11.12018182, 10.91854545, 10.65927273, 10.47145455, 10.42872727, 10.35072727,
 10.26818182, 10.39163636, 10.53872727, 10.84418182, 11.15909091, 11.22272727,
 11.01963636, 10.89454545, 10.74345455, 10.34218182,  9.98763636,  9.41363636,
  8.68181818,  8.38472727,  8.48490909,  8.58636364,  8.62818182,  8.74163636,
  9.22509091,  9.26545455,  9.42781818,  9.37890909,  8.916,       8.28454545,
  7.78218182,  7.51236364,  7.34727273,  7.026,       7.02945455,  7.03890909,
  6.90927273,  6.95254545,  6.88163636,  6.64454545,  6.24254545,  5.97636364,
  5.82236364,  5.75727273,  5.98854545,  6.27145455,  6.394,       6.59836364,
  6.88054545,  7.17981818, 7.30036364,  7.256,       7.33709091,  7.506,
  7.64545455,  7.63309091,  7.62981818,  7.58163636,  7.46909091,  7.37836364,
  7.07472727,  6.772,       6.59545455,  6.54927273,  6.55454545,  6.77981818,
  7.01109091,  7.11145455,  7.08454545,  7.09345455]
assert 4, eqObj(tick4, validate4, 6)
tick5 = exec linearreg from res where sym = `tick5
validate5 = [ , , , , , , , , , 9.77327273, 9.70054545, 9.67945455,
 9.78290909, 9.71745455, 9.25254545, 9.03745455, 8.85727273, 8.72854545,
 8.33054545, 8.13890909, 8.01072727, 7.91836364, 7.80818182, 7.95927273,
 8.00381818, 8.14036364, 8.344,      8.52781818, 8.648,      8.79654545,
 8.84963636, 8.96854545, 8.97963636, 8.84745455, 8.73527273, 8.69454545,
 8.69218182, 8.68,       8.81290909, 8.95890909, 9.05927273, 9.22563636,
 9.35109091, 9.29581818, 9.368,      9.30090909, 9.09163636, 8.856,
 8.40563636, 7.80309091, 7.44690909, 7.33309091, 7.29181818, 7.20909091,
 7.384 ,     7.54490909, 7.53090909, 7.64181818, 7.53254545, 7.20672727,
 6.94945455, 6.85709091, 6.95254545, 7.07636364, 7.03290909, 7.08563636,
 7.15618182, 7.07981818, 7.03381818, 6.86127273, 6.48545455, 6.02381818,
 5.73145455, 5.46890909, 5.26890909, 5.36945455, 5.552,      5.656,
 5.866,      6.13636364, 6.37418182, 6.54854545, 6.57218182, 6.53781818,
 6.42945455, 6.41381818, 6.59909091, 6.95745455, 7.168,      7.24054545,
 7.55218182, 7.93872727, 8.14436364, 8.066,      7.89563636, 7.58218182,
 7.37254545, 7.29890909, 7.11945455, 6.93763636]
assert 5, eqObj(tick5, validate5, 6)
