#include "setup/settings.txt"
use ta
//dx(high, low, close, timePeriod)

precision=5
nan=double()
@testing:case="test_ta_function_dx_use_ticks1_contextby"
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec ta::dx(high, low, close, 10) from tickTB where sym=`tick1
rs1=[nan, nan, nan, nan, nan, nan, nan, nan]
assert 1, eqObj(tick1, rs1, precision)

tick2=exec ta::dx(high, low, close, 10) from tickTB where sym=`tick2
rs2=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan, 15.80456026, 15.80456026, 19.61884286, 11.61958897,
       11.61958897, 18.58149203, 18.58149203,  8.51378249,  4.47648604,
       18.54064102, 23.06116012, 23.06116012,  5.1259743 , 18.16869348,
       18.16869348,  3.02919726, 11.46856762, 15.80379798, 15.80379798,
       21.58496055, 32.8548021 , 32.8548021 , 22.20991764, 15.1837217 ,
        1.6678534 ,  3.94488031, 21.53728676, 32.07434072, 34.18625847,
       21.9670993 , 33.26033811, 30.66105301, 30.66105301, 17.8865302 ,
       17.8865302 , 10.01732596,  6.08326571,  6.54739485, 17.11813384,
       17.11813384, 25.55810379, 25.22858977, 27.95949571, 27.95949571,
       47.98536356, 53.88769722, 48.98733213, 51.55827758, 57.85213158,
       57.85213158, 44.78836921, 49.27962083, 49.27962083, 41.10420841,
       49.85198326, 31.21830788, 42.22170303, 44.90979187, 46.1038281 ,
       28.10720823, 41.39820885, 41.39820885, 35.02224441, 12.48104602,
       30.79401752, 32.92069351, 32.92069351, 38.90807499, 40.61786387,
       40.61786387, 24.80608119, 38.15290815, 38.15290815, 51.99454102,
       54.69820189, 58.97676314, 47.61679771, 27.78640648, 27.78640648,
       18.63505844, 18.63505844, 22.73385078, 13.71672538, 19.15186095]
assert 2, eqObj(tick2, rs2, precision)

tick3=exec ta::dx(high, low, close, 10) from tickTB where sym=`tick3
rs3=[nan, nan, nan, nan, nan]
assert 3, eqObj(tick3, rs3,precision)

tick4=exec ta::dx(high, low, close, 10) from tickTB where sym=`tick4
rs4=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
       25.21008403, 16.98878878, 16.98878878, 34.72552831, 52.77076822,
       49.64681108, 38.41505666, 53.11612682, 58.70861108, 32.69450894,
       36.75056678, 48.59191163, 36.3858781 , 21.41100307,  1.79029208,
        1.79029208,  2.28385317,  3.38108827,  3.38108827, 20.47144272,
       11.19964564, 14.84079826,  4.62632737,  4.20929804,  4.20929804,
        8.95538367,  8.95538367,  9.27808169, 11.0753477 , 21.75389215,
        9.92553873,  9.92553873, 14.96099525, 16.34095482,  3.71793357,
       30.20649402, 30.20649402, 46.46441919, 58.80905827, 58.80905827,
       26.48450071, 26.48450071, 13.48877282, 19.8435018 , 10.80028527,
       33.0341324 , 43.06804065, 43.06804065, 49.18539287, 57.37699722,
       62.19868137, 55.94304332, 50.77413744, 55.54897585, 57.38608217,
       43.2864332 , 52.57122431, 56.09101922, 52.2287178 , 56.42206153,
       62.66452418, 64.20743798, 67.84215817, 54.74676533, 27.56140826,
       14.6633994 , 14.6633994 , 14.6633994 ,  4.05167405,  7.03716379,
        7.03716379,  1.0758148 ,  8.88302531, 26.15173624, 15.04777852,
        9.22127689, 13.28746765, 18.93577647,  4.36788594,  1.30411549,
       22.66055589, 36.91497125, 34.11245025, 25.54639396, 21.52172625,
        1.11985884,  1.11985884,  7.40011601, 26.20635276, 26.20635276]
assert 4, eqObj(tick4, rs4, precision)

tick5=exec ta::dx(high, low, close, 10) from tickTB where sym=`tick5
rs5=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
        5.72625698, 29.31114731, 20.72640803, 32.87921836, 57.52932851,
       64.72617046, 47.78858781, 47.78858781, 60.9046304 , 62.73206495,
       51.25099194, 51.25099194, 64.45119802, 55.77221849, 43.95427986,
       35.26666262, 35.26666262, 40.52845734, 27.22387925, 20.32003728,
       14.01822567, 17.08869016,  0.41099428, 18.38796226, 25.91448079,
       25.91448079, 14.71898336, 11.65490058,  2.77231858,  9.04063603,
        0.63064397, 21.33594125,  7.45112212,  5.11585104,  7.39901407,
       19.66170959, 10.26594984, 10.26594984, 33.06192208, 47.79703612,
       47.79703612, 32.87157498, 21.44272141, 24.22796807, 31.02139827,
       23.63182748, 34.79983652, 41.31225697, 41.31225697, 53.08845909,
       54.68373957, 54.68373957, 32.97357078, 18.69442967, 32.42988262,
       37.05334676, 23.02359509, 32.66759329, 34.01833205, 34.01833205,
       50.45935007, 58.08104004, 60.38936755, 65.08867094, 59.3595771 ,
       29.87001045, 19.65745808, 23.31228869, 23.31228869, 13.24254018,
        2.03539863,  3.50089891, 10.68066454,  3.74239965,  3.22700655,
        8.76670171, 18.90056883, 39.04776316, 49.54375407, 29.1153566 ,
       38.26741548, 51.12249109, 54.53770789, 27.26724913, 18.51137026,
       14.47259215, 14.47259215, 24.29363943, 13.34940161, 11.78701883]
assert 5, eqObj(tick5,rs5, 3)

maBySym=(exec ta::dx(high, low, close, 10) from tickTB context by sym ).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(maBySym, rs, 3)

@testing:case="test_ta_function_dx_5"
high = [4.87661076, 5.09258627, 4.69128548, 4.51989263, 0.85037274]
low = [9.50391399, 8.50713385, 2.00315372, 1.04252965, 7.00412279]
close =[3.67652627, 7.14380803, 3.64008183, 5.90980276, 5.6898537 ]

assert 1, eqObj(dx(high, low, close, 4), take(double(),4).append!([100.000]),precision)


