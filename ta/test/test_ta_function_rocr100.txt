#include "setup/settings.txt"
use ta

//rocr100(close, timePeriod)
@testing:case="test_ta_function_rocr100_take40"
close=(1..40)
talib=take(double(),10).append!([ 1100.        ,  600.        ,
        433.33333333,  350.        ,  300.        ,  266.66666667,
        242.85714286,  225.        ,  211.11111111,  200.        ,
        190.90909091,  183.33333333,  176.92307692,  171.42857143,
        166.66666667,  162.5       ,  158.82352941,  155.55555556,
        152.63157895,  150.        ,  147.61904762,  145.45454545,
        143.47826087,  141.66666667,  140.        ,  138.46153846,
        137.03703704,  135.71428571,  134.48275862,  133.33333333])
assert 1, eqObj(rocr100(close,10),talib,5)
talib=take(double(),5).append!([ 600.        , 350.        , 266.66666667,
       225.        , 200.        , 183.33333333, 171.42857143,
       162.5       , 155.55555556, 150.        , 145.45454545,
       141.66666667, 138.46153846, 135.71428571, 133.33333333,
       131.25      , 129.41176471, 127.77777778, 126.31578947,
       125.        , 123.80952381, 122.72727273, 121.73913043,
       120.83333333, 120.        , 119.23076923, 118.51851852,
       117.85714286, 117.24137931, 116.66666667, 116.12903226,
       115.625     , 115.15151515, 114.70588235, 114.28571429])
assert 2, eqObj(rocr100(close,5),talib,5)
talib=take(double(),40)
assert 3, eqObj(rocr100(close,40),talib)

@testing:case="test_ta_function_rocr100_rand40"
close =[56.84486603, 63.63574239, 17.24385137, 14.96223024, 79.31584397,
       55.19487319, 76.11299983,  8.6658699 , 23.08781124, 35.93374603,
       76.92630291, 32.72657806, 42.13828084, 55.27681132, 95.80582219,
       58.47228524, 13.48667322, 85.25350829, 11.76174822, 27.89005755,
        7.8807707 , 14.4892506 , 54.22748916, 21.95583062, 67.02994747,
        9.96686312, 55.93319639, 71.14257436,  5.82524944, 71.46937892,
       56.47772433, 95.07794425, 79.77511056, 94.64802509, 68.46983317,
        5.71675094, 11.19925125, 97.10198567, 73.83804116,  4.85530577]
talib=take(double(),10).append!([  135.32673798,   51.42798187,
        244.36699166,  369.44232533,  120.79027013,  105.93789216,
         17.71927693,  983.7847703 ,   50.94353942,   77.61522421,
         10.24457227,   44.27364992,  128.68937242,   39.71978502,
         69.96437788,   17.04544825,  414.7293812 ,   83.44826599,
         49.52707141,  256.25396718,  716.65229811,  656.19642364,
        147.1119386 ,  431.08378238,  102.14812297,   57.35757451,
         20.02254828,  136.4892774 , 1267.55157733,    6.79354689])
assert 1, eqObj(rocr100(close,10),talib,5)
talib=take(double(),20).append!([13.86364548,  22.76904465, 314.47434797, 146.74169738,
        84.51016104,  18.05758858,  73.48704757, 820.95133184,
        25.23084315, 198.89209118,  73.41796264, 290.52210737,
       189.31743054, 171.2255516 ,  71.46729876,   9.77685568,
        83.03939057, 113.89793525, 627.78117486,  17.40873342])
assert 2, eqObj(rocr100(close,20),talib,5)

@testing:case="test_ta_function_rocr100_null"
close =[56.84486603, 63.63574239, 17.24385137, 14.96223024, 79.31584397,
       55.19487319, 76.11299983,  8.6658699 , 23.08781124, 35.93374603,
       76.92630291, 32.72657806, , 55.27681132, 95.80582219,, 
       13.48667322, 85.25350829, 11.76174822, 27.89005755,
        7.8807707 , 14.4892506 , , 21.95583062, 67.02994747,
        9.96686312, 55.93319639, 71.14257436,  5.82524944, 71.46937892,
       56.47772433, 95.07794425,, 94.64802509, 68.46983317,
        5.71675094, 11.19925125, 97.10198567, 73.83804116,  4.85530577]
talib=take(double(),10).append!([ 135.32673798,   51.42798187,
          ,  369.44232533,  120.79027013,  ,
         17.71927693,  983.7847703 ,   50.94353942,   77.61522421,
         10.24457227,   44.27364992,  ,   39.71978502,
         69.96437788,   ,  414.7293812 ,   83.44826599,
         49.52707141,  256.25396718,  716.65229811,  656.19642364,
          ,  431.08378238,  102.14812297,   57.35757451,
         20.02254828,  136.4892774 , 1267.55157733,    6.79354689])
assert 1, eqObj(rocr100(close,10),talib,5)
talib=take(double(),20).append!([ 13.86364548,  22.76904465,  , 146.74169738,
        84.51016104,  18.05758858,  73.48704757, 820.95133184,
        25.23084315, 198.89209118,  73.41796264, 290.52210737,
        , 171.2255516 ,  71.46729876,  ,
        83.03939057, 113.89793525, 627.78117486,  17.40873342 ])
assert 2, eqObj(rocr100(close,20),talib,5)

@testing:case="test_ta_function_rocr100_csv"
timePeriod=10
tickTB=loadText(DATA_DIR+"/ticks1.csv")
tick1=exec rocr100(close, timePeriod) from tickTB where sym=`tick1
rs1=take(double(), 8)
assert 1, eqObj(tick1, rs1, 5)

tick2=exec rocr100(close, timePeriod) from tickTB where sym=`tick2
rs2=[, , , , , , , , , , , , , , , , 115.54476058, 104.6997389 ,  99.87760098,  97.82608696,
       147.86407767, 161.12224449, 159.17721519, 152.53505933,
        99.7265892 ,  99.75139838,  95.73573574,  98.44139651,
        98.59068627, 110.        , 106.36900854,  90.67164179,
        96.55400928,  94.76661952,  92.32350925,  80.37383178,
        78.41907152,  79.10069664,  81.230578  ,  79.8573975 ,
        83.7654321 ,  89.91769547,  81.26286891,  81.64179104,
        85.2264291 ,  88.4496124 ,  86.8       ,  88.71096878,
        85.08033665,  86.30952381,  81.50331614,  89.32112891,
        98.39527027, 106.58135283, 106.271777  , 110.25416301,
       116.22119816, 113.53790614, 115.82733813, 110.43103448,
       127.3960217 , 122.45943638, 119.91416309, 120.75471698,
       119.59016393, 117.40858506, 114.67089611, 115.18282989,
       112.11180124, 114.91022639, 102.12916962,  99.23291492,
       105.51181102, 106.25      , 100.61686086, 100.81245768,
       105.25587828, 104.62387854, 104.29362881,  92.11956522,
        88.60319666,  92.62122277,  89.4843962 ,  84.55882353,
        87.60217984,  85.15782404,  83.44283837,  80.60686016,
        80.54448871,  84.66076696,  89.88235294,  84.82549317,
        88.77937832,  95.96837945,  91.44634526,  94.79495268,
        93.07086614,  98.36333879,  99.58779885, 103.7456446 ]
assert 2, eqObj(tick2, rs2, 5)

tick3=exec rocr100(close, timePeriod) from tickTB where sym=`tick3
rs3=take(double(), 5)
assert 3, eqObj(tick3, rs3,5)

tick4=exec rocr100(close, timePeriod) from tickTB where sym=`tick4
rs4=[,,,,,,,,,,1.05623902, 0.94132231, 0.96131203, 0.86397362, 0.830837  ,
       0.89705882, 0.90008842, 0.81785714, 0.7789916 , 0.85070892,
       0.77454243, 0.77260755, 0.84689414, 0.95515267, 1.11028632,
       1.01157184, 1.00982318, 1.15502183, 1.15210356, 1.06568627,
       1.17293233, 1.19886364, 1.04855372, 1.02297702, 0.99617956,
       0.9828408 , 1.01070039, 1.02362949, 1.01872659, 1.03587856,
       1.03663004, 1.03033175, 1.0226601 , 1.03417969, 1.00287632,
       0.95150339, 0.94513956, 0.81625115, 0.73897059, 0.76642984,
       0.82420495, 0.85372585, 0.8805395 , 0.85269122, 0.94933078,
       0.91131498, 0.93177189, 1.01809955, 1.03109453, 0.86906141,
       0.78135048, 0.82650862, 0.85339168, 0.79734219, 0.73816717,
       0.84004474, 0.73879781, 0.77444444, 0.81182147, 0.86133333,
       0.81481481, 0.76923077, 0.7525641 , 0.85694444, 0.92633015,
       0.8988016 , 0.97633136, 0.95982783, 1.04160475, 1.12383901,
       1.20707071, 1.17118644, 1.26916525, 1.26094003, 1.11782032,
       1.08148148, 1.13636364, 1.11509716, 1.02853067, 0.9862259 ,
       0.91771269, 0.96092619, 0.89261745, 0.86246787, 0.89591568,
       1.02465753, 0.988     , 0.94369973, 0.93619972, 0.95111732 ]
rs4=rs4*100
assert 4, eqObj(tick4, rs4, 5)

tick5=exec rocr100(close, timePeriod) from tickTB where sym=`tick5
rs5=[ ,  ,  ,  ,  ,  ,  ,  ,  ,  ,0.95205479, 0.9456838 , 0.98726738, 0.89971347, 0.86442406,
       0.88247012, 0.89303734, 0.91683778, 0.82801236, 0.81918082,
       0.84892086, 0.83282051, 0.75595238, 0.88853503, 0.99528302,
       0.95711061, 0.9740113 , 0.94960806, 1.08706468, 1.07804878,
       1.04479419, 1.10344828, 1.19028871, 1.00955795, 1.00473934,
       1.02240566, 1.01276102, 1.03773585, 1.04347826, 1.0361991 ,
       1.06604867, 1.03683036, 1.00992282, 1.06627219, 1.11438679,
       1.04844291, 0.99770905, 0.97613636, 0.8497807 , 0.77183406,
       0.8076087 , 0.83961249, 0.8569869 , 0.84461709, 0.83386243,
       0.85808581, 0.83926521, 0.87543655, 0.92903226, 0.97312588,
       0.92059219, 0.89871795, 0.94267516, 0.99211564, 0.87563452,
       0.90641026, 0.99726402, 0.8962766 , 0.95694444, 0.96802326,
       0.88596491, 0.79743224, 0.76081081, 0.70860927, 0.8057971 ,
       0.86562942, 0.8340192 , 0.88724036, 0.88243832, 0.93993994,
       1.06435644, 1.18067979, 1.11900533, 1.19626168, 1.1205036 ,
       1.02614379, 1.13651316, 1.27090301, 1.21217105, 1.12939297,
       1.20620155, 1.23030303, 1.27142857, 1.15625   , 1.18619583,
       1.13535032, 1.04196816, 0.95263158, 0.95115332, 1.00707214 ]*100
assert 5, eqObj(tick5, rs5, 5)

rocr100BySym=(exec rocr100(close, timePeriod) from tickTB context by sym).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(rocr100BySym, rs, 5)
