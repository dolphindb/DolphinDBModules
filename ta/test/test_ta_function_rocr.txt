#include "setup/settings.txt"
use ta

//rocr(close, timePeriod)
@testing:case="test_ta_function_rocr_take40"
close=(1..40)
talib=take(double(),10).append!([ 11.  ,  6.  ,  4.33333333,  3.5  ,  3.   ,
        2.66666667,  2.42857143,  2.25   ,  2.11111111,  2.  ,
        1.90909091,  1.83333333,  1.76923077,  1.71428571,  1.66666667,
        1.625 ,  1.58823529,  1.55555556,  1.52631579,  1.5   ,
        1.47619048,  1.45454545,  1.43478261,  1.41666667,  1.4   ,
        1.38461538,  1.37037037,  1.35714286,  1.34482759,  1.33333333])
assert 1, eqObj(rocr(close,10),talib,5)
talib=take(double(),5).append!([ 6.        , 3.5       , 2.66666667, 2.25      , 2.        ,
       1.83333333, 1.71428571, 1.625     , 1.55555556, 1.5       ,
       1.45454545, 1.41666667, 1.38461538, 1.35714286, 1.33333333,
       1.3125    , 1.29411765, 1.27777778, 1.26315789, 1.25      ,
       1.23809524, 1.22727273, 1.2173913 , 1.20833333, 1.2       ,
       1.19230769, 1.18518519, 1.17857143, 1.17241379, 1.16666667,
       1.16129032, 1.15625   , 1.15151515, 1.14705882, 1.14285714])
assert 2, eqObj(rocr(close,5),talib,5)
talib=take(double(),40)
assert 3, eqObj(rocr(close,40),talib)

@testing:case="test_ta_function_rocr_rand40"
close =[56.84486603, 63.63574239, 17.24385137, 14.96223024, 79.31584397,
       55.19487319, 76.11299983,  8.6658699 , 23.08781124, 35.93374603,
       76.92630291, 32.72657806, 42.13828084, 55.27681132, 95.80582219,
       58.47228524, 13.48667322, 85.25350829, 11.76174822, 27.89005755,
        7.8807707 , 14.4892506 , 54.22748916, 21.95583062, 67.02994747,
        9.96686312, 55.93319639, 71.14257436,  5.82524944, 71.46937892,
       56.47772433, 95.07794425, 79.77511056, 94.64802509, 68.46983317,
        5.71675094, 11.19925125, 97.10198567, 73.83804116,  4.85530577]
talib=take(double(),10).append!([  1.35326738,  0.51427982,  2.44366992,  3.69442325,  1.2079027 ,
        1.05937892,  0.17719277,  9.8378477 ,  0.50943539,  0.77615224,
        0.10244572,  0.4427365 ,  1.28689372,  0.39719785,  0.69964378,
        0.17045448,  4.14729381,  0.83448266,  0.49527071,  2.56253967,
        7.16652298,  6.56196424,  1.47111939,  4.31083782,  1.02148123,
        0.57357575,  0.20022548,  1.36489277, 12.67551577,  0.06793547])
assert 1, eqObj(rocr(close,10),talib,5)
talib=take(double(),20).append!([0.13863645, 0.22769045, 3.14474348, 1.46741697, 0.84510161,
       0.18057589, 0.73487048, 8.20951332, 0.25230843, 1.98892091,
       0.73417963, 2.90522107, 1.89317431, 1.71225552, 0.71467299,
       0.09776856, 0.83039391, 1.13897935, 6.27781175, 0.17408733])
assert 2, eqObj(rocr(close,20),talib,5)

@testing:case="test_ta_function_rocr_null"
close =[56.84486603, 63.63574239, 17.24385137, 14.96223024, 79.31584397,
       55.19487319, 76.11299983,  8.6658699 , 23.08781124, 35.93374603,
       76.92630291, 32.72657806, , 55.27681132, 95.80582219,, 
       13.48667322, 85.25350829, 11.76174822, 27.89005755,
        7.8807707 , 14.4892506 , , 21.95583062, 67.02994747,
        9.96686312, 55.93319639, 71.14257436,  5.82524944, 71.46937892,
       56.47772433, 95.07794425,, 94.64802509, 68.46983317,
        5.71675094, 11.19925125, 97.10198567, 73.83804116,  4.85530577]
talib=take(double(),10).append!([1.35326738,  0.51427982, ,  3.69442325,  1.2079027 ,
          ,  0.17719277,  9.8378477 ,  0.50943539,  0.77615224,
        0.10244572,  0.4427365 ,     ,  0.39719785,  0.69964378,
          ,  4.14729381,  0.83448266,  0.49527071,  2.56253967,
        7.16652298,  6.56196424,      ,  4.31083782,  1.02148123,
        0.57357575,  0.20022548,  1.36489277, 12.67551577,  0.06793547])
assert 1, eqObj(rocr(close,10),talib,5)
talib=take(double(),20).append!([ 0.13863645, 0.22769045, , 1.46741697, 0.84510161,
       0.18057589, 0.73487048, 8.20951332, 0.25230843, 1.98892091,
       0.73417963, 2.90522107, , 1.71225552, 0.71467299,
       , 0.83039391, 1.13897935, 6.27781175, 0.17408733 ])
assert 2, eqObj(rocr(close,20),talib,5)


@testing:case="test_ta_function_rocr_csv"
timePeriod=10
tickTB=loadText(DATA_DIR+"/ticks1.csv")
tick1=exec rocr(close, timePeriod) from tickTB where sym=`tick1
rs1=take(double(), 8)
assert 1, eqObj(tick1, rs1, 5)

tick2=exec rocr(close, timePeriod) from tickTB where sym=`tick2
rs2=[, , , , , , , , , , , , , , , , 1.15544761, 1.04699739, 0.99877601, 0.97826087,
       1.47864078, 1.61122244, 1.59177215, 1.52535059, 0.99726589,
       0.99751398, 0.95735736, 0.98441397, 0.98590686, 1.1       ,
       1.06369009, 0.90671642, 0.96554009, 0.9476662 , 0.92323509,
       0.80373832, 0.78419072, 0.79100697, 0.81230578, 0.79857398,
       0.83765432, 0.89917695, 0.81262869, 0.81641791, 0.85226429,
       0.88449612, 0.868     , 0.88710969, 0.85080337, 0.86309524,
       0.81503316, 0.89321129, 0.9839527 , 1.06581353, 1.06271777,
       1.10254163, 1.16221198, 1.13537906, 1.15827338, 1.10431034,
       1.27396022, 1.22459436, 1.19914163, 1.20754717, 1.19590164,
       1.17408585, 1.14670896, 1.1518283 , 1.12111801, 1.14910226,
       1.0212917 , 0.99232915, 1.05511811, 1.0625    , 1.00616861,
       1.00812458, 1.05255878, 1.04623879, 1.04293629, 0.92119565,
       0.88603197, 0.92621223, 0.89484396, 0.84558824, 0.8760218 ,
       0.85157824, 0.83442838, 0.8060686 , 0.80544489, 0.84660767,
       0.89882353, 0.84825493, 0.88779378, 0.95968379, 0.91446345,
       0.94794953, 0.93070866, 0.98363339, 0.99587799, 1.03745645]
assert 2, eqObj(tick2, rs2, 5)

tick3=exec rocr(close, timePeriod) from tickTB where sym=`tick3
rs3=take(double(), 5)
assert 3, eqObj(tick3, rs3,5)

tick4=exec rocr(close, timePeriod) from tickTB where sym=`tick4
rs4=[,,,,,,,,,,1.05623902, 0.94132231, 0.96131203, 0.86397362, 0.830837  ,
       0.89705882, 0.90008842, 0.81785714, 0.7789916 , 0.85070892,
       0.77454243, 0.77260755, 0.84689414, 0.95515267, 1.11028632,
       1.01157184, 1.00982318, 1.15502183, 1.15210356, 1.06568627,
       1.17293233, 1.19886364, 1.04855372, 1.02297702, 0.99617956,
       0.9828408 , 1.01070039, 1.02362949, 1.01872659, 1.03587856,
       1.03663004, 1.03033175, 1.0226601 , 1.03417969, 1.00287632,
       0.95150339, 0.94513956, 0.81625115, 0.73897059, 0.76642984,
       0.82420495, 0.85372585, 0.8805395 , 0.85269122, 0.94933078,
       0.91131498, 0.93177189, 1.01809955, 1.03109453, 0.86906141,
       0.78135048, 0.82650862, 0.85339168, 0.79734219, 0.73816717,
       0.84004474, 0.73879781, 0.77444444, 0.81182147, 0.86133333,
       0.81481481, 0.76923077, 0.7525641 , 0.85694444, 0.92633015,
       0.8988016 , 0.97633136, 0.95982783, 1.04160475, 1.12383901,
       1.20707071, 1.17118644, 1.26916525, 1.26094003, 1.11782032,
       1.08148148, 1.13636364, 1.11509716, 1.02853067, 0.9862259 ,
       0.91771269, 0.96092619, 0.89261745, 0.86246787, 0.89591568,
       1.02465753, 0.988     , 0.94369973, 0.93619972, 0.95111732 ]
assert 4, eqObj(tick4, rs4, 5)

tick5=exec rocr(close, timePeriod) from tickTB where sym=`tick5
rs5=[ ,  ,  ,  ,  ,  ,  ,  ,  ,  ,0.95205479, 0.9456838 , 0.98726738, 0.89971347, 0.86442406,
       0.88247012, 0.89303734, 0.91683778, 0.82801236, 0.81918082,
       0.84892086, 0.83282051, 0.75595238, 0.88853503, 0.99528302,
       0.95711061, 0.9740113 , 0.94960806, 1.08706468, 1.07804878,
       1.04479419, 1.10344828, 1.19028871, 1.00955795, 1.00473934,
       1.02240566, 1.01276102, 1.03773585, 1.04347826, 1.0361991 ,
       1.06604867, 1.03683036, 1.00992282, 1.06627219, 1.11438679,
       1.04844291, 0.99770905, 0.97613636, 0.8497807 , 0.77183406,
       0.8076087 , 0.83961249, 0.8569869 , 0.84461709, 0.83386243,
       0.85808581, 0.83926521, 0.87543655, 0.92903226, 0.97312588,
       0.92059219, 0.89871795, 0.94267516, 0.99211564, 0.87563452,
       0.90641026, 0.99726402, 0.8962766 , 0.95694444, 0.96802326,
       0.88596491, 0.79743224, 0.76081081, 0.70860927, 0.8057971 ,
       0.86562942, 0.8340192 , 0.88724036, 0.88243832, 0.93993994,
       1.06435644, 1.18067979, 1.11900533, 1.19626168, 1.1205036 ,
       1.02614379, 1.13651316, 1.27090301, 1.21217105, 1.12939297,
       1.20620155, 1.23030303, 1.27142857, 1.15625   , 1.18619583,
       1.13535032, 1.04196816, 0.95263158, 0.95115332, 1.00707214 ]
assert 5, eqObj(tick5, rs5, 5)

rocrBySym=(exec rocr(close, timePeriod) from tickTB context by sym).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(rocrBySym, rs, 5)
