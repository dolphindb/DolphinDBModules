#include "setup/settings.txt"
use ta

precision=5
nan=double()
@testing:case="test_ta_function_bBands_use_ticks_specify_timeperiod=10_contextby"
timePeriod=10
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec ta::bBands(close, timePeriod, 2, 2, 0) from tickTB where sym=`tick1
rs10=[nan, nan, nan, nan, nan, nan, nan, nan]
rs11=[nan, nan, nan, nan, nan, nan, nan, nan]
rs12=[nan, nan, nan, nan, nan, nan, nan, nan]
rs1=(rs10,rs11,rs12)
assert 1, eqObj(tick1,rs1, precision)

tick2=exec ta::bBands(close, timePeriod, 2, 2, 0) from tickTB where sym=`tick2
rs20=[        nan,         nan,         nan,         nan,         nan,
                nan,         nan,         nan,         nan,         nan,
                nan,         nan,         nan,         nan,         nan,
        18.80996469, 19.38264667, 19.56259997, 19.5568227 , 19.4771396 ,
        19.67467624, 19.76535958, 19.11834781, 17.08356608, 17.08943874,
        17.08002449, 16.85645711, 16.79845308, 16.72219194, 17.1170678 ,
        17.23504341, 17.18775752, 17.21827124, 17.40843907, 17.57206667,
        17.59628311, 17.54342334, 17.35856607, 16.8823948 , 15.84542483,
        14.78372958, 14.39504156, 14.0330759 , 14.30179699, 14.18125711,
        14.13897263, 14.19603644, 14.15646865, 13.91840802, 13.45134234,
        12.70609029, 11.96134653, 11.88819729, 11.9475459 , 12.20695278,
        12.58434215, 12.8205831 , 12.98583903, 13.18384216, 13.34334854,
        13.88133757, 14.42774406, 14.6342587 , 14.74088441, 15.01791661,
        15.29867268, 15.37568496, 15.33969037, 15.24654304, 14.91478842,
        14.90393632, 14.90513746, 14.91662425, 14.99203269, 15.00549731,
        15.04380176, 15.2414874 , 15.36080579, 15.41309539, 15.65495859,
        16.0394702 , 16.13415285, 16.11064894, 16.04473519, 15.92442467,
        15.68478577, 15.19579828, 14.57615392, 13.61946843, 13.56596538,
        13.63483897, 13.54806612, 13.2704105 , 13.16307543, 12.9225736 ,
        12.73027055, 12.44350902, 12.38059182, 12.36446464, 12.37991227]
rs21=[        nan,         nan,         nan,         nan,         nan,
                nan,         nan,         nan,         nan,         nan,
                nan,         nan,         nan,         nan,         nan,
        13.146     , 13.37      , 13.442     , 13.44      , 13.406     ,
        13.899     , 14.509     , 15.07      , 15.557     , 15.553     ,
        15.549     , 15.478     , 15.453     , 15.43      , 15.583     ,
        15.68      , 15.53      , 15.478     , 15.404     , 15.292     ,
        14.977     , 14.633     , 14.303     , 14.001     , 13.662     ,
        13.399     , 13.252     , 12.979     , 12.733     , 12.534     ,
        12.385     , 12.22      , 12.079     , 11.884     , 11.7       ,
        11.449     , 11.309     , 11.29      , 11.362     , 11.434     ,
        11.551     , 11.727     , 11.877     , 12.053     , 12.174     ,
        12.477     , 12.74      , 12.972     , 13.214     , 13.453     ,
        13.672     , 13.857     , 14.048     , 14.204     , 14.395     ,
        14.425     , 14.414     , 14.491     , 14.579     , 14.588     ,
        14.6       , 14.676     , 14.743     , 14.805     , 14.689     ,
        14.525     , 14.42      , 14.265     , 14.034     , 13.852     ,
        13.631     , 13.379     , 13.085     , 12.792     , 12.584     ,
        12.455     , 12.255     , 12.107     , 12.056     , 11.946     ,
        11.88      , 11.792     , 11.772     , 11.767     , 11.81      ]
rs22=[        nan,         nan,         nan,         nan,         nan,
                nan,         nan,         nan,         nan,         nan,
                nan,         nan,         nan,         nan,         nan,
         7.48203531,  7.35735333,  7.32140003,  7.3231773 ,  7.3348604 ,
         8.12332376,  9.25264042, 11.02165219, 14.03043392, 14.01656126,
        14.01797551, 14.09954289, 14.10754692, 14.13780806, 14.0489322 ,
        14.12495659, 13.87224248, 13.73772876, 13.39956093, 13.01193333,
        12.35771689, 11.72257666, 11.24743393, 11.1196052 , 11.47857517,
        12.01427042, 12.10895844, 11.9249241 , 11.16420301, 10.88674289,
        10.63102737, 10.24396356, 10.00153135,  9.84959198,  9.94865766,
        10.19190971, 10.65665347, 10.69180271, 10.7764541 , 10.66104722,
        10.51765785, 10.6334169 , 10.76816097, 10.92215784, 11.00465146,
        11.07266243, 11.05225594, 11.3097413 , 11.68711559, 11.88808339,
        12.04532732, 12.33831504, 12.75630963, 13.16145696, 13.87521158,
        13.94606368, 13.92286254, 14.06537575, 14.16596731, 14.17050269,
        14.15619824, 14.1105126 , 14.12519421, 14.19690461, 13.72304141,
        13.0105298 , 12.70584715, 12.41935106, 12.02326481, 11.77957533,
        11.57721423, 11.56220172, 11.59384608, 11.96453157, 11.60203462,
        11.27516103, 10.96193388, 10.9435895 , 10.94892457, 10.9694264 ,
        11.02972945, 11.14049098, 11.16340818, 11.16953536, 11.24008773]
rs2=(rs20,rs21,rs22)
assert 2, eqObj(tick2, rs2, precision)

tick3=exec ta::bBands(close, timePeriod, 2, 2, 0) from tickTB where sym=`tick3
rs30=[nan, nan, nan, nan, nan]
rs31=[nan, nan, nan, nan, nan]
rs32=[nan, nan, nan, nan, nan]
rs3=(rs30,rs31,rs32)
assert 3, eqObj(tick3, rs3,precision)

tick4=exec ta::bBands(close, timePeriod, 2, 2, 0) from tickTB where sym=`tick4
rs40=[        nan,         nan,         nan,         nan,         nan,
                nan,         nan,         nan,         nan, 12.35866954,
        12.41774066, 12.33158345, 12.2830603 , 12.32703935, 12.77007838,
        12.72740598, 12.7119483 , 12.84352682, 12.64166277, 12.2386446 ,
        11.71037779, 11.38305395, 10.79220288, 10.64149788, 10.84718873,
        10.88837262, 10.91479963, 11.0725274 , 11.21134405, 11.37823907,
        11.49638582, 11.1725582 , 11.05375085, 11.00830815, 11.00664331,
        11.00462287, 11.00040966, 11.06106488, 11.11550157, 11.27742204,
        11.42695891, 11.46828995, 11.44212982, 11.42027372, 11.41837363,
        11.53505841, 11.61274921, 11.86386224, 12.12429494, 11.89414172,
        11.46576606, 11.12806335, 10.90751776, 10.53191808, 10.30625822,
        10.14428103,  9.96337117,  9.97116665,  9.89369581, 10.19772354,
        10.31292811, 10.23232109, 10.11686451, 10.0423113 ,  9.47016345,
         9.21263214,  8.82183613,  8.25379316,  7.96929359,  7.99883977,
         8.13805586,  8.06159893,  7.82174846,  7.6936796 ,  7.53481218,
         7.24033492,  7.20391603,  7.11266175,  7.20959586,  7.43816169,
         7.55880382,  7.53695031,  7.57707962,  7.75134921,  7.87886278,
         7.89712135,  7.89599683,  7.84849382,  7.82845032,  7.831     ,
         7.95745761,  8.00819093,  8.00102948,  7.83312682,  7.68624156,
         7.74306906,  7.71182619,  7.60428924,  7.54808626,  7.49481905]
rs41=[        nan,         nan,         nan,         nan,         nan,
                nan,         nan,         nan,         nan, 11.681     ,
        11.745     , 11.674     , 11.628     , 11.463     , 11.271     ,
        11.152     , 11.039     , 10.835     , 10.572     , 10.393     ,
        10.122     ,  9.863     ,  9.688     ,  9.641     ,  9.745     ,
         9.757     ,  9.767     ,  9.909     , 10.05      , 10.117     ,
        10.278     , 10.453     , 10.5       , 10.523     , 10.519     ,
        10.501     , 10.512     , 10.537     , 10.557     , 10.596     ,
        10.636     , 10.668     , 10.691     , 10.726     , 10.729     ,
        10.679     , 10.622     , 10.423     , 10.139     ,  9.876     ,
         9.677     ,  9.518     ,  9.394     ,  9.238     ,  9.185     ,
         9.098     ,  9.031     ,  9.047     ,  9.072     ,  8.959     ,
         8.755     ,  8.594     ,  8.46      ,  8.277     ,  8.017     ,
         7.874     ,  7.635     ,  7.432     ,  7.276     ,  7.172     ,
         7.037     ,  6.86      ,  6.667     ,  6.564     ,  6.51      ,
         6.434     ,  6.418     ,  6.39      ,  6.418     ,  6.498     ,
         6.621     ,  6.722     ,  6.88      ,  7.041     ,  7.121     ,
         7.176     ,  7.266     ,  7.343     ,  7.363     ,  7.353     ,
         7.294     ,  7.267     ,  7.187     ,  7.08      ,  7.001     ,
         7.019     ,  7.01      ,  6.968     ,  6.922     ,  6.887     ]
rs42=       [        nan,         nan,         nan,         nan,         nan,
                nan,         nan,         nan,         nan, 11.00333046,
        11.07225934, 11.01641655, 10.9729397 , 10.59896065,  9.77192162,
         9.57659402,  9.3660517 ,  8.82647318,  8.50233723,  8.5473554 ,
         8.53362221,  8.34294605,  8.58379712,  8.64050212,  8.64281127,
         8.62562738,  8.61920037,  8.7454726 ,  8.88865595,  8.85576093,
         9.05961418,  9.7334418 ,  9.94624915, 10.03769185, 10.03135669,
         9.99737713, 10.02359034, 10.01293512,  9.99849843,  9.91457796,
         9.84504109,  9.86771005,  9.93987018, 10.03172628, 10.03962637,
         9.82294159,  9.63125079,  8.98213776,  8.15370506,  7.85785828,
         7.88823394,  7.90793665,  7.88048224,  7.94408192,  8.06374178,
         8.05171897,  8.09862883,  8.12283335,  8.25030419,  7.72027646,
         7.19707189,  6.95567891,  6.80313549,  6.5116887 ,  6.56383655,
         6.53536786,  6.44816387,  6.61020684,  6.58270641,  6.34516023,
         5.93594414,  5.65840107,  5.51225154,  5.4343204 ,  5.48518782,
         5.62766508,  5.63208397,  5.66733825,  5.62640414,  5.55783831,
         5.68319618,  5.90704969,  6.18292038,  6.33065079,  6.36313722,
         6.45487865,  6.63600317,  6.83750618,  6.89754968,  6.875     ,
         6.63054239,  6.52580907,  6.37297052,  6.32687318,  6.31575844,
         6.29493094,  6.30817381,  6.33171076,  6.29591374,  6.27918095]
rs4=(rs40,rs41,rs42)

assert 4, eqObj(tick4, rs4, precision)

tick5=exec ta::bBands(close, timePeriod, 2, 2, 0) from tickTB where sym=`tick5
rs50=[        nan,         nan,         nan,         nan,         nan,
                nan,         nan,         nan,         nan, 10.52822572,
        10.4964898 , 10.41110041, 10.37402116, 10.19512665, 10.57478601,
        10.54685275, 10.49814443, 10.44417889, 10.51654524, 10.34634751,
        10.18379759,  9.95396585,  9.48932784,  9.16571937,  9.15992098,
         9.05782598,  8.98017855,  8.81145601,  8.92656887,  9.05402664,
         9.09763846,  9.21328699,  9.10869496,  9.09784423,  9.09378395,
         9.09241687,  9.10070191,  9.10557021,  9.20944217,  9.29918289,
         9.3917272 ,  9.48269958,  9.50467854,  9.47874365,  9.54036888,
         9.50660572,  9.51203269,  9.56452235,  9.87178247, 10.17168886,
        10.14806623,  9.97474982,  9.78780534,  9.60842458,  9.16404553,
         8.77538869,  8.48325835,  8.10944852,  8.09589343,  8.14991961,
         8.21623223,  8.14752228,  8.03864256,  8.0243583 ,  7.86655256,
         7.67465965,  7.67055525,  7.59069673,  7.56643498,  7.59006756,
         7.76248371,  7.96151646,  7.9084267 ,  7.74135332,  7.65548678,
         7.45727284,  7.10232297,  6.92430038,  6.63451641,  6.45529102,
         6.58462582,  6.7618635 ,  6.79993074,  6.73668222,  6.61638777,
         6.62211234,  6.85031427,  7.35827563,  7.57389507,  7.64950202,
         7.95426179,  8.32260776,  8.52619383,  8.52548869,  8.42814443,
         8.2361451 ,  8.19495639,  8.17325067,  8.1892546 ,  8.18511744]
rs51=[        nan,         nan,         nan,         nan,         nan,
                nan,         nan,         nan,         nan, 10.043     ,
         9.994     ,  9.938     ,  9.925     ,  9.82      ,  9.687     ,
         9.569     ,  9.463     ,  9.382     ,  9.215     ,  9.034     ,
         8.887     ,  8.724     ,  8.478     ,  8.373     ,  8.369     ,
         8.331     ,  8.308     ,  8.263     ,  8.333     ,  8.397     ,
         8.434     ,  8.518     ,  8.663     ,  8.671     ,  8.675     ,
         8.694     ,  8.705     ,  8.737     ,  8.775     ,  8.807     ,
         8.864     ,  8.897     ,  8.906     ,  8.962     ,  9.059     ,
         9.101     ,  9.099     ,  9.078     ,  8.941     ,  8.732     ,
         8.555     ,  8.406     ,  8.275     ,  8.135     ,  7.978     ,
         7.849     ,  7.709     ,  7.602     ,  7.547     ,  7.528     ,
         7.469     ,  7.39      ,  7.345     ,  7.339     ,  7.241     ,
         7.168     ,  7.166     ,  7.088     ,  7.057     ,  7.035     ,
         6.957     ,  6.815     ,  6.638     ,  6.418     ,  6.284     ,
         6.189     ,  6.068     ,  5.992     ,  5.911     ,  5.871     ,
         5.91      ,  6.011     ,  6.078     ,  6.183     ,  6.25      ,
         6.266     ,  6.349     ,  6.511     ,  6.64      ,  6.721     ,
         6.854     ,  7.006     ,  7.177     ,  7.277     ,  7.393     ,
         7.478     ,  7.507     ,  7.471     ,  7.435     ,  7.44      ]
rs52=[        nan,         nan,         nan,         nan,         nan,
                nan,         nan,         nan,         nan,  9.55777428,
         9.4915102 ,  9.46489959,  9.47597884,  9.44487335,  8.79921399,
         8.59114725,  8.42785557,  8.31982111,  7.91345476,  7.72165249,
         7.59020241,  7.49403415,  7.46667216,  7.58028063,  7.57807902,
         7.60417402,  7.63582145,  7.71454399,  7.73943113,  7.73997336,
         7.77036154,  7.82271301,  8.21730504,  8.24415577,  8.25621605,
         8.29558313,  8.30929809,  8.36842979,  8.34055783,  8.31481711,
         8.3362728 ,  8.31130042,  8.30732146,  8.44525635,  8.57763112,
         8.69539428,  8.68596731,  8.59147765,  8.01021753,  7.29231114,
         6.96193377,  6.83725018,  6.76219466,  6.66157542,  6.79195447,
         6.92261131,  6.93474165,  7.09455148,  6.99810657,  6.90608039,
         6.72176777,  6.63247772,  6.65135744,  6.6536417 ,  6.61544744,
         6.66134035,  6.66144475,  6.58530327,  6.54756502,  6.47993244,
         6.15151629,  5.66848354,  5.3675733 ,  5.09464668,  4.91251322,
         4.92072716,  5.03367703,  5.05969962,  5.18748359,  5.28670898,
         5.23537418,  5.2601365 ,  5.35606926,  5.62931778,  5.88361223,
         5.90988766,  5.84768573,  5.66372437,  5.70610493,  5.79249798,
         5.75373821,  5.68939224,  5.82780617,  6.02851131,  6.35785557,
         6.7198549 ,  6.81904361,  6.76874933,  6.6807454 ,  6.69488256]
rs5=(rs50,rs51,rs52)
assert 5, eqObj(tick5, rs5, precision)

tick=(select (ta::bBands(close, timePeriod, 2, 2, 0))[0] as tt1, (ta::bBands(close, timePeriod, 2, 2, 0))[1] as tt2, (ta::bBands(close, timePeriod, 2, 2, 0))[2] as tt3 from tickTB context by sym).values() 
rs0=rs10.join(rs20.join(rs30.join(rs40.join(rs50))))
rs1=rs11.join(rs21).join(rs31).join(rs41).join(rs51)
rs2=rs12.join(rs22).join(rs32).join(rs42).join(rs52)
assert 6, eqObj(tick, (rs0,rs1,rs2), precision)

@testing:case="test_ta_function_bBands"
x=[80.547883,88.441286,53.563787,84.333949,86.184134,79.958874,80.857146,16.09588,70.020608,46.971058,5.667949]
rs=([         nan,          nan, 104.04984829, 106.57412763,
        104.61468967,  88.71272034,  87.8283341 , 119.60912668,
        112.30229881,  88.54614559,  94.13018496],
       [         nan,          nan,  74.18431867,  75.44634067,
         74.69395667,  83.492319  ,  82.33338467,  58.97063333,
         55.657878  ,  44.36251533,  40.88653833],
       [         nan,          nan,  44.31878904,  44.3185537 ,
         44.77322367,  78.27191766,  76.83843524,  -1.66786001,
         -0.98654281,   0.17888507, -12.35710829])
assert 1,eqObj(ta::bBands(x,3,2,2,0),rs,precision)
