use ta;

#include "setup/settings.txt"
timePeriod=10
tickTB=loadText(DATA_DIR+"/ticks1.csv")
nan=double()
@testing:case="test_ta_function_trange_use_tick1"
a1 = exec ta::atr(high, low, close, 2) from tickTB where sym=`tick1
b1 = [NULL,NULL,0.795,0.7075,0.95875,1.114375,1.2321875,0.96609375]
assert 1, eqObj(a1,b1,5)

a2 = exec ta::atr(high, low, close,2) from tickTB where sym=`tick2
b2 = [       nan,        nan,        nan,        nan,        nan,
              nan,        nan,        nan, 1.115     , 1.2075    ,
       3.59875   , 2.249375  , 1.5096875 , 1.21484375, 3.47242188,
       2.74621094, 2.46810547, 1.61905273, 1.51952637, 1.41976318,
       0.95988159, 1.4299408 , 1.3299704 , 1.2999852 , 1.1249926 ,
       1.5924963 , 1.27124815, 0.98562407, 1.47781204, 1.73390602,
       1.20195301, 1.4109765 , 1.13548825, 1.16774413, 0.98887206,
       1.03943603, 1.26971802, 0.93985901, 0.9249295 , 0.85246475,
       1.01123238, 0.79561619, 1.10280809, 1.01640405, 0.96320202,
       0.93160101, 1.00580051, 0.80790025, 0.57395013, 0.87697506,
       0.72848753, 0.78424377, 0.65212188, 0.48106094, 0.93553047,
       0.81276524, 0.72138262, 0.59069131, 0.64034565, 0.55517283,
       0.93258641, 0.77129321, 0.6456466 , 0.5878233 , 0.82391165,
       0.67195583, 0.65597791, 0.67798896, 0.55899448, 0.59949724,
       0.79974862, 0.64487431, 0.69243715, 0.51621858, 0.47310929,
       0.53155464, 0.65077732, 0.52038866, 0.51019433, 1.05509717,
       0.97254858, 0.85127429, 0.59063715, 0.58531857, 0.50765929,
       0.37882964, 0.44941482, 0.54970741, 0.38485371, 0.57742685,
       0.56371343, 0.63185671, 0.63592836, 0.63296418, 0.53148209,
       0.51574104, 0.40787052, 0.45393526, 0.40196763, 0.35098382]
assert 2, eqObj(a2,b2,5)

a3 = exec ta::atr(high, low, close,2) from tickTB where sym=`tick3
b3 = [NULL,NULL,1.,1.185,1.8425]
assert 3, eqObj(a3,b3,5)

a4 = exec ta::atr(high, low, close,2) from tickTB where sym=`tick4
b4 = [NULL,NULL,0.805,0.7425,0.94125,0.740625,0.5103125,0.51515625,0.71257813,0.62128906,0.51564453,0.94282227,0.69641113,0.91820557,0.98410278,0.96205139,0.7410257,0.88051285,0.84525642,0.88762821,0.91881411,0.91940705,0.89970353,0.81485176,0.88742588,0.64371294,0.49185647,0.45592824,0.38296412,0.52648206,0.62824103,0.75412051,0.79706026,0.79853013,0.50426506,0.43713253,0.37356627,0.49678313,0.41839157,0.46919578,0.64959789,0.57979895,0.62489947,0.53744974,0.50372487,0.70186243,0.55093122,0.80046561,0.9802328,0.8151164,1.1225582,0.7312791,0.79063955,0.88531978,0.89265989,0.96132994,0.96066497,0.79033249,0.87516624,0.94758312,0.79379156,0.73189578,0.54094789,0.60547395,0.44773697,0.38386849,0.56693424,0.52346712,0.45673356,0.46836678,0.50918339,0.6145917,0.55729585,0.51364792,0.56682396,0.58841198,0.42420599,0.372103,0.4210515,0.43052575,0.34026287,0.36013144,0.53006572,0.51003286,0.49501643,0.45250821,0.38125411,0.34062705,0.39031353,0.31515676,0.55257838,0.65128919,0.5306446,0.5103223,0.54516115,0.66258057,0.48629029,0.45314514,0.54157257,0.44078629]
assert 4, eqObj(a4,b4,5)

a5 = exec ta::atr(high, low, close,2) from tickTB where sym=`tick5
b5 = [NULL,NULL,0.66,0.63,0.76,0.67,0.51,0.5,0.475,0.4575,0.37875,0.559375,0.5096875,0.72984375,0.83492187,0.85746094,0.74373047,0.53186523,0.71093262,0.54546631,0.51273315,0.42636658,0.67318329,0.71659164,0.60329582,0.58664791,0.41832396,0.36916198,0.34458099,0.28729049,0.35864525,0.43432262,0.46716131,0.61858066,0.57929033,0.43464516,0.36232258,0.29116129,0.37058065,0.32029032,0.32514516,0.38257258,0.40628629,0.41814315,0.43407157,0.55203579,0.66101789,0.51550895,0.68775447,0.80887724,0.66443862,0.78221931,0.64610965,0.58805483,0.59402741,0.47201371,0.49100685,0.51050343,0.43025171,0.58512586,0.58756293,0.42878146,0.54939073,0.45969537,0.57984768,0.49992384,0.44996192,0.53998096,0.42499048,0.32749524,0.54374762,0.52687381,0.56343691,0.56171845,0.45585923,0.50792961,0.42896481,0.3444824,0.2672412,0.2336206,0.2818103,0.30590515,0.39795258,0.40397629,0.37198814,0.35599407,0.49299704,0.59149852,0.71074926,0.61037463,0.67018731,0.72009366,0.76004683,0.73002341,0.76501171,0.69250585,0.49125293,0.54062646,0.49531323,0.48265662]
assert 5, eqObj(a5,b5,5)

a6 = (exec ta::atr(high, low, close, 2) from tickTB context by sym).values()[0]
b6 = b1.join(b2).join(b3).join(b4).join(b5)
assert 6, eqObj(a6,b6,5)
