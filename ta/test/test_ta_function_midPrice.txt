#include "setup/settings.txt"
use ta
//midPrice(inLow, inHigh, optInTimePeriod)

precision=5
@testing:case="test_ta_function_midprice_use_ticks_specify_timeperiod=10"
timePeriod=10
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec midPrice(low, high, timePeriod) from tickTB where sym=`tick1
rs1 = array(DOUBLE, size(tick1), size(tick1), NULL)
assert 1, eqObj(tick1, rs1, precision)

tick2=exec midPrice(high, low,  timePeriod) from tickTB where sym=`tick2
rs2 = [ , , , , , , , , , , , , , , ,12.985,  12.985,  12.985,  12.915,  12.915,  12.915,  12.915,  12.915, 15.45,  15.265, 15.265, 15.265, 15.235, 15.19,  15.19,  15.41,  15.41,  15.41,  15.395, 15.2, 15.09,  14.745, 14.44,  14.44,  14.44,  13.635, 13.25,  13.045, 12.5, 12.4, 12.4, 12.27,  12.27,  12.225, 12.225,  12.155, 11.545, 11.375, 11.375, 11.375, 11.59,  11.835, 11.835, 11.98,  12.025,  12.285, 12.865, 12.865, 13.285, 13.285, 13.635, 13.635, 13.69,  13.69,  14.245,  14.35,  14.35,  14.395, 14.545, 14.545, 14.545, 14.555, 14.68,  14.68,  14.68,  14.265, 14.125, 14.11,  14.075, 13.96,  13.89,  13.89,  13.65,  12.95,  12.535,  12.335, 12.26,  12.11,  12.11,  12.11,  12.11,  11.865, 11.865, 11.76,  11.76]
assert 2, eqObj(tick2, rs2, precision)

tick3=exec midPrice(low, high, timePeriod) from tickTB where sym=`tick3
rs3 = array(DOUBLE, size(tick3), size(tick3), NULL)
assert 3, eqObj(tick3, rs3, precision)

tick4=exec midPrice(high, low,  timePeriod) from tickTB where sym=`tick4
rs4 = [, , , , , , , , , 11.595, 11.66, 11.66, 11.66, 11.66, 11.05, 11.05, 11.05, 10.9,10.645,10.645, 10.295,10.205, 9.885, 9.705, 9.715, 9.74,9.74,9.825, 9.845,10.,10., 10.185,10.435,10.59, 10.57, 10.57, 10.57, 10.57, 10.57, 10.605, 10.605,10.63, 10.63, 10.63, 10.635,10.61, 10.405,10.35,9.965, 9.75, 9.75,9.55,9.55,9.55,9.31,9.31,9.31,9.31,9.31,9.205,  8.78,8.78,8.78,8.78,8.145, 7.94,7.94,7.55,7.265, 7.21, 7.005, 7.005, 6.655, 6.655, 6.655, 6.36,6.315, 6.315, 6.28,6.44, 6.495, 6.495, 6.615, 7.155, 7.155, 7.155, 7.17,7.295, 7.4, 7.4,  7.4, 7.14,7.14,7.08,7.08,7.08,7.08,6.965, 6.965, 6.965]
assert 4, eqObj(tick4, rs4, precision)

tick5=exec midPrice(high, low,  timePeriod) from tickTB where sym=`tick5
rs5 = [, , , , , , , , , 9.975,9.975,9.93, 9.93, 9.9,9.51, 9.375,9.31, 9.31, 9.31, 9., 8.98, 8.98, 8.815,8.505, 8.505,8.505,8.505,8.36, 8.365,8.46, 8.46, 8.46, 8.615,8.715,8.715,8.715, 8.715,8.77, 8.77, 8.855,8.855,8.97, 8.97, 8.97, 8.97, 9.06, 9.085,9.05, 8.865,8.58, 8.42, 8.335, 8.335, 8.335, 8.335, 8.035, 8.035, 7.635, 7.595, 7.52, 7.4,7.4,7.4,7.4,7.4,7.225,7.225,7.225,7.135,7.12, 7.05, 6.705, 6.675,6.25, 6.25, 6.25, 6.08, 6.08, 6.08, 5.795,5.84, 5.9, 5.9, 5.945, 6.195,6.195,6.44, 6.785,6.88, 6.9,6.9,7.085,7.16, 7.16, 7.16, 7.455, 7.65, 7.65, 7.625,7.615]
assert 5, eqObj(tick5, rs5, precision)

midpriceBySym = (exec midPrice(high, low,  timePeriod) from tickTB context by sym).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(midpriceBySym, rs, precision)

@testing:case="test_ta_function_midprice_use_ticks_take40"
timePeriod=10
low = 1..40
tick1 = midPrice(low + 10, low,  timePeriod)
rs1 = [ , , , , , , , , , 10.5, 11.5, 12.5, 13.5, 14.5, 15.5, 16.5, 17.5, 18.5, 19.5, 20.5, 21.5, 22.5, 23.5, 24.5, 25.5, 26.5, 27.5, 28.5, 29.5, 30.5, 31.5, 32.5, 33.5, 34.5, 35.5, 36.5, 37.5, 38.5, 39.5, 40.5]
assert 1, eqObj(tick1, rs1, precision)

@testing:case="test_ta_function_midprice_use_ticks_rand40"
timePeriod=10
low = [0.88004015, 0.36995343, 0.62203677, 0.88048967, 0.42871947, 0.25172133, 0.73376668, 0.50154779, 0.7667593, 0.91706729, 0.02341192, 0.12936362, 0.97538709, 0.30105016, 0.14285162, 0.00943651, 0.90928448, 0.37642867, 0.47983819, 0.35337849, 0.08833076, 0.49402081, 0.80629061, 0.25490584, 0.8499114, 0.28358796, 0.20181581, 0.41250942, 0.30640445, 0.82749753, 0.48304785, 0.29693986, 0.67527946, 0.51149582, 0.63056224, 0.82044577, 0.905032, 0.98154483, 0.48088229, 0.41311918]
high = [0.87776211, 0.37167316, 0.78568169, 0.1539018, 0.43714404, 0.40090293, 0.72582794, 0.98324757, 0.57643371, 0.74356021, 0.80087801, 0.43954904, 0.96854206, 0.53725794, 0.64532748, 0.6994231, 0.78612786, 0.83802794, 0.63784228, 0.95021451, 0.02634541, 0.91565565, 0.39922115, 0.76828626, 0.85735651, 0.1702559, 0.52046926, 0.59191125, 0.88163829, 0.040917, 0.01595415, 0.86566266, 0.5026841, 0.81181571, 0.21574022, 0.66298429, 0.85733125, 0.33876079, 0.82175022, 0.71907686]
tick1=midPrice(high, low, timePeriod)
rs1 = [ , , , , , , , , , 0.53548455, 0.53548455, 0.53548455, 0.56464444, 0.68814501, 0.68814501, 0.70746806, 0.70746806, 0.70746806, 0.70746806, 0.70746806, 0.50086625, 0.50086625, 0.46781494, 0.46781494, 0.46781494, 0.46781494, 0.4381284, 0.4381284, 0.4381284, 0.4381284, 0.43293278, 0.43293278, 0.43293278, 0.43293278, 0.42172584, 0.42172584, 0.46049307, 0.49874949, 0.49874949, 0.49874949]
assert 1, eqObj(tick1, rs1, precision)

@testing:case="test_ta_function_midprice_use_ticks_bigarray"
timePeriod=10
low = bigarray(DOUBLE,0,2000000).append!(1..2000000)
high = low + 15
tick1 = midPrice(high, low,  timePeriod)
rs1 = array(DOUBLE, 9, size(low), NULL).append!(13..2000003)
assert 1, eqObj(tick1, rs1, precision)
