
#include "setup/settings.txt"

use ta

//linearreg_angle(close, timeperiod=14)

@testing:case="test_ta_function_linearreg_angle"
x=[89.79,11.58,99.9,81.11,84.69,31.38,60.9,83.3,97.26,98.67]

validate=[ , , , ,  80.43278646,  67.70616973, -85.52343645, -62.74255095,  82.60610299,  86.6520093 ]
assert 1,eqObj(ta::linearreg_angle(x,5),validate,6)

validate=[ , , , , , -69.06955394,  51.88930551, -79.92266091,  71.74344108,  83.11686593]
assert 2,eqObj(ta::linearreg_angle(x,6),validate,6)

validate=[ , , , , , , -65.79214905,  72.24201345, -44.30622996,  77.82142609]
assert 3,eqObj(ta::linearreg_angle(x,7),validate,6)

close=[5.18,71.01,76.28,5.92,52.97,16.45,92.88,7.37,79.39,15.82]
t=table(take(`A`B,10) as sym,close)
re=exec ta::linearreg_angle(close,5) from t
validate=[ , , , ,  71.84173112, -85.68169974,  77.11930639,  76.85201653,  77.12784261, -55.86405992]
assert 4,eqObj(re,validate,6)

@testing:case="test_ta_function_linearreg_angle_context_by"
tick = loadText(DATA_DIR + "/ticks1.csv")
res = select sym, ta::linearreg_angle(close, 10) as linearreg_angle from tick context by sym 
tick1 = exec linearreg_angle from res where sym = `tick1
validate1 = take(double(), 8)
assert 1, eqObj(tick1, validate1, 6)
tick2 = exec linearreg_angle from res where sym = `tick2
validate2 = [ , , , , ,
  , , , , ,
  , , , , ,
 -14.88602052,   0.54863373,  15.91879193,  32.4316296,   41.46108458,
  37.80929545,  32.35983365,  18.26602134,  -6.12629297, -12.510055,
  -9.03270917,  -3.67576859,  -0.55905017,   4.73260358,   8.55793216,
   9.12413167,   7.25319461,   2.60949279,  -8.92090759, -17.57441472,
 -21.63657743, -25.05965081, -26.90019948, -24.48710805, -16.56534902,
  -7.59123152,  -4.02145027,  -3.40248921,  -8.11600362,  -9.19182187,
 -11.23979813, -15.36495148, -17.69110699, -16.97282451, -12.24170547,
  -7.24977747,  -0.12848123,   2.96284687,   2.78273206,   5.83433747,
   9.26286873,   9.87738356,  10.06601095,  10.30148508,  10.91540415,
  12.57622885,  15.30035792,  15.00271602,  13.54825532,  13.95123859,
  14.68474886,  13.18341,     10.40565468,   7.24636027,   3.56855165,
   2.39114369,   1.45812316,   0.78125766,   0.67710042,   1.03468401,
   2.67186459,   4.06982289,   4.86708172,   4.70156269,   0.49655099,
  -6.67497924, -11.86310488, -14.34955943, -16.57172922, -17.66904166,
 -17.3943508,  -14.47333967, -11.4534336,   -7.01387046,  -8.16024114,
 -10.95892124, -12.12558229, -10.32837418,  -8.20787059,  -6.09539488,
  -3.08058278,  -0.13889859,   2.20739908,   4.5290634,    3.88321137]
assert 2, eqObj(tick2, validate2, 6)
tick3 = exec linearreg_angle from res where sym = `tick3
validate3 = take(double(), 5)
assert 3, eqObj(tick3, validate3, 6)
tick4 = exec linearreg_angle from res where sym = `tick4
validate4 = [ , , , , , , , , , -5.59050167e-01, -6.49324368e-01, -4.02800056e-01,
 -3.40298204e-01, -2.00973635e+00, -8.72763480e+00, -1.03922173e+01,
 -1.27282991e+01, -1.76217406e+01, -1.83661664e+01, -1.44538046e+01,
 -1.17699529e+01, -1.10860515e+01, -5.79309537e+00, -1.78080422e+00,
  3.47247148e-03,  4.70846090e+00,  7.91851824e+00,  8.13642215e+00,
  8.10579358e+00,  1.11529179e+01,  1.06003655e+01,  5.90649653e+00,
  2.02707717e+00, -6.56268410e-01, -1.14923392e+00, -1.91262104e+00,
 -3.10135703e+00, -1.85018393e+00, -2.32654311e-01,  3.15675102e+00,
  6.63044298e+00,  7.02755283e+00,  4.17691292e+00,  2.14498473e+00,
  1.84040356e-01, -4.28052061e+00, -8.02409463e+00, -1.26423686e+01,
 -1.79428961e+01, -1.83348835e+01, -1.48373600e+01, -1.16967178e+01,
 -9.65816982e+00, -6.29445271e+00,  5.10439804e-01,  2.13111417e+00,
  5.03941078e+00,  4.21835932e+00, -1.98545858e+00, -8.52397337e+00,
 -1.21985859e+01, -1.35154318e+01, -1.38890800e+01, -1.55359307e+01,
 -1.23776057e+01, -1.05131117e+01, -9.16136447e+00, -6.08166125e+00,
 -5.00839820e+00, -6.68525569e+00, -1.00121397e+01, -1.11094582e+01,
 -1.06305571e+01, -1.01636067e+01, -6.60988507e+00, -2.06869361e+00,
 -3.05574593e-01,  2.65107469e+00,  5.86870126e+00,  8.61564818e+00,
  8.58509483e+00,  6.76745167e+00,  5.79996948e+00,  5.89962505e+00,
  6.64757327e+00,  5.79996948e+00,  4.62222344e+00,  3.03556913e+00,
  1.35054123e+00,  3.22936428e-01, -2.78966060e+00, -6.27729849e+00,
 -7.48885112e+00, -6.72635715e+00, -5.66589448e+00, -3.04249455e+00,
  1.38898857e-02,  1.82590164e+00,  2.06869361e+00,  2.62681892e+00]
assert 4, eqObj(tick4, validate4, 6)
tick5 = exec linearreg_angle from res where sym = `tick5
validate5 = [ , , , , , , , , , -3.43017033e+00, -3.73109632e+00, -3.28828791e+00,
 -1.80855674e+00, -1.30542335e+00, -5.51455569e+00, -6.73663143e+00,
 -7.66627954e+00, -8.26229025e+00, -1.11194885e+01, -1.12498194e+01,
 -1.10191545e+01, -1.01501487e+01, -8.46622959e+00, -5.25297160e+00,
 -4.63947262e+00, -2.42580708e+00,  4.58356458e-01,  3.36788557e+00,
  4.00417294e+00,  5.07386573e+00,  5.27707422e+00,  5.71746924e+00,
  4.02490565e+00,  2.24553862e+00,  7.67370312e-01,  6.94494294e-03,
 -1.63205718e-01, -7.25707730e-01,  4.82662119e-01,  1.93343241e+00,
  2.48473076e+00,  4.17691292e+00,  5.64870085e+00,  4.24253435e+00,
  3.92814406e+00,  2.54364917e+00, -9.37566464e-02, -2.82430203e+00,
 -6.78457232e+00, -1.16634163e+01, -1.38334361e+01, -1.34103357e+01,
 -1.23245882e+01, -1.16267753e+01, -7.51957033e+00, -3.86592829e+00,
 -2.26634116e+00,  5.06967606e-01, -1.84040356e-01, -4.08364258e+00,
 -6.58589868e+00, -6.75375427e+00, -4.98427527e+00, -3.34020089e+00,
 -2.64760964e+00, -1.04856931e+00, -1.25008775e-01, -1.04174030e-01,
 -2.95157465e-01, -2.21086639e+00, -5.98207157e+00, -9.97172455e+00,
 -1.13900440e+01, -1.19096570e+01, -1.27117785e+01, -1.03216523e+01,
 -6.54134638e+00, -4.27016109e+00, -5.72938698e-01,  3.37480650e+00,
  5.88931750e+00,  6.81196283e+00,  6.26700542e+00,  4.50835790e+00,
  2.28367616e+00,  1.88140305e+00,  3.18098405e+00,  5.66589448e+00,
  6.69210641e+00,  6.58589868e+00,  8.81921030e+00,  1.17100362e+01,
  1.21322206e+01,  9.94477554e+00,  6.37334748e+00,  1.32624719e+00,
 -1.71141928e+00, -2.19006228e+00, -4.01108396e+00, -6.36991777e+00]
assert 5, eqObj(tick5, validate5, 6)
