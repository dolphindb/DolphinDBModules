
#include "setup/settings.txt"

use ta

//stddev(close, timePeriod, nbdev)

@testing:case="test_ta_function_stddev"
x=[89.79,11.58,99.9,81.11,84.69,31.38,60.9,83.3,97.26,98.67]

//nbdev=1
validate=[ , , , , 31.55788878, 34.04655601, 23.64240478, 20.37435506, 23.23259744, 25.39190769]
assert 1,eqObj(ta::stddev(x,5,1),validate,6)

validate=[ , , , , , 32.79197738, 31.08165786, 22.01881594, 21.50826172, 23.50060401]
assert 2,eqObj(ta::stddev(x,6,1),validate,6)

validate=[ , , , , , , 30.42059896, 29.76163583, 22.0096082,  21.82973426]
assert 3,eqObj(ta::stddev(x,7,1),validate,6)

//nbdev!=1
validate=[ , , , , 0.0,  0.0,  0.0,  0.0,  0.0,  0.0]
assert 4,eqObj(ta::stddev(x,5,0),validate,6)

validate=[ , , , , , -32.79197738, -31.08165786, -22.01881594, -21.50826172, -23.50060401]
assert 5,eqObj(ta::stddev(x,6,-1),validate,6)

validate=[ , , , , , ,182.52359373, 178.56981499, 132.05764919, 130.97840557]
assert 6,eqObj(ta::stddev(x,7,6),validate,6)

validate=[ , , , , 18.93473327, 20.4279336, 14.18544287, 12.22461303, 13.93955847, 15.23514461]
assert 6,eqObj(ta::stddev(x,5,0.6),validate,6)

close=[5.18,71.01,76.28,5.92,52.97,16.45,92.88,7.37,79.39,15.82]
t=table(take(`A`B,10) as sym,close)
re=exec ta::stddev(close,5,1) from t
validate=[ , , , , 30.96497466, 28.49457815, 33.46864981, 33.54433329, 33.62745926, 36.12059988]
assert 7,eqObj(re,validate,6)

re=exec ta::stddev(close,6,2) from t
validate=[ , , , , , 59.72043025, 63.28838414, 68.49835367, 69.56748826, 66.41741806]
assert 8,eqObj(re,validate,6)


@testing:case="test_ta_function_stddev_context_by"
tick = loadText(DATA_DIR + "/ticks1.csv")
res = select sym, ta::stddev(close, 10, 1) as stddev from tick context by sym 
tick1 = exec stddev from res where sym = `tick1
validate1 = take(double(), 8)
assert 1, eqObj(tick1, validate1, 6)
tick2 = exec stddev from res where sym = `tick2
validate2 = [ , , , , , ,
  , , , , , ,
  , , , 2.83198234, 3.00632334, 3.06029999,
 3.05841135, 3.0355698,  2.88783812, 2.62817979, 2.02417391, 0.76328304,
 0.76821937, 0.76551225, 0.68922855, 0.67272654, 0.64609597, 0.7670339,
 0.7775217,  0.82887876, 0.87013562, 1.00221954, 1.14003333, 1.30964155,
 1.45521167, 1.52778303, 1.4406974,  1.09171242, 0.69236479, 0.57152078,
 0.52703795, 0.7843985,  0.82362856, 0.87698632, 0.98801822, 1.03873433,
 1.01720401, 0.87567117, 0.62854515, 0.32617327, 0.29909865, 0.29277295,
 0.38647639, 0.51667108, 0.54679155, 0.55441952, 0.56542108, 0.58467427,
 0.70216878, 0.84387203, 0.83112935, 0.7634422,  0.78245831, 0.81333634,
 0.75934248, 0.64584518, 0.52127152, 0.25989421, 0.23946816, 0.24556873,
 0.21281212, 0.20651634, 0.20874865, 0.22190088, 0.2827437,  0.3089029,
 0.30404769, 0.4829793,  0.7572351,  0.85707643, 0.92282447, 1.00536759,
 1.03621233, 1.02689289, 0.90839914, 0.74557696, 0.41373421, 0.49098269,
 0.58991949, 0.64653306, 0.58170525, 0.55353771, 0.4882868,  0.42513527,
 0.32575451, 0.30429591, 0.29873232, 0.28495614]
assert 2, eqObj(tick2, validate2, 6)
tick3 = exec stddev from res where sym = `tick3
validate3 = take(double(),5)
assert 3, eqObj(tick3, validate3, 6)
tick4 = exec stddev from res where sym = `tick4
validate4 = [ , , , , , , , , , 0.33883477, 0.33637033, 0.32879173,
 0.32753015, 0.43201968, 0.74953919, 0.78770299, 0.83647415, 1.00426341,
 1.03483139, 0.9228223,  0.79418889, 0.76002697, 0.55210144, 0.50024894,
 0.55109437, 0.56568631, 0.57389982, 0.5817637,  0.58067202, 0.63061954,
 0.60919291, 0.3597791,  0.27687542, 0.24265407, 0.24382166, 0.25181144,
 0.24420483, 0.26203244, 0.27925078, 0.34071102, 0.39547946, 0.40014497,
 0.37556491, 0.34713686, 0.34468681, 0.4280292,  0.49537461, 0.72043112,
 0.99264747, 1.00907086, 0.89438303, 0.80503168, 0.75675888, 0.64695904,
 0.56062911, 0.52314052, 0.46618559, 0.46208333, 0.4108479,  0.61936177,
 0.77896406, 0.81916055, 0.82843225, 0.88265565, 0.72658172, 0.66931607,
 0.59341807, 0.41089658, 0.34664679, 0.41341988, 0.55052793, 0.60079947,
 0.57737423, 0.5648398,  0.51240609, 0.40316746, 0.39295801, 0.36133087,
 0.39579793, 0.47008084, 0.46890191, 0.40747515, 0.34853981, 0.3551746,
 0.37893139, 0.36056067, 0.31499841, 0.25274691, 0.23272516, 0.239,
 0.3317288,  0.37059547, 0.40701474, 0.37656341, 0.34262078, 0.36203453,
 0.35091309, 0.31814462, 0.31304313, 0.30390953]
assert 4, eqObj(tick4, validate4, 6)
tick5 = exec stddev from res where sym = `tick5
validate5 = [ , , , , , , , , , 0.24261286, 0.2512449,  0.23655021,
 0.22451058, 0.18756332, 0.44389301, 0.48892637, 0.51757222, 0.53108945,
 0.65077262, 0.65617376, 0.6483988,  0.61498293, 0.50566392, 0.39635969,
 0.39546049, 0.36341299, 0.33608927, 0.27422801, 0.29678443, 0.32851332,
 0.33181923, 0.3476435,  0.22284748, 0.21342212, 0.20939198, 0.19920843,
 0.19785095, 0.18428511, 0.21722109, 0.24609145, 0.2638636,  0.29284979,
 0.29933927, 0.25837183, 0.24068444, 0.20280286, 0.20651634, 0.24326118,
 0.46539123, 0.71984443, 0.79653311, 0.78437491, 0.75640267, 0.73671229,
 0.59302277, 0.46319434, 0.38712918, 0.25372426, 0.27444672, 0.3109598,
 0.37361611, 0.37876114, 0.34682128, 0.34267915, 0.31277628, 0.25332982,
 0.25227762, 0.25134836, 0.25471749, 0.27753378, 0.40274185, 0.57325823,
 0.63521335, 0.66167666, 0.68574339, 0.63413642, 0.51716148, 0.46615019,
 0.36175821, 0.29214551, 0.33731291, 0.37543175, 0.36096537, 0.27684111,
 0.18319389, 0.17805617, 0.25065714, 0.42363782, 0.46694753, 0.46425101,
 0.55013089, 0.65830388, 0.67459692, 0.62424434, 0.51757222, 0.37907255,
 0.3439782,  0.35112533, 0.3771273,  0.37255872]
assert 5, eqObj(tick5, validate5, 6)
