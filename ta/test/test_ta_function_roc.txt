#include "setup/settings.txt"
use ta

//roc(close, timePeriod)
@testing:case="test_ta_function_roc_take40"
close=(1..40)
talib=take(double(),10).append!([1000.  ,  500.  ,
        333.33333333,  250.  ,  200.  ,  166.66666667,
        142.85714286,  125.  ,  111.11111111,  100.   ,
         90.90909091,   83.33333333,   76.92307692,   71.42857143,
         66.66666667,   62.5  ,   58.82352941,   55.55555556,
         52.63157895,   50.   ,   47.61904762,   45.45454545,
         43.47826087,   41.66666667,   40.  ,   38.46153846,
         37.03703704,   35.71428571,   34.48275862,   33.33333333])
assert 1, eqObj(roc(close,10),talib,5)
talib=take(double(),5).append!([ 500.        , 250.        , 166.66666667,
       125.        , 100.        ,  83.33333333,  71.42857143,
        62.5       ,  55.55555556,  50.        ,  45.45454545,
        41.66666667,  38.46153846,  35.71428571,  33.33333333,
        31.25      ,  29.41176471,  27.77777778,  26.31578947,
        25.        ,  23.80952381,  22.72727273,  21.73913043,
        20.83333333,  20.        ,  19.23076923,  18.51851852,
        17.85714286,  17.24137931,  16.66666667,  16.12903226,
        15.625     ,  15.15151515,  14.70588235,  14.28571429])
assert 2, eqObj(roc(close,5),talib,5)
talib=take(double(),40)
assert 3, eqObj(roc(close,40),talib)

@testing:case="test_ta_function_roc_rand40"
close =[56.84486603, 63.63574239, 17.24385137, 14.96223024, 79.31584397,
       55.19487319, 76.11299983,  8.6658699 , 23.08781124, 35.93374603,
       76.92630291, 32.72657806, 42.13828084, 55.27681132, 95.80582219,
       58.47228524, 13.48667322, 85.25350829, 11.76174822, 27.89005755,
        7.8807707 , 14.4892506 , 54.22748916, 21.95583062, 67.02994747,
        9.96686312, 55.93319639, 71.14257436,  5.82524944, 71.46937892,
       56.47772433, 95.07794425, 79.77511056, 94.64802509, 68.46983317,
        5.71675094, 11.19925125, 97.10198567, 73.83804116,  4.85530577]
talib=take(double(),10).append!([  35.32673798,  -48.57201813,
        144.36699166,  269.44232533,   20.79027013,    5.93789216,
        -82.28072307,  883.7847703 ,  -49.05646058,  -22.38477579,
        -89.75542773,  -55.72635008,   28.68937242,  -60.28021498,
        -30.03562212,  -82.95455175,  314.7293812 ,  -16.55173401,
        -50.47292859,  156.25396718,  616.65229811,  556.19642364,
         47.1119386 ,  331.08378238,    2.14812297,  -42.64242549,
        -79.97745172,   36.4892774 , 1167.55157733,  -93.20645311])
assert 1, eqObj(roc(close,10),talib,5)
talib=take(double(),20).append!([-86.13635452, -77.23095535, 214.47434797,  46.74169738,
       -15.48983896, -81.94241142, -26.51295243, 720.95133184,
       -74.76915685,  98.89209118, -26.58203736, 190.52210737,
        89.31743054,  71.2255516 , -28.53270124, -90.22314432,
       -16.96060943,  13.89793525, 527.78117486, -82.59126658])
assert 2, eqObj(roc(close,20),talib,5)

@testing:case="test_ta_function_roc_null"
close =[56.84486603, 63.63574239, 17.24385137, 14.96223024, 79.31584397,
       55.19487319, 76.11299983,  8.6658699 , 23.08781124, 35.93374603,
       76.92630291, 32.72657806, , 55.27681132, 95.80582219,, 
       13.48667322, 85.25350829, 11.76174822, 27.89005755,
        7.8807707 , 14.4892506 , , 21.95583062, 67.02994747,
        9.96686312, 55.93319639, 71.14257436,  5.82524944, 71.46937892,
       56.47772433, 95.07794425,, 94.64802509, 68.46983317,
        5.71675094, 11.19925125, 97.10198567, 73.83804116,  4.85530577]
talib=take(double(),10).append!([35.32673798,  -48.57201813,,  
        269.44232533,   20.79027013, ,-82.28072307,  883.7847703 ,
        -49.05646058,  -22.38477579,-89.75542773,  -55.72635008, ,
        -60.28021498, -30.03562212, ,  314.7293812 ,  -16.55173401,
        -50.47292859,  156.25396718,  616.65229811,  556.19642364, ,  
        331.08378238,    2.14812297,  -42.64242549, -79.97745172,
        36.4892774 , 1167.55157733,  -93.20645311])
assert 1, eqObj(roc(close,10),talib,5)
talib=take(double(),20).append!([ -86.13635452, -77.23095535,,  46.74169738,
       -15.48983896, -81.94241142, -26.51295243, 720.95133184,
       -74.76915685,  98.89209118, -26.58203736, 190.52210737,, 
       71.2255516 , -28.53270124, ,-16.96060943,  13.89793525, 
       527.78117486, -82.59126658 ])
assert 2, eqObj(roc(close,20),talib,5)

@testing:case="test_ta_function_roc_csv"
timePeriod=10
tickTB=loadText(DATA_DIR+"/ticks1.csv")
tick1=exec roc(close, timePeriod) from tickTB where sym=`tick1
rs1=take(double(), 8)
assert 1, eqObj(tick1, rs1, 5)

tick2=exec roc(close, timePeriod) from tickTB where sym=`tick2
rs2=[, , , , , , , , , , , , , , , , 15.54476058,   4.6997389 ,  -0.12239902,  -2.17391304,
        47.86407767,  61.12224449,  59.17721519,  52.53505933,
        -0.2734108 ,  -0.24860162,  -4.26426426,  -1.55860349,
        -1.40931373,  10.        ,   6.36900854,  -9.32835821,
        -3.44599072,  -5.23338048,  -7.67649075, -19.62616822,
       -21.58092848, -20.89930336, -18.769422  , -20.1426025 ,
       -16.2345679 , -10.08230453, -18.73713109, -18.35820896,
       -14.7735709 , -11.5503876 , -13.2       , -11.28903122,
       -14.91966335, -13.69047619, -18.49668386, -10.67887109,
        -1.60472973,   6.58135283,   6.271777  ,  10.25416301,
        16.22119816,  13.53790614,  15.82733813,  10.43103448,
        27.3960217 ,  22.45943638,  19.91416309,  20.75471698,
        19.59016393,  17.40858506,  14.67089611,  15.18282989,
        12.11180124,  14.91022639,   2.12916962,  -0.76708508,
         5.51181102,   6.25      ,   0.61686086,   0.81245768,
         5.25587828,   4.62387854,   4.29362881,  -7.88043478,
       -11.39680334,  -7.37877723, -10.5156038 , -15.44117647,
       -12.39782016, -14.84217596, -16.55716163, -19.39313984,
       -19.45551129, -15.33923304, -10.11764706, -15.17450683,
       -11.22062168,  -4.03162055,  -8.55365474,  -5.20504732,
        -6.92913386,  -1.63666121,  -0.41220115,   3.7456446 ]
assert 2, eqObj(tick2, rs2, 5)

tick3=exec roc(close, timePeriod) from tickTB where sym=`tick3
rs3=take(double(), 5)
assert 3, eqObj(tick3, rs3,5)

tick4=exec roc(close, timePeriod) from tickTB where sym=`tick4
rs4=[  ,   ,    ,    ,  ,  ,  ,  , ,  ,   5.62390158,  -5.8677686 ,
        -3.86879731, -13.60263809, -16.91629956, -10.29411765,
        -9.99115827, -18.21428571, -22.10084034, -14.92910759,
       -22.54575707, -22.73924495, -15.31058618,  -4.48473282,
        11.02863203,   1.15718419,   0.98231827,  15.50218341,
        15.21035599,   6.56862745,  17.29323308,  19.88636364,
         4.8553719 ,   2.2977023 ,  -0.38204394,  -1.71591992,
         1.07003891,   2.36294896,   1.87265918,   3.58785649,
         3.66300366,   3.03317536,   2.26600985,   3.41796875,
         0.28763183,  -4.84966052,  -5.48604427, -18.37488458,
       -26.10294118, -23.35701599, -17.5795053 , -14.6274149 ,
       -11.9460501 , -14.73087819,  -5.06692161,  -8.86850153,
        -6.82281059,   1.80995475,   3.10945274, -13.09385863,
       -21.86495177, -17.34913793, -14.66083151, -20.26578073,
       -26.18328298, -15.99552573, -26.12021858, -22.55555556,
       -18.81785283, -13.86666667, -18.51851852, -23.07692308,
       -24.74358974, -14.30555556,  -7.36698499, -10.11984021,
        -2.36686391,  -4.01721664,   4.16047548,  12.38390093,
        20.70707071,  17.11864407,  26.9165247 ,  26.09400324,
        11.7820324 ,   8.14814815,  13.63636364,  11.50971599,
         2.85306705,  -1.37741047,  -8.22873082,  -3.90738061,
       -10.73825503, -13.75321337, -10.40843215,   2.46575342,
        -1.2       ,  -5.63002681,  -6.38002774,  -4.88826816 ]
assert 4, eqObj(tick4, rs4, 5)

tick5=exec roc(close, timePeriod) from tickTB where sym=`tick5
rs5=[ ,  ,  ,  , ,  ,  ,  , ,  ,  -4.79452055,  -5.43161979,
        -1.27326151, -10.0286533 , -13.55759429, -11.75298805,
       -10.6962664 ,  -8.31622177, -17.19876416, -18.08191808,
       -15.10791367, -16.71794872, -24.4047619 , -11.14649682,
        -0.47169811,  -4.28893905,  -2.59887006,  -5.03919373,
         8.70646766,   7.80487805,   4.47941889,  10.34482759,
        19.02887139,   0.9557945 ,   0.47393365,   2.24056604,
         1.27610209,   3.77358491,   4.34782609,   3.6199095 ,
         6.60486674,   3.68303571,   0.99228225,   6.62721893,
        11.43867925,   4.84429066,  -0.22909507,  -2.38636364,
       -15.02192982, -22.81659389, -19.23913043, -16.03875135,
       -14.30131004, -15.53829079, -16.61375661, -14.19141914,
       -16.07347876, -12.45634459,  -7.09677419,  -2.6874116 ,
        -7.94078062, -10.12820513,  -5.73248408,  -0.78843627,
       -12.43654822,  -9.35897436,  -0.27359781, -10.37234043,
        -4.30555556,  -3.19767442, -11.40350877, -20.25677603,
       -23.91891892, -29.13907285, -19.42028986, -13.43705799,
       -16.59807956, -11.27596439, -11.75616836,  -6.00600601,
         6.43564356,  18.06797853,  11.90053286,  19.62616822,
        12.05035971,   2.61437908,  13.65131579,  27.090301  ,
        21.21710526,  12.93929712,  20.62015504,  23.03030303,
        27.14285714,  15.625     ,  18.61958266,  13.53503185,
         4.19681621,  -4.73684211,  -4.88466757,   0.70721358 ]
assert 5, eqObj(tick5, rs5, 5)


rocBySym=(exec roc(close, timePeriod) from tickTB context by sym).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(rocBySym, rs, 5)
