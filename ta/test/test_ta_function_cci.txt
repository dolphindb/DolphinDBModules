#include "setup/settings.txt"
use ta
//cci(high, low, close, timePeriod)
// the avg of dolphindb is different from talib. tablib wiil regard the nan as zero, dolphindb will ignore it

precision=5
@testing:case="test_ta_function_cci_5"
high = [4.87661076, 5.09258627, 4.69128548, 4.51989263, 0.85037274]
low = [9.50391399, 8.50713385, 2.00315372, 1.04252965, 7.00412279]
close =[3.67652627, 7.14380803, 3.64008183, 5.90980276, 5.6898537 ]
assert 1, eqObj(cci(high, low, close, 4), [,,,-57.74025983, -9.51023297],precision)

@testing:case="test_ta_function_cci_context_by_NULL"
nan=double()
tick = loadText(DATA_DIR + "/ticks1.csv")
res = select sym, cci(high, low, close, 10) result from tick context by sym

tick1 = exec result from res where sym = `tick1
validate1=[nan, nan, nan, nan, nan, nan, nan, nan]
assert eqObj(tick1, validate1, 3)

tick2 = exec result from res where sym = `tick2
validate2=[          nan,           nan,           nan,           nan,
                 nan,           nan,           nan,           nan,
                 nan,           nan,           nan,           nan,
                 nan,           nan,           nan,   61.17583827,
         78.06709577,   67.13951355,   72.80353826,   48.52370588,
         37.15064758,   41.59316054,   17.76613564, -124.34754678,
       -143.91231832,  -16.47355561,   75.50043516,   76.701427  ,
         51.81659006,  156.32898281,   92.71498025,  -47.5786497 ,
       -100.4428157 , -132.16080402, -125.03849707, -115.25      ,
       -120.62200524, -104.13159371,  -67.72475269,  -35.49720399,
         22.34023721,   -7.37376697, -115.42131883, -189.54248366,
       -132.77144274,  -78.34220287, -113.7406997 ,  -71.05915693,
        -62.38162879,  -37.24880182,  -40.282864  ,   41.81320828,
        136.44049884,   86.19702176,  157.58233804,  152.52260134,
        152.75662504,  104.47827635,   94.50929529,   83.75976299,
        167.41721854,  191.98412698,  115.52028219,   96.27816482,
         99.04248953,   99.3830554 ,   64.22410955,   71.55905012,
         59.6192658 ,   64.76037769,   77.51937984,  -93.50618173,
         52.63157895,  177.74261603,  108.80658436,   53.59477124,
        177.09885743,  130.23625174,   84.62962963, -148.35249042,
       -214.30841164, -147.61904762,  -98.38521725,  -95.88014981,
        -78.24660103,  -69.74228743,  -53.45991207, -108.24742268,
       -131.77838756, -179.64964592, -143.90706496, -132.51332513,
        -72.5745801 ,   -8.98148148,  -24.57805907,   11.90019194,
         13.66263794,   40.71246819,  101.93679918,   42.76146316]
assert 2, eqObj(tick2, validate2, 3)

tick3 = exec result from res where sym = `tick3
validate3=[nan, nan, nan, nan, nan]
assert 3, eqObj(tick3, validate3, 3)

tick4 = exec result from res where sym = `tick4
validate4=[          nan,           nan,           nan,           nan,
                 nan,           nan,           nan,           nan,
                 nan,   86.521181  ,   80.52181736,  -54.11764706,
        -68.73315364, -173.50381815, -248.89374772, -120.54062549,
        -79.01510533, -120.91801466, -112.22805701,  -40.46767694,
        -64.36371273, -124.42188381,  -38.34161551,   42.91548853,
        121.08634384,   94.98181818,   79.73856209,   92.710057  ,
         82.77858177,  107.56056809,   78.2122905 ,   65.1459104 ,
        -37.38124742, -118.90838207,  -55.23156089,  -73.59307359,
        -64.47368421,   42.90834613,   71.45488029,  136.04193971,
        108.60344138,   77.2978959 ,  -35.53530752,  -50.69958848,
        -25.6684492 , -166.35658915, -153.76555337, -173.85257302,
       -174.35701066, -126.00826564,  -65.4152446 ,  -26.30493416,
        -14.74344938,  -22.47345926,  112.47642145,   21.46464646,
        -34.87578488,  -34.29519071, -116.66666667, -203.90467987,
       -176.76534073, -108.4605598 ,  -69.11764706,  -78.69326395,
        -81.96007503,  -48.28285388, -108.01804573, -135.14968046,
       -117.33333333, -131.19369369, -156.4143854 , -127.55751346,
       -133.1496786 ,  -76.76072494,   24.07859906,   58.67227676,
         39.67953571,   49.79117724,   90.51834745,  117.54445195,
         99.52331124,   69.90778411,   98.36477987,  187.38965952,
        109.22654103,   43.16967268,   61.53846154,   68.58666667,
        -16.60280971,  -63.85696041, -169.54866775, -193.30702187,
       -111.54345006,  -71.06918239,  -49.1503268 ,   44.08602151,
         74.52602551,   44.02810304,  -28.92131318,  -37.86104606]
assert 4, eqObj(tick4, validate4, 3)

tick5 = exec result from res where sym = `tick5
validate5=[          nan,           nan,           nan,           nan,
                 nan,           nan,           nan,           nan,
                 nan,  -20.36718302,  -73.46938776, -109.42158617,
         26.27175368,  -75.37091988, -318.47666876, -177.02782712,
        -90.70428054,  -61.63893362, -107.94392523, -108.90020052,
        -85.04349295,  -75.33035548, -132.95910184,  -46.41812865,
          3.78787879,   32.28107722,   86.94779116,   68.20809249,
        118.45906902,  128.25024438,   89.31860037,   93.83044829,
        147.60383387,    3.47222222,  -92.9059068 ,  -53.97277619,
          7.44416873,   34.58937198,  112.56281407,  136.24338624,
         86.82008368,  133.33333333,   75.15151515,   12.09372638,
         89.54248366,   79.94891443, -133.33333333, -156.24267978,
       -212.57378565, -197.98358315, -129.8963334 ,  -83.09690436,
        -41.55717762,  -45.46387521,  -42.71111677,   -6.38569604,
        -77.08026811,  -84.44444444,  -90.47619048, -163.72269706,
       -147.09480122,  -86.4604811 ,  -28.46003899,   57.75535939,
        -35.51228558,  -65.55370061,   31.40906269,  -88.        ,
        -87.45155039,  -96.90698709, -191.66666667, -201.15565186,
       -140.98300074, -133.82386756,  -91.16531165,  -22.17017955,
          5.31400966,   -3.6321031 ,   18.70022753,   80.62130178,
        115.85559796,  122.0508167 ,   95.08448541,   39.03177005,
         10.54194506,  -25.35684299,  192.95184927,  238.38782825,
        150.55781462,   56.08402695,   94.24669801,  132.27990971,
        112.51292658,   26.32616064,    0.73513968,  -71.5234721 ,
        -93.90698428,  -47.06790123,  -94.64508095,  -88.61622359]
assert 5, eqObj(tick5, validate5, 3)
