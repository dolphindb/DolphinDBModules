#include "setup/settings.txt"
use ta

precision=5
nan=double()
@testing:case="test_ta_function_willr_use_ticks1_contextby"
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec ta::willr(high,low,close,14) from tickTB where sym=`tick1
rs1=[nan, nan, nan, nan, nan, nan, nan, nan]
assert 1, eqObj(tick1, rs1, precision)

tick2=exec ta::willr(high,low,close,14) from tickTB where sym=`tick2
rs2=[          nan,           nan,           nan,           nan,
                 nan,           nan,           nan,           nan,
                 nan,           nan,           nan,           nan,
                 nan,           nan,           nan,           nan,
                 nan,           nan,           nan,  -25.8254717 ,
        -26.6509434 ,  -16.62735849,  -28.30188679,  -39.50471698,
        -34.19811321,  -16.98113208,  -18.27830189,  -42.60651629,
        -36.74540682,  -21.64179104,  -37.31343284,  -77.6119403 ,
        -77.86069652, -100.        ,  -98.37209302, -100.        ,
        -88.13559322,  -88.30508475,  -78.47457627,  -72.20338983,
        -70.        ,  -77.79661017,  -99.3220339 ,  -99.49579832,
        -85.79335793,  -82.32323232,  -87.82201405,  -81.43564356,
        -80.44554455,  -68.56435644,  -81.93069307,  -65.84158416,
        -67.32673267,  -67.07920792,  -43.50453172,  -22.94520548,
        -16.17647059,  -17.27941176,   -6.25      ,   -8.82352941,
         -0.        ,   -5.32994924,  -14.72081218,  -13.31444759,
         -9.39086294,   -5.39772727,  -14.20454545,  -13.84180791,
        -17.70491803,   -9.73782772,  -29.72972973,  -35.13513514,
        -19.20289855,  -12.4497992 ,  -40.68965517,  -26.20689655,
        -16.98113208,  -20.75471698,  -27.04402516,  -99.48453608,
        -97.16312057,  -78.57142857,  -78.23129252,  -96.59863946,
        -88.55218855,  -94.61279461,  -93.93939394,  -95.05813953,
        -97.6744186 ,  -97.56690998,  -93.75      ,  -93.70786517,
        -80.94117647,  -53.38345865,  -63.86554622,  -52.34042553,
        -59.64912281,  -50.        ,  -47.32142857,  -54.91071429]
assert 2, eqObj(tick2, rs2, precision)

tick3=exec ta::willr(high,low,close,14) from tickTB where sym=`tick3
rs3=[nan, nan, nan, nan, nan]
assert 3, eqObj(tick3, rs3,precision)

tick4=exec ta::willr(high,low,close,14) from tickTB where sym=`tick4
rs4=[          nan,           nan,           nan,           nan,
                 nan,           nan,           nan,           nan,
                 nan,           nan,           nan,           nan,
                 nan,  -98.91304348, -100.        ,  -67.24738676,
        -73.86759582, -100.        ,  -83.38028169,  -57.18309859,
        -82.25352113,  -89.32291667,  -66.40625   ,  -57.59162304,
        -45.26315789,  -34.57943925,  -41.12149533,  -15.11627907,
        -11.24031008,  -16.21621622,  -14.52702703,  -27.02702703,
        -40.54054054,  -37.5       ,  -31.08108108,  -46.22222222,
        -50.52631579,  -33.9869281 ,  -30.71895425,   -5.88235294,
         -1.96078431,  -31.37254902,  -63.39869281,  -49.34210526,
        -57.89473684,  -85.95505618,  -85.39325843, -100.        ,
        -97.63313609,  -80.17751479,  -59.46745562,  -60.94674556,
        -65.0887574 ,  -68.34319527,  -40.12158055,  -66.43835616,
        -59.24657534,  -64.38356164,  -86.53061224,  -98.42519685,
        -89.93288591,  -77.18120805,  -72.81879195,  -92.95302013,
        -88.59060403,  -82.55033557, -100.        ,  -86.45533141,
        -93.37175793,  -97.56944444,  -99.05956113,  -96.36363636,
        -86.42384106,  -70.90163934,  -45.49180328,  -47.13114754,
        -52.69709544,  -43.83561644,  -29.22374429,   -9.54773869,
        -10.        ,  -23.68421053,   -0.5       ,   -6.4516129 ,
        -14.11290323,  -25.80645161,  -19.90950226,  -33.33333333,
        -50.69444444,  -54.16666667,  -94.44444444,  -67.35751295,
        -66.83937824,  -63.73056995,  -59.06735751,  -23.83419689,
        -27.4611399 ,  -41.47727273,  -56.21301775,  -52.66272189]
assert 4, eqObj(tick4, rs4, precision)

tick5=exec ta::willr(high,low,close,14) from tickTB where sym=`tick5
rs5=[          nan,           nan,           nan,           nan,
                 nan,           nan,           nan,           nan,
                 nan,           nan,           nan,           nan,
                 nan,  -90.14084507, -100.        ,  -66.26506024,
        -66.66666667,  -63.15789474,  -99.1416309 ,  -88.1147541 ,
        -85.6557377 ,  -91.39344262,  -89.80263158,  -65.13157895,
        -62.82894737,  -61.51315789,  -56.90789474,  -37.43315508,
        -23.52941176,  -18.18181818,  -26.25698324,   -4.62427746,
        -13.7254902 ,  -44.11764706,  -42.64705882,  -33.33333333,
        -40.        ,  -44.        ,  -19.65811966,  -16.66666667,
        -13.15789474,  -24.47552448,  -33.56643357,  -44.05594406,
        -13.28671329,  -42.85714286,  -67.53246753,  -75.32467532,
        -99.00990099,  -96.75090253,  -83.75451264,  -70.39711191,
        -68.59205776,  -77.25631769,  -67.50902527,  -70.39711191,
        -88.0866426 ,  -80.50541516,  -92.05776173,  -89.10505837,
        -85.8974359 ,  -74.61928934,  -46.06060606,  -36.96969697,
        -76.36363636,  -66.06060606,  -50.31847134,  -85.06493506,
        -75.32467532,  -87.60330579,  -95.95375723,  -98.15668203,
        -90.0862069 ,  -89.43396226,  -81.50943396,  -60.37735849,
        -61.88679245,  -63.88888889,  -56.65236052,  -48.92703863,
        -33.97129187,  -17.2972973 ,  -32.41758242,  -22.6744186 ,
        -32.55813953,  -29.65116279,   -0.        ,   -0.        ,
        -32.60869565,  -46.66666667,  -15.11111111,  -16.22641509,
        -28.0141844 ,  -49.64539007,  -50.        ,  -59.21985816,
        -56.73758865,  -55.31914894,  -63.4751773 ,  -82.35294118]
assert 5, eqObj(tick5,rs5, 3)

maBySym=(exec ta::willr(high,low,close,14) from tickTB context by sym ).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(maBySym, rs, 3)

@testing:case="test_ta_function_willr"
close=[1,2,3,3.5,3.6,3,2,1,10,9,8,1,2,3,5,3,2,4,1,2,9,6.7,100,10,20].take(50)
high=[2,12,13,6.5,6.6,13,21,12,110,19,8,11,12,23,5,13,21,14,11,3,19,11.7,101,11,25].take(50)
low=[0.1,0.2,0.3,3.5,1.6,1.3,1,0,6,2,5,0,1.2,1.3,3,3,1.2,0,1,2,0.9,2.7,60,9,15].take(50)
volume = [10.0,20,30,30,60,30,20,10,10,90,80,10,20,30,50,30,20,40,10,20,90,60,100,10,10].take(50)
x = willr(high, low, close, 14)
y = [-97.27272727, -95.45454545, -97.27272727,
       -98.18181818, -96.36363636, -99.09090909, -98.18181818,
       -91.81818182, -93.90909091,  -0.99009901, -90.0990099 ,
       -80.1980198 , -99.00990099, -98.01980198, -97.02970297,
       -96.53465347, -96.43564356, -97.02970297, -98.11694747,
       -99.00990099, -90.90909091, -91.81818182, -92.72727273,
       -99.09090909, -98.18181818, -97.27272727, -95.45454545,
       -97.27272727, -98.18181818, -96.36363636, -99.09090909,
       -98.18181818, -91.81818182, -93.90909091,  -0.99009901,
       -90.0990099 , -80.1980198 ]
assert 1, eqObj(x[13:], y, 6)
