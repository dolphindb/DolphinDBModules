#include "setup/settings.txt"
use ta

precision=5
nan=double()
@testing:case="test_ta_function_kama_use_ticks_specify_timeperiod=10_contextby"
timePeriod=10
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec ta::kama(close, timePeriod) from tickTB where sym=`tick1
rs1=[nan, nan, nan, nan, nan, nan, nan, nan]
assert 1, eqObj(tick1, rs1, precision)

tick2=exec ta::kama(close,timePeriod) from tickTB where sym=`tick2
rs2=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan, 16.10207825, 16.10155876, 16.10249025, 16.09765914,
       15.9912291 , 16.00549517, 15.88646578, 15.72307056, 15.71785542,
       15.71938417, 15.72296945, 15.72349205, 15.72622335, 15.77786133,
       15.78769332, 15.74565384, 15.73056518, 15.69018887, 15.62431639,
       15.14892101, 14.65802437, 14.26735057, 14.09622335, 13.96892177,
       13.90956268, 13.83793415, 13.53197305, 13.16609224, 13.02071711,
       12.91663644, 12.76853917, 12.67869642, 12.51763489, 12.43435308,
       12.25479834, 12.22741925, 12.2224652 , 12.19977448, 12.19978358,
       12.22676374, 12.29519051, 12.33890455, 12.43229166, 12.47690349,
       13.07546078, 13.53274369, 13.63903584, 13.74848803, 13.95609004,
       14.14819716, 14.1959137 , 14.24338983, 14.26912316, 14.34336861,
       14.34427169, 14.34328455, 14.36852379, 14.41161073, 14.41366921,
       14.41795694, 14.47019046, 14.50685331, 14.5324353 , 14.47004375,
       14.31444767, 14.266027  , 14.16866541, 13.93735682, 13.82324704,
       13.65498305, 13.45498556, 13.17264238, 12.93471283, 12.66481444,
       12.50878538, 12.10665033, 12.05479307, 12.05727814, 12.03380886,
       12.03330466, 12.0225902 , 12.02256211, 12.02288107, 12.01973828]
assert 2, eqObj(tick2, rs2,3)

tick3=exec ta::kama(close, timePeriod) from tickTB where sym=`tick3
rs3=[nan, nan, nan, nan, nan]
assert 3, eqObj(tick3, rs3,precision)

tick4=exec kama(close, timePeriod) from tickTB where sym=`tick4
rs4=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
       11.9909709 , 11.96786919, 11.95503881, 11.79763633, 11.50879794,
       11.45659147, 11.4011642 , 11.22253914, 10.94338813, 10.89784631,
       10.74890578, 10.57380188, 10.53602621, 10.53013454, 10.52850622,
       10.52827166, 10.52684705, 10.53013717, 10.53934633, 10.5487041 ,
       10.60299084, 10.59334562, 10.57882415, 10.57329403, 10.57244309,
       10.56877811, 10.56700596, 10.57206335, 10.57690103, 10.59728332,
       10.61941714, 10.62503846, 10.6213041 , 10.62060125, 10.61976842,
       10.59720569, 10.570862  , 10.27144437,  9.76670271,  9.55953737,
        9.53836717,  9.51922412,  9.49741902,  9.45802158,  9.46590629,
        9.4517749 ,  9.44600528,  9.44276163,  9.4317804 ,  9.34839294,
        9.09208767,  8.98397216,  8.91538199,  8.77910298,  8.51289683,
        8.41574427,  8.12140963,  7.96936919,  7.83926001,  7.74128134,
        7.57601209,  7.29195484,  6.99652221,  6.92371052,  6.9199629 ,
        6.91202939,  6.90863317,  6.90448029,  6.90641358,  6.93193006,
        6.97976928,  6.97134969,  7.0566642 ,  7.18726205,  7.21831267,
        7.22146557,  7.24271546,  7.25621326,  7.25561401,  7.25481529,
        7.22924715,  7.21947532,  7.16636906,  7.07923886,  7.04377843,
        7.04987022,  7.05299772,  7.05258388,  7.04199402,  7.03624944]
assert 4, eqObj(tick4, rs4, precision)     

tick5=exec ta::kama(close, timePeriod) from tickTB where sym=`tick5
rs5=[       nan,        nan,        nan,        nan,        nan,
              nan,        nan,        nan,        nan,        nan,
       9.99928178, 9.98730445, 9.98817658, 9.94055131, 9.78751776,
       9.71280381, 9.65032733, 9.61370271, 9.44949658, 9.29189202,
       9.18932691, 9.07044979, 8.77373874, 8.75307741, 8.75143455,
       8.74538712, 8.74377316, 8.73716525, 8.73734388, 8.74324146,
       8.74036697, 8.75563425, 8.82526028, 8.8223302 , 8.82031731,
       8.81821616, 8.8173891 , 8.81693368, 8.82639429, 8.83513144,
       8.85869794, 8.87444591, 8.87722206, 8.89496877, 9.00550792,
       9.00935143, 9.0078645 , 9.00127213, 8.81769726, 8.45724201,
       8.32058012, 8.27411034, 8.24206792, 8.19106983, 8.15879446,
       8.12785485, 8.05158603, 8.01994085, 7.99557267, 7.98286406,
       7.93093351, 7.85783723, 7.84435267, 7.84250056, 7.771858  ,
       7.73924204, 7.73709837, 7.68790157, 7.67422017, 7.66121923,
       7.59213681, 7.40788806, 7.1312129 , 6.75630261, 6.61732138,
       6.58930741, 6.54429221, 6.51305613, 6.48599677, 6.48036406,
       6.47945806, 6.49810007, 6.48514574, 6.47205449, 6.45335066,
       6.4502226 , 6.49677975, 6.71579957, 6.7974481 , 6.81289817,
       6.90287149, 7.03106361, 7.16779463, 7.17916928, 7.192806  ,
       7.190391  , 7.19052243, 7.19156848, 7.1877298 , 7.18733232]
assert 5, eqObj(tick5, rs5, precision)

maBySym=(exec ta::kama(close, timePeriod) from tickTB context by sym).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(maBySym, rs, precision)

@testing:case="test_ta_function_kama"
x=[0.738943,54.656038,68.600639,48.727166,29.061742,80.547883,88.441286,53.563787,84.333949,86.184134,79.958874,80.857146,16.09588,70.020608,46.971058,5.667949,35.074464,50.96734,13.780723,12.020372,60.611425,17.038672,93.005266,21.724079,78.437219,17.679625,78.095357,68.494213,78.234003,24.844407,81.324836,89.290484,29.122386,47.330442,32.111762,59.484709,24.228521,55.667259,42.17003,42.415287]
ta=ta::kama(x,10)
rs=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
       85.75399757, 85.6457677 , 82.94146138, 82.78055419, 82.39601703,
       78.18360365, 76.84129102, 76.7132445 , 73.68709105, 70.50224052,
       70.40075738, 68.83262772, 69.70030837, 68.76711896, 68.88295957,
       68.54774127, 68.68381832, 68.68237755, 68.90610028, 68.6221677 ,
       68.7240685 , 69.24154309, 68.33082497, 68.10496665, 67.36093756,
       67.19866425, 65.88168269, 65.80074248, 65.38529875, 65.13535261]
assert 1,eqObj(ta,rs,5)

ta=ta::kama(x,6)
rs=[        nan,         nan,         nan,         nan,         nan,
               nan, 81.69466362, 81.5608573 , 81.60218927, 81.82079822,
       81.65901407, 81.65543884, 72.33468797, 72.29732642, 71.13967864,
       64.45750179, 63.38333321, 63.12823488, 62.87624032, 58.31312346,
       58.34179006, 57.90080628, 59.61477378, 58.99614635, 59.73701654,
       59.50630726, 59.66732557, 59.88511781, 60.06005459, 59.87742945,
       59.98695308, 62.32962986, 60.80964501, 60.59430995, 59.50155866,
       59.50103069, 56.85461848, 56.81932705, 56.60753166, 56.49619162]
assert 2,eqObj(ta,rs,5)
