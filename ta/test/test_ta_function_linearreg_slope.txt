
#include "setup/settings.txt"

use ta

//linearreg_slope(close, timeperiod=14)

@testing:case="test_ta_function_linearreg_slope"
x=[89.79,11.58,99.9,81.11,84.69,31.38,60.9,83.3,97.26,98.67]

validate=[ , , , ,   5.933,   2.439, -12.773,  -1.941,   7.706, 17.094]
assert 1,eqObj(ta::linearreg_slope(x,5),validate,6)

validate=[ , , , , , -2.61457143,  1.27485714, -5.62685714,  3.03142857,  8.284     ]
assert 2,eqObj(ta::linearreg_slope(x,6),validate,6)

validate=[ , , , , , , -2.22428571,  3.1225,     -0.97607143,  4.63357143]
assert 3,eqObj(ta::linearreg_slope(x,7),validate,6)

close=[5.18,71.01,76.28,5.92,52.97,16.45,92.88,7.37,79.39,15.82]
t=table(take(`A`B,10) as sym,close)
re=exec ta::linearreg_slope(close,5) from t
validate=[ , , , ,  3.049, -13.243,   4.373,   4.281,   4.376,  -1.475]
assert 4,eqObj(re,validate,6)

@testing:case="test_ta_function_linearreg_slope_context_by"
tick = loadText(DATA_DIR + "/ticks1.csv")
res = select sym, ta::linearreg_slope(close, 10) as linearreg_slope from tick context by sym 
tick1 = exec linearreg_slope from res where sym = `tick1
validate1 = take(double(), 8)
assert 1, eqObj(tick1, validate1, 6)
tick2 = exec linearreg_slope from res where sym = `tick2
validate2 = [ , , , , , ,
  , , , , , ,
  , , , -0.26581818,  0.00957576,  0.28521212,
  0.63539394,  0.88351515,  0.77593939,  0.63363636,  0.33006061, -0.10733333,
 -0.22187879, -0.1589697,  -0.06424242, -0.00975758,  0.08278788,  0.15048485,
  0.16060606,  0.12727273,  0.04557576, -0.1569697,  -0.31672727, -0.39666667,
 -0.46757576, -0.50733333, -0.45545455, -0.29745455, -0.13327273, -0.07030303,
 -0.05945455, -0.14260606, -0.16181818, -0.19872727, -0.27478788, -0.3189697,
 -0.30521212, -0.2169697,  -0.12721212, -0.00224242,  0.05175758,  0.04860606,
  0.10218182,  0.16309091,  0.17412121,  0.17751515,  0.18175758,  0.19284848,
  0.22309091,  0.27357576,  0.268,       0.2409697,   0.24842424,  0.26206061,
  0.23424242,  0.18363636,  0.12715152,  0.06236364,  0.04175758,  0.02545455,
  0.01363636,  0.01181818,  0.01806061,  0.04666667,  0.07115152,  0.08515152,
  0.08224242,  0.00866667, -0.1170303,  -0.21006061, -0.25581818, -0.29757576,
 -0.31854545, -0.31327273, -0.25812121, -0.20260606, -0.1230303,  -0.14339394,
 -0.19363636, -0.21484848, -0.18224242, -0.14424242, -0.10678788, -0.05381818,
 -0.00242424,  0.03854545,  0.07921212,  0.06787879]
assert 2, eqObj(tick2, validate2, 6)
tick3 =exec linearreg_slope from res where sym = `tick3
validate3 = take(double(), 5)
assert 3, eqObj(tick3, validate3, 6)
tick4 = exec linearreg_slope from res where sym = `tick4
validate4 = [ , , , , , , , , ,-9.75757576e-03, -1.13333333e-02, -7.03030303e-03,
 -5.93939394e-03, -3.50909091e-02, -1.53515152e-01, -1.83393939e-01,
 -2.25878788e-01, -3.17636364e-01, -3.32000000e-01, -2.57757576e-01,
 -2.08363636e-01, -1.95939394e-01, -1.01454545e-01, -3.10909091e-02,
  6.06060606e-05,  8.23636364e-02,  1.39090909e-01,  1.42969697e-01,
  1.42424242e-01,  1.97151515e-01,  1.87151515e-01,  1.03454545e-01,
  3.53939394e-02, -1.14545455e-02, -2.00606061e-02, -3.33939394e-02,
 -5.41818182e-02, -3.23030303e-02, -4.06060606e-03,  5.51515152e-02,
  1.16242424e-01,  1.23272727e-01,  7.30303030e-02,  3.74545455e-02,
  3.21212121e-03, -7.48484848e-02, -1.40969697e-01, -2.24303030e-01,
 -3.23818182e-01, -3.31393939e-01, -2.64909091e-01, -2.07030303e-01,
 -1.70181818e-01, -1.10303030e-01,  8.90909091e-03,  3.72121212e-02,
  8.81818182e-02,  7.37575758e-02, -3.46666667e-02, -1.49878788e-01,
 -2.16181818e-01, -2.40363636e-01, -2.47272727e-01, -2.78000000e-01,
 -2.19454545e-01, -1.85575758e-01, -1.61272727e-01, -1.06545455e-01,
 -8.76363636e-02, -1.17212121e-01, -1.76545455e-01, -1.96363636e-01,
 -1.87696970e-01, -1.79272727e-01, -1.15878788e-01, -3.61212121e-02,
 -5.33333333e-03,  4.63030303e-02,  1.02787879e-01,  1.51515152e-01,
  1.50969697e-01,  1.18666667e-01,  1.01575758e-01,  1.03333333e-01,
  1.16545455e-01,  1.01575758e-01,  8.08484848e-02,  5.30303030e-02,
  2.35757576e-02,  5.63636364e-03, -4.87272727e-02, -1.10000000e-01,
 -1.31454545e-01, -1.17939394e-01, -9.92121212e-02, -5.31515152e-02,
  2.42424242e-04,  3.18787879e-02,  3.61212121e-02,  4.58787879e-02]
assert 4, eqObj(tick4, validate4, 6)
tick5 = exec linearreg_slope from res where sym = `tick5
validate5 = [ , , , , , , , , , -5.99393939e-02, -6.52121212e-02, -5.74545455e-02,
 -3.15757576e-02, -2.27878788e-02, -9.65454545e-02, -1.18121212e-01,
 -1.34606061e-01, -1.45212121e-01, -1.96545455e-01, -1.98909091e-01,
 -1.94727273e-01, -1.79030303e-01, -1.48848485e-01, -9.19393939e-02,
 -8.11515152e-02, -4.23636364e-02,  8.00000000e-03,  5.88484848e-02,
  7.00000000e-02,  8.87878788e-02,  9.23636364e-02,  1.00121212e-01,
  7.03636364e-02,  3.92121212e-02,  1.33939394e-02,  1.21212121e-04,
 -2.84848485e-03, -1.26666667e-02,  8.42424242e-03,  3.37575758e-02,
  4.33939394e-02,  7.30303030e-02,  9.89090909e-02,  7.41818182e-02,
  6.86666667e-02,  4.44242424e-02, -1.63636364e-03, -4.93333333e-02,
 -1.18969697e-01, -2.06424242e-01, -2.46242424e-01, -2.38424242e-01,
 -2.18484848e-01, -2.05757576e-01, -1.32000000e-01, -6.75757576e-02,
 -3.95757576e-02,  8.84848485e-03, -3.21212121e-03, -7.13939394e-02,
 -1.15454545e-01, -1.18424242e-01, -8.72121212e-02, -5.83636364e-02,
 -4.62424242e-02, -1.83030303e-02, -2.18181818e-03, -1.81818182e-03,
 -5.15151515e-03, -3.86060606e-02, -1.04787879e-01, -1.75818182e-01,
 -2.01454545e-01, -2.10909091e-01, -2.25575758e-01, -1.82121212e-01,
 -1.14666667e-01, -7.46666667e-02, -1.00000000e-02,  5.89696970e-02,
  1.03151515e-01,  1.19454545e-01,  1.09818182e-01,  7.88484848e-02,
  3.98787879e-02,  3.28484848e-02,  5.55757576e-02,  9.92121212e-02,
  1.17333333e-01,  1.15454545e-01,  1.55151515e-01,  2.07272727e-01,
  2.14969697e-01,  1.75333333e-01,  1.11696970e-01,  2.31515152e-02,
 -2.98787879e-02, -3.82424242e-02, -7.01212121e-02, -1.11636364e-01]
assert 5, eqObj(tick5, validate5, 6)
