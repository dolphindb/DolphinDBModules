#include "setup/settings.txt"
use ta
//bop(open, high, low, close)

precision=5
nan=double()
@testing:case="test_ta_function_bop_context_by"
tick = loadText(DATA_DIR + "/ticks1.csv")
res = select sym,bop(open, high, low, close) bopResult from tick context by sym
tick1 = exec bopResult from res where sym = `tick1
validate1=[0.162791,0.755814,-0.205479,0.209677,-0.661157,0.976378,0.646018,0.428571]
assert 1, eqObj(tick1, validate1, 6)

tick2 = exec bopResult from res where sym = `tick2
validate2=[        nan,         nan,         nan,         nan,         nan,
               nan, -0.16666667,  0.25      ,  0.4       ,  0.5       ,
        0.6097561 , -0.31111111, -0.54545455,  0.2826087 ,  0.42666667,
        1.        ,  0.47488584, -0.36363636,  0.30985915, -0.6       ,
        0.22      ,  0.56842105, -0.41463415, -0.51968504,  0.81052632,
        0.84951456,  0.09473684, -0.21428571,  0.35025381,  0.50251256,
       -0.50746269, -0.90967742,  0.77906977, -0.79166667, -0.03703704,
       -0.55045872, -0.05333333,  0.26229508,  0.65934066,  0.69230769,
        0.23076923, -0.48275862, -0.82978723, -0.95652174,  0.57142857,
        0.06666667, -0.33663366,  0.28571429,  0.5       ,  0.47457627,
       -0.59615385,  0.72619048,  0.25      ,  0.25806452,  0.43165468,
        0.71014493,  0.17460317,  0.10869565,  0.69565217,  0.0212766 ,
        0.98473282,  0.3442623 , -0.41666667, -0.01886792,  0.61320755,
        0.65384615, -0.33898305,  0.18571429,  0.04545455,  0.5625    ,
       -0.47      ,  0.16326531,  0.59459459,  0.47058824, -0.65116279,
        0.83050847,  0.2987013 , -0.43589744,  0.04      , -0.9125    ,
       -0.73033708,  0.57534247,  0.15151515, -0.92982456,  0.27906977,
       -0.5       , -0.03846154, -0.575     , -0.77272727, -0.75324675,
        0.47272727, -0.31428571,  0.640625  ,  0.68253968, -0.81481481,
        0.38      , -0.2       ,  0.4       ,  0.05714286, -0.17241379]
assert 2, eqObj(tick2.subarray(6:), validate2.subarray(6:), 6)
//tick2 result is 0 rather than null

tick3 = exec bopResult from res where sym = `tick3
validate3=[-0.43809524, -0.35555556,  0.64220183, -0.91240876, -0.5       ]
assert 3, eqObj(tick3, validate3, 6)

tick4 = exec bopResult from res where sym = `tick4
validate4=[ 0.22807018,  0.67592593, -0.37735849,  0.5       , -0.69298246,
        0.81481481, -0.78571429, -0.23076923,  0.65934066,  0.16981132,
       -0.09756098, -0.30656934,  0.06666667, -0.89473684, -1.        ,
        0.64516129, -0.34615385, -1.        ,  0.11111111,  0.14285714,
       -0.93684211, -0.41304348,  1.        ,  0.45205479,  0.23529412,
        0.225     , -0.61764706,  0.5       ,  0.29032258,  0.25757576,
        0.23287671, -0.60227273, -0.41666667, -0.325     ,  0.85      ,
       -0.10810811,  0.4516129 ,  0.69354839,  0.05882353,  0.69230769,
        0.37349398, -0.79545455, -0.71212121,  0.35555556, -0.70212766,
       -0.49411765,  0.075     , -0.86666667, -0.56896552,  0.46875   ,
        0.58741259, -0.23529412, -0.75294118,  0.05102041,  0.        ,
       -1.        ,  0.625     ,  0.80701754, -0.72916667, -0.81372549,
        0.25      ,  0.62686567,  0.34285714, -0.82089552,  0.5862069 ,
        0.5       , -0.92753623,  0.83333333, -0.41025641, -0.29166667,
       -0.94545455, -0.69444444,  0.        ,  0.80851064,  0.31034483,
        0.01639344, -0.38461538,  0.34375   ,  0.87234043,  0.56818182,
       -0.12      , -0.73684211,  0.9       ,  0.5952381 ,  0.12765957,
        0.        ,  0.64516129, -0.16666667, -0.54545455, -0.20833333,
       -0.73417722,  0.12      ,  0.36585366,  0.2244898 ,  0.34482759,
        0.87179487,  0.09677419, -0.75609756, -0.42857143,  0.47058824]
assert 41, eqObj(tick4.subarray(:54), validate4.subarray(:54), 5)
assert 42, eqObj(tick4.subarray(54:55), validate4.subarray(54:55), 5)
assert 43, eqObj(tick4.subarray(56:), validate4.subarray(56:), 5)

tick5 = exec bopResult from res where sym = `tick5
validate5=[ 0.98780488,  0.14285714,  0.01612903,  0.6       , -0.65168539,
        0.60344828, -0.54285714, -0.42857143,  0.35555556,  0.65116279,
       -0.93103448,  0.09459459,  0.82608696, -0.78947368, -1.        ,
        0.75      ,  0.        ,  0.21875   , -1.        ,  0.42105263,
       -0.04166667, -0.76470588, -0.51086957,  0.93103448,  0.12244898,
        0.31578947, -0.16666667, -0.07142857,  0.3       ,  0.43478261,
       -0.76744186,  0.78431373,  0.24      , -0.92207792, -0.27777778,
        0.5862069 ,  0.06896552,  0.31818182,  0.71111111,  0.03703704,
        0.3030303 ,  0.1025641 , -0.3255814 , -0.1627907 ,  0.97777778,
       -0.85074627, -0.24675325,  0.16216216, -0.97333333, -0.5483871 ,
        0.5       ,  0.52222222,  0.09803922, -0.56603774,  0.5       ,
       -0.28571429, -0.95238095,  0.47169811, -0.625     , -0.5       ,
       -0.10169492, -0.25925926,  0.65671642,  0.40540541, -0.88571429,
        0.73809524,  0.55      , -0.84      ,  0.67741935, -0.95652174,
       -0.81578947, -0.90196078, -0.41666667, -0.13953488,  0.71428571,
        0.1       , -0.17142857,  0.11538462,  0.78947368,  0.89473684,
        0.36363636,  0.60606061, -0.57142857,  0.53658537, -0.5       ,
        0.35294118,  1.        ,  0.91666667, -0.81927711, -0.26      ,
        1.        ,  0.01428571, -0.4875    , -0.78947368,  0.275     ,
       -0.27419355,  0.24137931,  0.06779661, -0.42222222,  0.57446809]
assert 5, eqObj(tick5, validate5, 6)

@testing:case="test_ta_function_bop_5"
open =[9.38674641, 1.15414497, 7.05586489, 6.79366979, 4.87377749]
high = [4.87661076, 5.09258627, 4.69128548, 4.51989263, 0.85037274]
low = [9.50391399, 8.50713385, 2.00315372, 1.04252965, 7.00412279]
close =[3.67652627, 7.14380803, 3.64008183, 5.90980276, 5.6898537 ]
assert 1, eqObj(bop(open, high, low, close), [0,0,-1.27069034, -0.25417739,0],precision)
