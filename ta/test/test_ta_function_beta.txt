
#include "setup/settings.txt"

use ta

//beta(high, low, timeperiod)

@testing:case="test_ta_function_beta"
x=[89.79,11.58,99.9,81.11,84.69,31.38,60.9,83.3,97.26,98.67]
y=[49.56,82.26,99.05,24.22,36.71,26.1,23.95,69.59,58.4,14.99]

validate=[ , , , , , 0.01777338, 0.05197845, 0.59552864, 0.36077254, 0.50839076]
assert 1,eqObj(ta::beta(x,y,5),validate,6)

validate=[ , , , , , , 0.01836417, 0.01006555, 0.57909421, 0.47133673]
assert 2,eqObj(ta::beta(x,y,6),validate,6)

validate=[ , , , , , , , -0.00560478,  0.01825743,  0.63359774]
assert 3,eqObj(ta::beta(x,y,7),validate,6)

high=[10.17,81.33,87.88,44.38,78.25,98.26,14.73,26.38,56.53,28.07]
low=[15.81,51.88,58.33,44.05,58.87,27.06,35.14,22.42,33.41,96.43]
t=table(take(`A`B,10) as sym,high,low)
re=exec ta::beta(high,low,5) from t
validate=[ , , , , ,  0.34562573, -0.00330547, -0.115004,    0.0185968,  -0.48141556]
assert 4,eqObj(re,validate,6)

high=[NULL,81.33,87.88,NULL,NULL,NULL,14.73,26.38,NULL,28.07]
low=[NULL,82.26,NULL,24.22,36.71,26.1,NULL,69.59,58.4,14.99]
assert 5,eqObj(ta::beta(high,low,5),take(double(),10),6)

@testing:case="test_ta_function_beta_context_by"
tick = loadText(DATA_DIR + "/ticks1.csv")
res = select sym, ta::beta(high, low, 10) as beta from tick context by sym 
tick1 = exec beta from res where sym = `tick1
validate1 = take(double(), 8)
assert 1, eqObj(tick1, validate1, 6)
tick2= exec beta from res where sym = `tick2
validate2 = [ , , , , ,  ,
  , , , , , ,
  , , , ,  1.00698916,  0.98745086,
  0.98655693,  0.97855081,  0.930127,    0.92788425,  0.91778041,  0.91543674,
  0.45803101,  0.37694681,  0.33122375,  0.42110324,  0.43936041,  0.5435356,
  0.44526491,  0.73634316,  0.72265017,  0.69254295,  0.68476147,  0.95483521,
  0.78599711,  0.67732106,  0.74428498,  0.61680767,  0.7171584,   0.57137111,
  0.67740507,  0.63448899,  0.63069947,  0.69582774,  0.70232986,  0.80073971,
  0.82314388,  0.66693618,  0.66241548,  0.67670402,  0.65926872,  0.6439845,
  0.36218328,  0.22041375, -0.28935301, -0.22523492, -0.27274476, -0.15740096,
 -0.02805604,  0.04080908,  0.11972275,  0.07751441,  0.25898918,  0.33439134,
  0.37711439,  0.36028814,  0.35086695,  0.3885519,   0.73898908,  0.31804245,
  0.33999509,  0.36014132,  0.45744885,  0.51913161,  0.52758389,  0.49711207,
  0.52274593,  0.6970393,   0.64004895,  0.68597088,  0.71579056,  0.64488433,
  0.63926894,  0.64715615,  0.56527415,  0.564454,    0.58495002,  0.61811825,
  0.66500262,  0.67670124,  0.72303875,  0.85144003,  0.80412996,  0.77133818,
  0.8441439,   0.79459868,  0.87845781,  0.69759929]
assert 2, eqObj(tick2, validate2, 6)
tick3 = exec beta from res where sym = `tick3
validate3 = take(double(), 5)
assert 3, eqObj(tick3, validate3, 6)
tick4 = exec beta from res where sym =`tick4
validate4 = [ , , , , , , , , , ,  0.27705502,  0.3085173,
 -0.00665725, -0.07411686,  0.4798624,   0.59019877,  0.63874909,  0.76255081,
  0.83763815,  0.91652755,  0.89316334,  0.97024507,  1.13719085,  1.12742343,
  1.16932025,  1.10611515,  1.10003504,  1.0213488,   1.00587175,  0.88192642,
  0.88479977,  0.72172813,  0.67569,     0.69584604,  0.45070527,  0.53569151,
  0.53663267,  0.47424853,  0.48293526,  0.4826661,   0.3881935,   0.35385324,
  0.54533419,  0.43044957,  0.6605246,   0.9825364,   0.78202502,  0.96085563,
  1.00694738,  0.86346538,  0.49033168,  0.56127264,  0.45570388,  0.46795123,
  0.64990995,  0.50049362,  0.62753656,  0.59540102,  0.35580045,  0.60863134,
  0.92505352,  0.814518,    1.07302505,  1.03672828,  0.56723182,  0.80357239,
  0.77778241,  0.7356255,   0.82104333,  0.75762667,  0.93679408,  0.88755452,
  0.65113127,  0.80663065,  1.10776116,  1.01318647,  0.91131844,  0.94053345,
  0.90894328,  0.90228226,  0.80708093,  0.81164847,  0.83246088,  0.96263816,
  0.72092106,  0.81528194,  1.03987251,  1.03292901,  1.16367432,  1.04054508,
  1.10225338,  1.0491714,   1.23208691,  0.88861043,  0.8572894,   0.86106866,
  0.85839868,  0.86076666,  0.93528107,  0.89007341]
assert 4, eqObj(tick4, validate4, 6)
tick5 = exec beta from res where sym =`tick5
validate5 = [ , , , , , , , , , , 1.02398879, 0.56047548,
 0.83567493, 0.39013563, 0.76786599, 0.83382492, 0.93321212, 0.92407384,
 0.96531988, 0.77524753, 0.77052747, 0.82409552, 0.80323156, 1.01817956,
 1.21990025, 1.11061946, 0.99988879, 1.02769522, 0.87196066, 1.82031396,
 1.91313062, 2.00034467, 1.0444365,  1.25728571, 0.84753899, 0.83284069,
 0.86295761, 0.8348837,  0.72727374, 0.74691186, 0.80664171, 0.81071142,
 0.81774703, 0.75749983, 0.84697495, 0.86162362, 0.99385706, 0.82903213,
 1.04693749, 1.08414212, 0.97131227, 0.73396175, 0.97039043, 0.96946726,
 0.96835576, 1.15425285, 1.13193736, 1.21599328, 1.12160226, 1.00274364,
 1.22735223, 2.07215519, 0.86723894, 1.14290876, 1.19427571, 0.87335608,
 0.87138536, 0.89166694, 0.84273999, 0.77068622, 0.90897854, 0.77355711,
 0.93432857, 0.63026768, 0.76055942, 0.95798918, 0.93645715, 0.91742332,
 0.93568656, 0.93718848, 0.86558066, 0.91347452, 0.87317503, 0.93347705,
 0.92400022, 0.71742669, 1.08177723, 1.07832285, 0.9124292,  0.80833873,
 0.7964793,  0.85889909, 0.85660851, 0.85131188, 0.87294444, 0.85199079,
 0.72380196, 0.62805483, 0.74524863, 0.77247282]
assert 4, eqObj(tick5, validate5, 6)

