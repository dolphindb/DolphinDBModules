#include "setup/settings.txt"
use ta

precision=5
nan=double()
@testing:case="test_ta_function_dema_use_ticks_specify_timeperiod=10_contextby"
timePeriod=10
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec ta::dema(close, timePeriod) from tickTB where sym=`tick1
rs1=[nan, nan, nan, nan, nan, nan, nan, nan]
assert 1, eqObj(tick1, rs1, precision)

tick2=exec ta::dema(close, timePeriod) from tickTB where sym=`tick2
rs2=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan, 15.15624966,
       15.50041646, 15.71261353, 15.81259294, 15.97794799, 16.3369725 ,
       16.3853452 , 15.87606261, 15.48898708, 14.8127138 , 14.33644115,
       13.80054157, 13.2797975 , 12.90211602, 12.82739978, 12.90771702,
       13.02205445, 12.96464216, 12.51117965, 11.88791368, 11.61786246,
       11.40938644, 11.08472442, 10.93566227, 10.85387149, 10.96659431,
       10.88448003, 11.0501893 , 11.16309587, 11.25807974, 11.513463  ,
       11.83273731, 12.08108665, 12.25490442, 12.48118229, 12.62270111,
       13.14676905, 13.6114172 , 13.82423399, 14.00788048, 14.30179653,
       14.56758178, 14.6497163 , 14.70834466, 14.72384481, 14.81739963,
       14.76771651, 14.6690785 , 14.75712814, 14.88823152, 14.88580547,
       14.94679942, 15.09484332, 15.17824979, 15.20042272, 14.71475592,
       14.08369778, 13.75931348, 13.52631858, 13.18071643, 13.00124006,
       12.8169215 , 12.69561993, 12.45588517, 12.25785164, 11.90618121,
       11.65006526, 11.37977061, 11.36743219, 11.5126459 , 11.50497422,
       11.59421965, 11.60192214, 11.68040324, 11.76400123, 11.77421141]
assert 2, eqObj(tick2, rs2, precision)

tick3=exec ta::dema(close, timePeriod) from tickTB where sym=`tick3
rs3=[nan, nan, nan, nan, nan]
assert 3, eqObj(tick3, rs3,precision)

tick4=exec ta::dema(close, timePeriod) from tickTB where sym=`tick4
rs4=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,  9.38011972,  9.51779384,
        9.33829325,  9.04860134,  9.13736621,  9.32381654,  9.62338027,
        9.85851366,  9.9673711 , 10.149751  , 10.31912099, 10.5072407 ,
       10.66169304, 10.65131178, 10.50878179, 10.43126066, 10.4358536 ,
       10.39906529, 10.39794037, 10.54237938, 10.66510701, 10.87998725,
       11.05622982, 11.03416973, 10.85199166, 10.7838562 , 10.68886118,
       10.40282779, 10.19505906,  9.71960862,  9.1077911 ,  8.85796974,
        8.91460273,  8.94971729,  8.93786117,  8.90024307,  9.17687085,
        9.05967553,  9.04668774,  8.99182194,  8.7206532 ,  8.26373352,
        7.8631928 ,  7.70173354,  7.63557541,  7.39837615,  7.27600719,
        7.25537979,  7.00205468,  6.89389309,  6.74466449,  6.55502668,
        6.25303685,  6.0273069 ,  5.86207258,  5.85089679,  6.05892302,
        6.20912494,  6.27796672,  6.36444869,  6.53888872,  6.75388119,
        6.8847809 ,  6.89588629,  7.08229945,  7.32833472,  7.44515718,
        7.43228107,  7.4854043 ,  7.5082255 ,  7.43926364,  7.36899119,
        7.12330498,  6.96071156,  6.84457178,  6.7802279 ,  6.76458521,
        6.98007778,  7.117719  ,  7.09720712,  6.98571711,  6.92312572]
assert 4, eqObj(tick4, rs4, precision)

tick5=exec ta::dema(close, timePeriod) from tickTB where sym=`tick5
rs5=[       nan,        nan,        nan,        nan,        nan,
              nan,        nan,        nan,        nan,        nan,
              nan,        nan,        nan,        nan,        nan,
              nan,        nan,        nan, 8.45658505, 8.28216722,
       8.18252662, 8.07210517, 7.83448072, 7.91625343, 8.00913421,
       8.09877724, 8.21766961, 8.26427791, 8.38856022, 8.51643317,
       8.543309  , 8.67325699, 8.80608971, 8.69877642, 8.62863193,
       8.63957218, 8.6677364 , 8.71178893, 8.84997983, 8.96463722,
       9.06107275, 9.15997347, 9.18750293, 9.15543578, 9.27461609,
       9.2411875 , 9.08819191, 8.93360175, 8.54107108, 8.02735812,
       7.77082769, 7.71014773, 7.6890265 , 7.6008701 , 7.63141432,
       7.6336327 , 7.47863401, 7.43872137, 7.30890476, 7.11261745,
       6.96030553, 6.91056597, 7.00948193, 7.13819487, 7.02309543,
       6.99817447, 7.05659352, 6.92159822, 6.87481299, 6.76796295,
       6.4945191 , 6.14173375, 5.90055566, 5.63759989, 5.52148571,
       5.63015354, 5.70586825, 5.73586345, 5.79707136, 5.9069024 ,
       6.05490822, 6.21663416, 6.23839667, 6.28805929, 6.26880669,
       6.27116464, 6.48129965, 6.86423962, 7.06887747, 7.11664735,
       7.38179422, 7.68484975, 7.86574313, 7.78995298, 7.72302063,
       7.58125532, 7.49457753, 7.4400386 , 7.32088317, 7.26720447]
assert 5, eqObj(tick5, rs5, precision)

maBySym=(exec ta::dema(close, timePeriod) from tickTB context by sym).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(maBySym, rs, precision)

@testing:case="test_ta_function_dema"
x=[0.738943,54.656038,68.600639,48.727166,29.061742,80.547883,88.441286,53.563787,84.333949,86.184134,79.958874,80.857146,16.09588,70.020608,46.971058,5.667949,35.074464,50.96734,13.780723,12.020372,60.611425,17.038672,93.005266,21.724079,78.437219,17.679625,78.095357,68.494213,78.234003,24.844407,81.324836,89.290484,29.122386,47.330442,32.111762,59.484709,24.228521,55.667259,42.17003,42.415287]
rs=take(double(),18).join([26.80187857, 19.86352505, 31.02272235, 25.06685187, 45.92739345, 37.88415278, 50.71376278, 40.13350224, 52.28071437, 58.0917639 , 65.54545322, 53.30511599, 62.84153754, 72.46971324, 59.58079914, 55.96498547, 48.22807406, 51.56495676, 42.40560956, 46.06622147, 44.37220953, 43.24647891])
assert 1,eqObj(ta::dema(x,10),rs,6)

rs=take(double(),10).join([85.08071257, 85.34855217, 53.39875587, 60.46481834, 53.56044121, 29.26979678, 29.35312041, 37.64694672, 24.75201658, 16.41514205, 35.60257732, 26.09186713, 57.70855531, 41.80764835, 59.83333016, 40.78996985, 58.77878987, 64.83102074, 72.98843913, 51.42859038, 65.92241372, 78.47610402, 56.29376576, 51.67640593, 41.51179019, 48.96557022, 36.35888745, 44.335238  , 42.71897987, 41.96967202])
assert 2,eqObj(ta::dema(x,6),rs,6)
