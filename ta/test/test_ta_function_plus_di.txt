#include "setup/settings.txt"
use ta
//plus_di(high,low,close,timePeriod)
nan=double()
@testing:case="test_ta_function_plus_di_take40"
high=1..40
low=5..44
close=2..41
talib=take(double(),14).append!([25., 25., 25., 25., 25., 25., 25., 25., 25., 25., 25.,
       25., 25., 25., 25., 25., 25., 25., 25., 25., 25., 25., 25., 25.,
       25., 25.])
assert 1, eqObj(plus_di(high,low,close,14),talib,5)
talib=take(double(),20).append!([25., 25., 25., 25., 25.,
       25., 25., 25., 25., 25., 25., 25., 25., 25., 25., 25., 25., 25.,
       25., 25. ])
assert 2, eqObj(plus_di(high,low,close,20),talib,5)
talib=array(DOUBLE, 40, 40, 25)
talib[0]=NULL
assert 3, eqObj(plus_di(high,low,close,1),talib,5)

@testing:case="test_ta_function_pdm_rand40"
high=[94.739049,93.478281,94.088897,96.054675,94.972775,95.461146,94.023315,95.706321,96.095073,95.350305,95.018151,94.530314,95.875794,95.521847,94.791411,94.203541,96.257133,95.309872,93.434449,93.832572,95.105265,95.948268,94.782984,97.307078,93.618041,95.635406,95.489552,96.492174,94.126911,95.67917,95.594209,96.696213,95.048238,95.358426,94.437821,96.628757,96.397873,93.846951,94.581207,94.531869]
low=[84.70979,85.368992,86.168038,85.634373,84.949723,83.983935,85.490546,83.870218,84.599746,84.912674,85.605142,85.142511,86.176738,84.008784,84.834548,82.861734,85.085571,83.799457,86.191154,86.497738,85.291,85.2722,85.947432,83.712935,85.437603,84.659326,86.151961,84.819301,83.631223,84.238844,83.47395,83.637817,84.135032,85.689062,84.922717,84.610406,84.132009,84.309811,85.344508,83.120667]
close=[90.334346,89.780365,91.157466,90.497458,91.36607,88.851499,90.594269,90.541739,90.637553,89.295211,89.836562,88.607447,89.553494,89.925092,90.221687,89.966416,89.581977,90.168114,92.135005,89.759036,89.970374,89.308475,89.377618,91.289147,91.02669,90.077177,89.519294,91.263757,88.590012,91.038244,90.663551,91.724582,89.459879,91.269616,88.739967,91.952984,89.877895,90.426801,89.565364,90.400894]
talib=[       nan,        nan,        nan,        nan,        nan,
              nan,        nan,        nan,        nan,        nan,
              nan,        nan,        nan,        nan, 4.25115711,
       3.88838189, 5.09147516, 4.66208244, 4.41003463, 4.46670127,
       5.09805833, 5.32202143, 4.9676446 , 6.31901468, 5.93672217,
       6.93701643, 6.46114771, 5.91490022, 5.46731883, 6.12818994,
       5.60637239, 5.86107161, 5.42227816, 5.27464291, 4.92655345,
       6.02238056, 5.52240728, 5.16346506, 5.3403347 , 4.9243822 ]
assert 1, eqObj(plus_di(high,low,close,14),talib,5)

talib=[       nan,        nan,        nan,        nan,        nan,
              nan,        nan,        nan,        nan,        nan,
              nan,        nan,        nan,        nan,        nan,
              nan,        nan,        nan,        nan,        nan,
       4.91326913, 5.08051517, 4.84391822, 5.8063833 , 5.55941164,
       6.28593284, 5.98234282, 5.62486495, 5.32376788, 5.80083369,
       5.44919706, 5.64152042, 5.33937753, 5.23797687, 4.99197746,
       5.77000231, 5.42732274, 5.17573986, 5.30089821, 5.00707117]
assert 2, eqObj(plus_di(high,low,close,20),talib,5)

talib=[       nan, 0.        , 0.07708962, 0.18864885, 0.        ,
       0.        , 0.        , 0.14219258, 0.03381826, 0.        ,
       0.        , 0.        , 0.13872278, 0.        , 0.        ,
       0.        , 0.18382318, 0.        , 0.        , 0.05427839,
       0.12967787, 0.07896194, 0.        , 0.18567511, 0.        ,
       0.18379649, 0.        , 0.        , 0.        , 0.13568311,
       0.        , 0.08439046, 0.        , 0.03207946, 0.        ,
       0.18229922, 0.        , 0.        , 0.07949333, 0.        ]*100
assert 3, eqObj(plus_di(high,low,close,1),talib,5)

@testing:case="test_ta_function_plus_di_csv"
timePeriod=14
tickTB=loadText(DATA_DIR+"/ticks1.csv")
tick1=exec plus_di(high,low, close,timePeriod) from tickTB where sym=`tick1
rs1=take(double(), 8)
assert 1, eqObj(tick1, rs1, 5)

tick2=exec plus_di(high,low, close,timePeriod) from tickTB where sym=`tick2
rs2=[, , , , , , , , , , , , , , , , , , , ,
       39.50424428, 39.9936024 , 37.93450776, 35.88038601, 34.38066469,
       37.45322307, 38.13974086, 36.9012107 , 33.59482092, 36.18995692,
       35.06088817, 32.42662607, 31.09113566, 29.27910993, 28.08909088,
       26.52664654, 24.50643668, 23.71545072, 25.47170209, 26.42769789,
       29.01489702, 28.03182515, 25.74790007, 24.33930191, 23.01265557,
       25.28596556, 23.61172225, 23.45920008, 22.92641534, 24.71318545,
       23.7303565 , 24.56933614, 24.80169186, 24.21896155, 29.37495127,
       27.8575075 , 29.81021578, 28.71862548, 28.16695064, 27.05841921,
       33.1517742 , 35.27798245, 33.72041341, 33.73159222, 34.7774713 ,
       33.18989749, 31.29628945, 31.66445316, 30.36989202, 28.54201416,
       29.87161127, 28.48909065, 31.31928893, 31.64928698, 30.87760416,
       29.00838407, 32.64009488, 31.30134618, 29.62378532, 25.00545771,
       22.86966681, 21.26526804, 20.56298152, 19.35323134, 18.48496419,
       17.97990361, 20.60297717, 19.11866051, 18.62945567, 16.99075822,
       15.91396187, 14.6420885 , 16.08163525, 19.82678408, 18.83306763,
       20.08309165, 19.34491026, 18.14765574, 19.50381851, 18.73301391]
assert 2, eqObj(tick2, rs2, 5)

tick3=exec plus_di(high,low, close,timePeriod) from tickTB where sym=`tick3
rs3=take(double(), 5)
assert 3, eqObj(tick3, rs3,5)

tick4=exec plus_di(high,low, close,timePeriod) from tickTB where sym=`tick4
rs4=[, , , , , , , , , , , , , , 13.9112324 ,
       13.31404561, 15.12742765, 13.62594059, 12.55981292, 18.18625127,
       16.57758297, 15.17744483, 17.32791964, 20.74224825, 26.05682754,
       25.08490676, 24.25668914, 25.3398256 , 24.51979018, 29.70238513,
       27.44654497, 26.4110851 , 24.18025988, 22.25249772, 21.76203502,
       20.88845895, 20.1583286 , 23.94155209, 23.57483648, 25.78716325,
       23.32591199, 21.94020973, 20.23917419, 19.16446325, 21.32207623,
       19.10192993, 18.19513408, 16.04228976, 14.06268301, 13.0880783 ,
       19.03383629, 18.37041797, 20.42785751, 18.4613832 , 19.27125903,
       17.40634991, 15.86530692, 14.94504907, 13.62701673, 12.37793582,
       11.65599183, 12.31814803, 13.05506448, 12.21063025, 11.85324874,
       14.60588786, 13.46368677, 12.77512271, 13.10654979, 12.40243342,
       11.63136507, 10.69405581, 10.08619812, 12.31577235, 18.25989568,
       20.90775254, 20.25100994, 19.44157741, 21.44842929, 23.96305363,
       23.1614941 , 21.95912732, 22.30974079, 27.28423103, 25.51429999,
       24.07754056, 24.43619285, 25.40755642, 23.76723888, 22.89883517,
       20.27303195, 18.14567323, 17.79945252, 18.6920891 , 18.15188308,
       22.32920732, 21.36321166, 20.09480656, 18.33617034, 17.44865243 ]
assert 4, eqObj(tick4, rs4, 5)

tick5=exec plus_di(high,low, close,timePeriod) from tickTB where sym=`tick5
rs5=[, , , , , , , , , , , , , , 10.02061486,
        8.95562854, 11.64332881, 11.18016804,  9.98991056,  9.52370567,
       11.31806984, 10.82514242,  9.60601909, 10.5285937 , 12.45116692,
       13.53411319, 13.10493451, 12.55608022, 14.98122162, 16.18347876,
       16.75774508, 15.54450937, 18.84335359, 16.85800677, 15.61543895,
       14.97698836, 16.96304368, 17.15503578, 19.77988537, 20.82317868,
       19.72497143, 25.21614721, 23.47675895, 21.85337585, 24.45060403,
       26.56202625, 23.53603648, 22.22577251, 19.50741482, 17.07528439,
       15.88288534, 18.02061138, 20.18500206, 18.80311805, 17.35461985,
       18.53181449, 17.28011904, 16.0656943 , 15.30094517, 13.80472466,
       12.73543333, 12.2671503 , 15.84346859, 18.72976543, 16.98175468,
       16.01592673, 18.8536056 , 17.24171334, 16.49443094, 15.94234417,
       14.24558316, 13.22814351, 12.13047317, 11.19661438, 11.9118105 ,
       18.38498802, 20.60989628, 19.81676218, 19.2342422 , 21.67753909,
       24.2800331 , 24.94640723, 25.57093554, 23.83074671, 22.63390842,
       21.31853801, 28.83503425, 36.60520021, 39.83261687, 36.81396307,
       38.9812924 , 45.46144709, 43.95212261, 39.95365516, 35.9306098 ,
       33.1451033 , 31.8994042 , 34.2435979 , 32.22956418, 30.22974012 ]
assert 5, eqObj(tick5, rs5, 5)

plus_diBySym=(exec plus_di(high,low, close,timePeriod) from tickTB context by sym).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(plus_diBySym, rs, 5)
