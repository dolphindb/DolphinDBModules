#include "setup/settings.txt"
use ta

//rocp(close, timePeriod)
@testing:case="test_ta_function_rocp_take40"
close=(1..40)
talib=take(double(),10).append!([ 10.        ,  5.        ,  3.33333333,  2.5       ,  2.        ,
        1.66666667,  1.42857143,  1.25      ,  1.11111111,  1.        ,
        0.90909091,  0.83333333,  0.76923077,  0.71428571,  0.66666667,
        0.625     ,  0.58823529,  0.55555556,  0.52631579,  0.5       ,
        0.47619048,  0.45454545,  0.43478261,  0.41666667,  0.4       ,
        0.38461538,  0.37037037,  0.35714286,  0.34482759,  0.33333333])
assert 1, eqObj(rocp(close,10),talib,5)
talib=take(double(),5).append!([ 5.        , 2.5       , 1.66666667, 1.25      , 1.        ,
       0.83333333, 0.71428571, 0.625     , 0.55555556, 0.5       ,
       0.45454545, 0.41666667, 0.38461538, 0.35714286, 0.33333333,
       0.3125    , 0.29411765, 0.27777778, 0.26315789, 0.25      ,
       0.23809524, 0.22727273, 0.2173913 , 0.20833333, 0.2       ,
       0.19230769, 0.18518519, 0.17857143, 0.17241379, 0.16666667,
       0.16129032, 0.15625   , 0.15151515, 0.14705882, 0.14285714 ])
assert 2, eqObj(rocp(close,5),talib,5)
talib=take(double(),40)
assert 3, eqObj(rocp(close,40),talib)

@testing:case="test_ta_function_rocr_rand40"
close =[56.84486603, 63.63574239, 17.24385137, 14.96223024, 79.31584397,
       55.19487319, 76.11299983,  8.6658699 , 23.08781124, 35.93374603,
       76.92630291, 32.72657806, 42.13828084, 55.27681132, 95.80582219,
       58.47228524, 13.48667322, 85.25350829, 11.76174822, 27.89005755,
        7.8807707 , 14.4892506 , 54.22748916, 21.95583062, 67.02994747,
        9.96686312, 55.93319639, 71.14257436,  5.82524944, 71.46937892,
       56.47772433, 95.07794425, 79.77511056, 94.64802509, 68.46983317,
        5.71675094, 11.19925125, 97.10198567, 73.83804116,  4.85530577]
talib=take(double(),10).append!([  0.35326738, -0.48572018,  1.44366992,  2.69442325,  0.2079027 ,
        0.05937892, -0.82280723,  8.8378477 , -0.49056461, -0.22384776,
       -0.89755428, -0.5572635 ,  0.28689372, -0.60280215, -0.30035622,
       -0.82954552,  3.14729381, -0.16551734, -0.50472929,  1.56253967,
        6.16652298,  5.56196424,  0.47111939,  3.31083782,  0.02148123,
       -0.42642425, -0.79977452,  0.36489277, 11.67551577, -0.93206453])
assert 1, eqObj(rocp(close,10),talib,5)
talib=take(double(),20).append!([-0.86136355, -0.77230955,  2.14474348,  0.46741697, -0.15489839,
       -0.81942411, -0.26512952,  7.20951332, -0.74769157,  0.98892091,
       -0.26582037,  1.90522107,  0.89317431,  0.71225552, -0.28532701,
       -0.90223144, -0.16960609,  0.13897935,  5.27781175, -0.82591267])
assert 2, eqObj(rocp(close,20),talib,5)

@testing:case="test_ta_function_rocr_null"
close =[56.84486603, 63.63574239, 17.24385137, 14.96223024, 79.31584397,
       55.19487319, 76.11299983,  8.6658699 , 23.08781124, 35.93374603,
       76.92630291, 32.72657806, , 55.27681132, 95.80582219,, 
       13.48667322, 85.25350829, 11.76174822, 27.89005755,
        7.8807707 , 14.4892506 , , 21.95583062, 67.02994747,
        9.96686312, 55.93319639, 71.14257436,  5.82524944, 71.46937892,
       56.47772433, 95.07794425,, 94.64802509, 68.46983317,
        5.71675094, 11.19925125, 97.10198567, 73.83804116,  4.85530577]
talib=take(double(),10).append!([0.35326738, -0.48572018, ,  2.69442325,  0.2079027 ,
        , -0.82280723,  8.8378477 , -0.49056461, -0.22384776,
       -0.89755428, -0.5572635 ,   , -0.60280215, -0.30035622,
        ,  3.14729381, -0.16551734, -0.50472929,  1.56253967,
        6.16652298,  5.56196424,    ,  3.31083782,  0.02148123,
       -0.42642425, -0.79977452,  0.36489277, 11.67551577, -0.93206453])
assert 1, eqObj(rocp(close,10),talib,5)
talib=take(double(),20).append!([  -0.86136355, -0.77230955, ,  0.46741697, -0.15489839,
       -0.81942411, -0.26512952,  7.20951332, -0.74769157,  0.98892091,
       -0.26582037,  1.90522107,  ,  0.71225552, -0.28532701,
       , -0.16960609,  0.13897935,  5.27781175, -0.82591267 ])
assert 2, eqObj(rocp(close,20),talib,5)

@testing:case="test_ta_function_rocp_csv"
timePeriod=10
tickTB=loadText(DATA_DIR+"/ticks1.csv")
tick1=exec rocp(close, timePeriod) from tickTB where sym=`tick1
rs1=take(double(), 8)
assert 1, eqObj(tick1, rs1, 5)

tick2=exec rocp(close, timePeriod) from tickTB where sym=`tick2
rs2=[, , , , , , , , , , , , , , , ,  0.15544761,  0.04699739, -0.00122399, -0.02173913,
        0.47864078,  0.61122244,  0.59177215,  0.52535059, -0.00273411,
       -0.00248602, -0.04264264, -0.01558603, -0.01409314,  0.1       ,
        0.06369009, -0.09328358, -0.03445991, -0.0523338 , -0.07676491,
       -0.19626168, -0.21580928, -0.20899303, -0.18769422, -0.20142602,
       -0.16234568, -0.10082305, -0.18737131, -0.18358209, -0.14773571,
       -0.11550388, -0.132     , -0.11289031, -0.14919663, -0.13690476,
       -0.18496684, -0.10678871, -0.0160473 ,  0.06581353,  0.06271777,
        0.10254163,  0.16221198,  0.13537906,  0.15827338,  0.10431034,
        0.27396022,  0.22459436,  0.19914163,  0.20754717,  0.19590164,
        0.17408585,  0.14670896,  0.1518283 ,  0.12111801,  0.14910226,
        0.0212917 , -0.00767085,  0.05511811,  0.0625    ,  0.00616861,
        0.00812458,  0.05255878,  0.04623879,  0.04293629, -0.07880435,
       -0.11396803, -0.07378777, -0.10515604, -0.15441176, -0.1239782 ,
       -0.14842176, -0.16557162, -0.1939314 , -0.19455511, -0.15339233,
       -0.10117647, -0.15174507, -0.11220622, -0.04031621, -0.08553655,
       -0.05205047, -0.06929134, -0.01636661, -0.00412201,  0.03745645 ]
assert 2, eqObj(tick2, rs2, 5)

tick3=exec rocp(close, timePeriod) from tickTB where sym=`tick3
rs3=take(double(), 5)
assert 3, eqObj(tick3, rs3,5)

tick4=exec rocp(close, timePeriod) from tickTB where sym=`tick4
rs4=[ , , , , ,  , , , , ,   0.05623902, -0.05867769, -0.03868797, -0.13602638, -0.169163  ,
       -0.10294118, -0.09991158, -0.18214286, -0.2210084 , -0.14929108,
       -0.22545757, -0.22739245, -0.15310586, -0.04484733,  0.11028632,
        0.01157184,  0.00982318,  0.15502183,  0.15210356,  0.06568627,
        0.17293233,  0.19886364,  0.04855372,  0.02297702, -0.00382044,
       -0.0171592 ,  0.01070039,  0.02362949,  0.01872659,  0.03587856,
        0.03663004,  0.03033175,  0.0226601 ,  0.03417969,  0.00287632,
       -0.04849661, -0.05486044, -0.18374885, -0.26102941, -0.23357016,
       -0.17579505, -0.14627415, -0.1194605 , -0.14730878, -0.05066922,
       -0.08868502, -0.06822811,  0.01809955,  0.03109453, -0.13093859,
       -0.21864952, -0.17349138, -0.14660832, -0.20265781, -0.26183283,
       -0.15995526, -0.26120219, -0.22555556, -0.18817853, -0.13866667,
       -0.18518519, -0.23076923, -0.2474359 , -0.14305556, -0.07366985,
       -0.1011984 , -0.02366864, -0.04017217,  0.04160475,  0.12383901,
        0.20707071,  0.17118644,  0.26916525,  0.26094003,  0.11782032,
        0.08148148,  0.13636364,  0.11509716,  0.02853067, -0.0137741 ,
       -0.08228731, -0.03907381, -0.10738255, -0.13753213, -0.10408432,
        0.02465753, -0.012     , -0.05630027, -0.06380028, -0.04888268 ]
assert 4, eqObj(tick4, rs4, 5)

tick5=exec rocp(close, timePeriod) from tickTB where sym=`tick5
rs5=[   ,   ,   ,   ,   ,  ,   ,   ,   ,   ,  -0.04794521, -0.0543162 , -0.01273262, -0.10028653, -0.13557594,
       -0.11752988, -0.10696266, -0.08316222, -0.17198764, -0.18081918,
       -0.15107914, -0.16717949, -0.24404762, -0.11146497, -0.00471698,
       -0.04288939, -0.0259887 , -0.05039194,  0.08706468,  0.07804878,
        0.04479419,  0.10344828,  0.19028871,  0.00955795,  0.00473934,
        0.02240566,  0.01276102,  0.03773585,  0.04347826,  0.0361991 ,
        0.06604867,  0.03683036,  0.00992282,  0.06627219,  0.11438679,
        0.04844291, -0.00229095, -0.02386364, -0.1502193 , -0.22816594,
       -0.1923913 , -0.16038751, -0.1430131 , -0.15538291, -0.16613757,
       -0.14191419, -0.16073479, -0.12456345, -0.07096774, -0.02687412,
       -0.07940781, -0.10128205, -0.05732484, -0.00788436, -0.12436548,
       -0.09358974, -0.00273598, -0.1037234 , -0.04305556, -0.03197674,
       -0.11403509, -0.20256776, -0.23918919, -0.29139073, -0.1942029 ,
       -0.13437058, -0.1659808 , -0.11275964, -0.11756168, -0.06006006,
        0.06435644,  0.18067979,  0.11900533,  0.19626168,  0.1205036 ,
        0.02614379,  0.13651316,  0.27090301,  0.21217105,  0.12939297,
        0.20620155,  0.23030303,  0.27142857,  0.15625   ,  0.18619583,
        0.13535032,  0.04196816, -0.04736842, -0.04884668,  0.00707214 ]
assert 5, eqObj(tick5, rs5, 5)

rocpBySym=(exec rocp(close, timePeriod) from tickTB context by sym).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(rocpBySym, rs, 5)
