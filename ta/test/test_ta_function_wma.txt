#include "setup/settings.txt"
use ta

precision=5
nan=double()
@testing:case="test_ta_function_wma_use_ticksxtby"
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec ta::wma(close,10) from tickTB where sym=`tick1
rs1=[nan, nan, nan, nan, nan, nan, nan, nan]
assert 1, eqObj(tick1, rs1, precision)

tick2=exec ta::wma(close,10) from tickTB where sym=`tick2
rs2=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
       12.74727273, 13.38436364, 13.86981818, 14.39309091, 14.73127273,
       15.06290909, 15.45945455, 15.56509091, 15.396     , 15.22018182,
       15.31054545, 15.38163636, 15.43836364, 15.55418182, 15.80872727,
       15.92090909, 15.72090909, 15.54636364, 15.16854545, 14.81690909,
       14.382     , 13.93163636, 13.542     , 13.31781818, 13.21581818,
       13.19909091, 13.14654545, 12.88981818, 12.51909091, 12.29127273,
       12.08690909, 11.80781818, 11.60054545, 11.42618182, 11.37454545,
       11.25818182, 11.30563636, 11.36763636, 11.43490909, 11.58727273,
       11.79563636, 11.98818182, 12.14327273, 12.32563636, 12.46327273,
       12.81163636, 13.15036364, 13.374     , 13.57545455, 13.82563636,
       14.06509091, 14.20836364, 14.32345455, 14.39472727, 14.48854545,
       14.48763636, 14.45218182, 14.51145455, 14.59672727, 14.61509091,
       14.67      , 14.78272727, 14.87072727, 14.92836364, 14.702     ,
       14.34945455, 14.10490909, 13.88127273, 13.58763636, 13.37418182,
       13.16109091, 12.99181818, 12.78109091, 12.60745455, 12.36890909,
       12.16454545, 11.93272727, 11.83363636, 11.83963636, 11.78581818,
       11.79927273, 11.78836364, 11.82981818, 11.88581818, 11.91181818]
assert 2, eqObj(tick2, rs2, precision)

tick3=exec ta::wma(close,10) from tickTB where sym=`tick3
rs3=[nan, nan, nan, nan, nan]
assert 3, eqObj(tick3, rs3,precision)

tick4=exec ta::wma(close,10) from tickTB where sym=`tick4
rs4=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan, 11.66636364,
       11.728     , 11.66345455, 11.61909091, 11.41036364, 11.04072727,
       10.87690909, 10.70018182, 10.35854545, 10.074     , 10.00636364,
        9.80945455,  9.56909091,  9.53581818,  9.59436364,  9.74509091,
        9.88054545,  9.97563636, 10.12345455, 10.26363636, 10.41272727,
       10.55872727, 10.60818182, 10.55309091, 10.50581818, 10.48890909,
       10.45090909, 10.43072727, 10.48854545, 10.55090909, 10.67872727,
       10.81036364, 10.85290909, 10.80054545, 10.78218182, 10.73381818,
       10.56672727, 10.41054545, 10.08654545,  9.65327273,  9.37890909,
        9.27963636,  9.20745455,  9.13872727,  9.07254545,  9.19836364,
        9.15381818,  9.16327273,  9.15763636,  9.02      ,  8.73418182,
        8.43072727,  8.23345455,  8.08909091,  7.86      ,  7.68781818,
        7.59563636,  7.39309091,  7.27218182,  7.14454545,  6.99618182,
        6.77218182,  6.56545455,  6.38545455,  6.29509091,  6.33618182,
        6.37981818,  6.41      ,  6.45945455,  6.57218182,  6.72527273,
        6.84745455,  6.9       ,  7.03236364,  7.196     ,  7.29581818,
        7.32836364,  7.38727273,  7.42254545,  7.39836364,  7.36145455,
        7.22090909,  7.102     ,  6.98981818,  6.90309091,  6.85218182,
        6.93927273,  7.01036364,  7.01581818,  6.97618182,  6.95581818]
assert 4, eqObj(tick4, rs4, precision)

tick5=exec ta::wma(close,10) from tickTB where sym=`tick5
rs5=[       nan,        nan,        nan,        nan,        nan,
              nan,        nan,        nan,        nan, 9.95309091,
       9.89618182, 9.85181818, 9.87763636, 9.78581818, 9.54218182,
       9.39181818, 9.26109091, 9.16418182, 8.92018182, 8.73563636,
       8.59490909, 8.45545455, 8.25472727, 8.23509091, 8.24727273,
       8.26745455, 8.32      , 8.35127273, 8.438     , 8.53018182,
       8.57254545, 8.66818182, 8.76854545, 8.72981818, 8.69509091,
       8.69418182, 8.70072727, 8.718     , 8.78763636, 8.85763636,
       8.92909091, 9.00654545, 9.05436364, 9.07327273, 9.162     ,
       9.16763636, 9.09654545, 9.004     , 8.76254545, 8.42236364,
       8.18563636, 8.04836364, 7.94727273, 7.82636364, 7.78      ,
       7.74763636, 7.64963636, 7.61527273, 7.54218182, 7.42090909,
       7.29581818, 7.21236364, 7.21418182, 7.25145455, 7.17163636,
       7.14054545, 7.16272727, 7.08527273, 7.04927273, 6.97709091,
       6.79981818, 6.55127273, 6.33581818, 6.10163636, 5.94563636,
       5.91581818, 5.896     , 5.88      , 5.896     , 5.95945455,
       6.06472727, 6.19018182, 6.24272727, 6.30127273, 6.30981818,
       6.31527273, 6.43236364, 6.65981818, 6.816     , 6.89418182,
       7.08672727, 7.31690909, 7.49945455, 7.54      , 7.56054545,
       7.51272727, 7.46218182, 7.41363636, 7.32981818, 7.27254545]
assert 5, eqObj(tick5,rs5, 3)

maBySym=(exec ta::wma(close,10) from tickTB context by sym ).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(maBySym, rs, 3)

@testing:case="test_ta_function_wma"
x=[89.79,11.58,99.9,81.11,84.69,31.38,60.9,83.3,97.26,98.67]
validate=[ ,, 68.775  , 75.785  , 86.03166667, 57.43833333, 55.025  , 67.18 , 86.54666667, 95.63833333]
assert 1,eqObj(ta::wma(x,3),validate,6)

validate=[,,,, 77.36933333,63.358, 63.08066667, 66.982, 76.64333333, 85.698]
assert 2,eqObj(ta::wma(x,5),validate,6)