#include "setup/settings.txt"
use ta

precision=5
nan=double()
@testing:case="test_ta_function_trima_use_ticksxtby"
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec ta::trima(close,10) from tickTB where sym=`tick1
rs1=[nan, nan, nan, nan, nan, nan, nan, nan]
assert 1, eqObj(tick1, rs1, precision)

tick2=exec ta::trima(close,10) from tickTB where sym=`tick2
rs2=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
       12.30366667, 12.10733333, 12.27733333, 12.877     , 13.73466667,
       14.59733333, 15.248     , 15.64466667, 15.75      , 15.59666667,
       15.44833333, 15.324     , 15.242     , 15.25666667, 15.41866667,
       15.60933333, 15.72733333, 15.80933333, 15.77833333, 15.57033333,
       15.17766667, 14.71066667, 14.21966667, 13.75833333, 13.38566667,
       13.14733333, 13.03933333, 12.979     , 12.917     , 12.80066667,
       12.61333333, 12.32833333, 11.99766667, 11.69466667, 11.46666667,
       11.29233333, 11.21866667, 11.23933333, 11.30333333, 11.38133333,
       11.506     , 11.67233333, 11.841     , 12.03133333, 12.224     ,
       12.447     , 12.677     , 12.92333333, 13.17866667, 13.45266667,
       13.729     , 13.959     , 14.14866667, 14.304     , 14.42366667,
       14.47133333, 14.48866667, 14.51033333, 14.532     , 14.54033333,
       14.561     , 14.62733333, 14.71533333, 14.79833333, 14.82666667,
       14.785     , 14.65866667, 14.43366667, 14.11433333, 13.76833333,
       13.45733333, 13.20166667, 12.98166667, 12.81      , 12.67266667,
       12.518     , 12.315     , 12.111     , 11.93966667, 11.795     ,
       11.715     , 11.697     , 11.74      , 11.798     , 11.86066667]
assert 2, eqObj(tick2, rs2, precision)

tick3=exec ta::trima(close,10) from tickTB where sym=`tick3
rs3=[nan, nan, nan, nan, nan]
assert 3, eqObj(tick3, rs3,precision)

tick4=exec ta::trima(close,10) from tickTB where sym=`tick4
rs4=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan, 11.63166667,
       11.61733333, 11.59966667, 11.616     , 11.608     , 11.52233333,
       11.36033333, 11.14266667, 10.84666667, 10.50266667, 10.23166667,
       10.01066667,  9.79866667,  9.64433333,  9.59033333,  9.58566667,
        9.59466667,  9.68833333,  9.858     , 10.03266667, 10.196     ,
       10.36466667, 10.503     , 10.57766667, 10.60766667, 10.60066667,
       10.56      , 10.49966667, 10.453     , 10.442     , 10.47333333,
       10.553     , 10.669     , 10.77533333, 10.84933333, 10.87533333,
       10.82333333, 10.70266667, 10.51466667, 10.25666667,  9.94733333,
        9.64866667,  9.38233333,  9.161     ,  9.024     ,  9.01533333,
        9.05466667,  9.10566667,  9.17      ,  9.19966667,  9.11533333,
        8.93266667,  8.71366667,  8.459     ,  8.17266667,  7.90533333,
        7.72633333,  7.572     ,  7.43933333,  7.331     ,  7.23      ,
        7.08233333,  6.89866667,  6.70866667,  6.52766667,  6.37333333,
        6.275     ,  6.25233333,  6.28566667,  6.38366667,  6.516     ,
        6.65133333,  6.77      ,  6.89066667,  7.00966667,  7.11166667,
        7.20233333,  7.29866667,  7.385     ,  7.427     ,  7.429     ,
        7.396     ,  7.33      ,  7.21733333,  7.08766667,  6.965     ,
        6.88666667,  6.858     ,  6.871     ,  6.91233333,  6.97066667]
assert 4, eqObj(tick4, rs4, precision)

tick5=exec ta::trima(close,10) from tickTB where sym=`tick5
rs5=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan, 10.02966667,
        9.96566667,  9.90233333,  9.86366667,  9.831     ,  9.77266667,
        9.67866667,  9.565     ,  9.41833333,  9.21433333,  9.01066667,
        8.838     ,  8.67      ,  8.48833333,  8.356     ,  8.27766667,
        8.216     ,  8.191     ,  8.219     ,  8.303     ,  8.38933333,
        8.47266667,  8.56      ,  8.65033333,  8.70233333,  8.73      ,
        8.74566667,  8.74866667,  8.73133333,  8.71666667,  8.73433333,
        8.78166667,  8.84633333,  8.93066667,  9.02033333,  9.09733333,
        9.148     ,  9.16166667,  9.13766667,  9.05966667,  8.906     ,
        8.68733333,  8.442     ,  8.19133333,  7.955     ,  7.78766667,
        7.712     ,  7.67533333,  7.658     ,  7.65166667,  7.61666667,
        7.52266667,  7.40633333,  7.30233333,  7.221     ,  7.154     ,
        7.128     ,  7.14333333,  7.14666667,  7.132     ,  7.09766667,
        7.029     ,  6.896     ,  6.71666667,  6.508     ,  6.28466667,
        6.07133333,  5.908     ,  5.813     ,  5.77933333,  5.82033333,
        5.909     ,  6.013     ,  6.11133333,  6.20866667,  6.28066667,
        6.32366667,  6.366     ,  6.43433333,  6.52433333,  6.63166667,
        6.79      ,  6.99433333,  7.202     ,  7.36733333,  7.511     ,
        7.605     ,  7.61833333,  7.56566667,  7.48633333,  7.397     ]
assert 5, eqObj(tick5,rs5, 3)

maBySym=(exec ta::trima(close,10) from tickTB context by sym ).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(maBySym, rs, 3)

@testing:case="test_ta_function_trima"
x=[89.79,11.58,99.9,81.11,84.69,31.38,60.9,83.3,97.26,98.67]
validate=[,, 53.2125, 73.1225, 86.7025, 70.4675, 52.0875,59.12  , 81.19  , 94.1225]
assert 1,eqObj(ta::trima(x,3)[2:],validate[2:],6)

validate=[,,, 65.64333333, 76.38166667,77.14666667, 62.35833333, 58.75833333, 69.50666667, 86.78166667]
assert 2,eqObj(ta::trima(x,4)[3:],validate[3:],6)