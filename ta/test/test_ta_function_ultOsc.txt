#include "setup/settings.txt"
use ta

precision=5
nan=double()
@testing:case="test_ta_function_ultOsc_use_ticks1_contextby"
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec ta::ultOsc(high,low,close,7,14,28) from tickTB where sym=`tick1
rs1=[nan, nan, nan, nan, nan, nan, nan, nan]
assert 1, eqObj(tick1, rs1, precision)

tick2=exec ta::ultOsc(high,low,close,7,14,28) from tickTB where sym=`tick2
rs2=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan, 43.44004643,
       32.43866883, 30.61755768, 34.69723018, 42.99024587, 40.72875668,
       43.8626101 , 44.6307717 , 39.66267265, 33.6447059 , 37.19281438,
       32.41785108, 30.31666268, 31.39541812, 34.18879186, 46.36196632,
       47.62451445, 47.9644432 , 49.2217108 , 49.08972354, 50.93589752,
       55.05085333, 50.78036851, 53.91030788, 53.59680304, 57.4868496 ,
       64.86291524, 67.94700386, 63.02077842, 62.02773006, 64.56808441,
       63.27310508, 62.47684856, 52.8607119 , 49.71345361, 53.69550963,
       50.17946831, 49.76740288, 51.02216169, 52.39256487, 48.70391817,
       55.10278675, 54.62524408, 60.92195829, 58.55898517, 41.24691419,
       35.69148218, 42.60871597, 41.19653272, 34.94161903, 38.16276836,
       36.93078858, 41.25618022, 43.45338115, 35.4216538 , 28.10430838,
       31.42931957, 29.28829617, 35.24888812, 43.83021921, 43.99592325,
       46.36645536, 49.32970814, 53.85549808, 55.12695604, 51.66702046]
assert 2, eqObj(tick2, rs2, precision)

tick3=exec ta::ultOsc(high,low,close,7,14,28) from tickTB where sym=`tick3
rs3=[nan, nan, nan, nan, nan]
assert 3, eqObj(tick3, rs3,precision)

tick4=exec ta::ultOsc(high,low,close,7,14,28) from tickTB where sym=`tick4
rs4=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan, 65.89182149, 55.80776196,
       56.12832585, 52.44834322, 44.08710582, 44.06257686, 45.42644228,
       44.17921773, 45.41212475, 46.5928005 , 52.59426733, 64.52392439,
       72.82282434, 65.75906065, 61.31720433, 63.76008245, 56.95568533,
       53.11012406, 51.61952205, 36.95337717, 33.18354205, 38.96172835,
       45.58728338, 46.60657312, 45.1784302 , 42.68353028, 51.93524543,
       50.68809263, 52.85688525, 49.50451337, 45.96436369, 43.21268876,
       44.47397507, 44.00517959, 51.15001584, 41.35912714, 39.11254449,
       42.32605812, 42.67500888, 47.55484918, 38.89006335, 35.98486632,
       34.87848436, 28.72142669, 33.08159939, 44.01893213, 46.87424454,
       46.95862715, 48.34899534, 54.12788271, 61.7270485 , 61.76809724,
       60.91785419, 49.70871331, 60.02026271, 63.67577236, 64.47313598,
       60.60429865, 60.63849317, 57.72315595, 56.16214673, 49.08945951,
       39.86328525, 45.92049051, 47.55779824, 45.46735368, 48.78504054,
       58.85997143, 59.67348892, 61.73871121, 56.71788296, 59.31787469]
assert 4, eqObj(tick4, rs4, precision)

tick5=exec ta::ultOsc(high,low,close,7,14,28) from tickTB where sym=`tick5
rs5=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan, 58.36757339, 62.35379641,
       50.8336853 , 53.26367858, 54.36886287, 44.55234623, 44.53967765,
       46.27813991, 46.65238207, 47.72634687, 48.39548361, 48.83066219,
       61.51613562, 58.27590709, 52.93750099, 53.05051476, 59.79524311,
       47.00021391, 46.21510678, 43.63502704, 37.9654108 , 33.01142699,
       34.81747234, 38.85475771, 40.7459995 , 37.91125847, 43.30069824,
       47.34116569, 48.52283771, 51.59289759, 42.69811905, 42.92027482,
       47.10763873, 43.87466214, 52.55199517, 58.12971516, 46.75391186,
       50.68214907, 54.34138848, 49.49351159, 50.12542676, 42.69035628,
       37.46963946, 36.92782377, 33.88108016, 33.58278333, 39.58626449,
       43.96674466, 43.26731716, 47.99447313, 55.78679191, 59.66920402,
       63.7315256 , 65.83727786, 49.90347972, 58.62914539, 59.80556145,
       62.15883598, 68.13782632, 73.2276597 , 60.70747981, 62.08005835,
       65.8815397 , 64.14041798, 55.03718965, 46.66976042, 41.49569042,
       43.04888558, 44.73043164, 37.22677234, 37.08189738, 43.87816184]
assert 5, eqObj(tick5,rs5, 3)

maBySym=(exec ta::ultOsc(high,low,close,7,14,28) from tickTB context by sym ).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(maBySym, rs, 3)

@testing:case="test_ta_function_ultosc"
close=[1,2,3,3.5,3.6,3,2,1,10,9,8,1,2,3,5,3,2,4,1,2,9,6.7,100,10,20].take(50)
high=[2,12,13,6.5,6.6,13,21,12,110,19,8,11,12,23,5,13,21,14,11,3,19,11.7,101,11,25].take(50)
low=[0.1,0.2,0.3,3.5,1.6,1.3,1,0,6,2,5,0,1.2,1.3,3,3,1.2,0,1,2,0.9,2.7,60,9,15].take(50)
volume = [10.0,20,30,30,60,30,20,10,10,90,80,10,20,30,50,30,20,40,10,20,90,60,100,10,10].take(50)
x = ultOsc(high, low, close, 7, 14, 28)
y = [40.42824454, 22.25060142,
       29.8776638 , 22.38411519, 23.14462221, 18.39835704, 19.72418581,
       20.6259305 , 14.99625913, 15.77694836, 14.78553071, 15.99065295,
       19.4602771 , 14.26652309, 14.3464141 , 13.49869263, 14.36908754,
       20.38427348, 21.23845131, 58.43918644, 42.46050563, 44.10036604]
assert 1, eqObj(x[28:], y, 6)
