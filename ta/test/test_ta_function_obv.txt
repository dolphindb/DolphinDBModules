#include "setup/settings.txt"
use ta

precision=5
nan=double()
@testing:case="test_ta_function_obv_use_ticks1_contextby"
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec ta::obv(close, vol) from tickTB where sym=`tick1
rs1=[ 36811.51,  82075.88,  43651.37,  72869.6 ,  32372.57,  77603.11,
       188811.22, 246654.4 ]
assert 1, eqObj(tick1, rs1, precision)

tick2=exec ta::obv(close, vol) from tickTB where sym=`tick2
rs2=[       nan,        nan,        nan,        nan,        nan,
              nan,   37949.07,   74898.14,  110847.21,   72998.14,
         34999.07,    3076.52,  -30666.2 ,  -98437.88,  312403.16,
        629923.32,  970411.84,  740935.53, 1026537.59,  818647.78,
        689648.01,  935919.78,  743504.95,  585980.2 ,  731224.07,
        972936.31,  714245.46,  557962.9 ,  732868.69, 1015095.72,
        863622.57,  698412.15,  556000.47,  421153.09,  563117.28,
        452669.49,  291177.36,  212998.04,  335922.81,  518295.84,
        695536.7 ,  572750.67,  446258.96,  360371.84,  471890.27,
        329894.98,  227052.67,  311563.73,  365362.82,  469307.35,
        391626.84,  527143.17,  399981.29,  489923.19,  720665.25,
        877668.26, 1044801.28,  943013.35, 1059664.08,  965859.53,
       1244111.65, 1498189.61, 1374587.56, 1515666.63, 1714675.67,
       1872259.14, 1743336.02, 1874267.62, 1747063.72, 1897986.03,
       1743696.32, 1671850.28, 1765451.73, 1865534.19, 1773151.44,
       1859960.55, 2004231.94, 1908796.16, 1830761.88, 1678624.82,
       1571398.31, 1653457.7 , 1711639.66, 1660783.98, 1712322.31,
       1680759.5 , 1754150.87, 1703647.34, 1672922.5 , 1623075.3 ,
       1574794.43, 1529835.24, 1585053.62, 1673620.09, 1630893.04,
       1694872.48, 1649880.37, 1709760.76, 1773753.2 , 1729447.36]
assert 2, eqObj(tick2, rs2, precision)

tick3=exec ta::obv(close, vol) from tickTB where sym=`tick3
rs3=[ 41878.22,   5942.78,  44238.61,   6391.24, -45558.75]
assert 3, eqObj(tick3, rs3,precision)

tick4=exec ta::obv(close, vol) from tickTB where sym=`tick4
rs4=[ 41985.85, 107457.99,  59555.07, 109258.85,  60420.34,  93208.52,
        52736.22,  24473.53,  79381.87, 136570.87, 185631.35, 149846.68,
       167733.52, 136945.31, 111914.6 , 152757.01, 123198.08,  95036.69,
       108158.02, 166823.58, 130705.8 , 109540.89, 128791.22, 168720.69,
       232164.72, 267351.62, 249977.81, 273504.49, 299764.72, 336737.04,
       363164.69, 334315.54, 313844.04, 332543.74, 347502.14, 331817.12,
       344686.57, 368348.23, 397517.65, 436052.5 , 504648.61, 472939.83,
       451147.71, 464418.18, 450367.77, 434267.65, 443536.33, 430413.9 ,
       415484.48, 434052.29, 460364.56, 429635.89, 417252.2 , 405684.99,
       449672.46, 398295.25, 419347.64, 403147.8 , 388557.34, 371342.69,
       355307.19, 367649.51, 382247.56, 367597.47, 378228.57, 387418.95,
       366458.56, 383424.13, 371201.45, 362151.05, 351553.62, 339240.04,
       329748.3 , 345208.37, 386530.69, 359009.  , 347512.25, 360645.64,
       386204.53, 419939.86, 393667.73, 369114.97, 418017.69, 513963.36,
       478731.33, 449446.87, 468885.86, 450429.63, 433556.85, 425050.54,
       410908.71, 435009.28, 450937.03, 473278.26, 495698.7 , 554808.12,
       506156.47, 477428.78, 453007.44, 470597.81]
assert 4, eqObj(tick4, rs4, precision)

tick5=exec ta::obv(close, vol) from tickTB where sym=`tick5
rs5=[168471.11, 308993.26, 226255.33, 310783.92, 221440.02, 274194.42,
       220688.34, 171708.71, 123882.82, 180262.41, 144189.23, 193787.59,
       258293.36, 206711.24, 161310.69, 209167.64, 160112.07, 196820.3 ,
       162743.51, 186279.35, 206860.91, 187256.21, 159354.59, 189909.23,
       216758.84, 238579.18, 253633.19, 236103.76, 264431.22, 287085.8 ,
       263913.7 , 300160.12, 373350.87, 330237.47, 354777.41, 372506.9 ,
       393998.88, 416423.54, 451475.07, 493753.82, 526655.71, 577877.53,
       546404.91, 523751.31, 569843.27, 533956.22, 505898.53, 491416.12,
       469479.03, 442968.89, 461397.94, 488999.31, 513780.51, 495478.34,
       508963.4 , 498496.23, 485163.47, 498965.29, 488542.11, 463778.35,
       438046.57, 458773.91, 484030.56, 518779.76, 496032.42, 508689.05,
       527712.44, 513433.12, 520591.88, 512527.37, 494254.86, 479210.69,
       501248.19, 485715.23, 510282.99, 558929.14, 525743.42, 505585.41,
       520723.61, 543894.55, 574442.48, 610621.47, 546348.66, 571752.3 ,
       547995.34, 568720.13, 621576.12, 695448.52, 465801.19, 396405.34,
       469431.12, 695780.01, 567595.4 , 501103.98, 452782.17, 409899.44,
       440347.53, 486756.54, 447786.09, 482173.68]
assert 5, eqObj(tick5,rs5, 3)

maBySym=(exec ta::obv(close, vol) from tickTB context by sym ).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(maBySym, rs, 3)

@testing:case="test_ta_function_obv"
close=[1.31096941, 1.30264238, 1.61113023, 1.74477774, 1.19229174,
       1.18422834, 1.22975697, 0.90955086, 0.74515876, 1.60267403,
       1.09760499, 1.91491583, 1.44797879, 0.92671249, 1.650166  ,
       1.30611495, 1.80538802, 1.91171602, 1.08399228, 1.43340616,
       1.00901357, 0.52186359, 1.71815048, 1.21787024, 1.10927426,
       0.78267631, 1.6849011 , 1.32163081, 0.79079304, 1.7044885 ,
       1.03517974, 1.40655617, 0.97886921, 1.19654829, 1.10061065,
       0.88445782, 1.08063318, 1.7860779 , 1.65480217, 1.50524881,
       1.14990589, 1.58424086, 1.51309666, 0.74424052, 1.52159503,
       0.90795193, 1.96280945, 1.57893685, 1.00704181, 1.56333563]
volume=1..50
x = obv(close, volume)
y = [   1.,   -1.,    2.,    6.,    1.,   -5.,    2.,   -6.,  -15.,
         -5.,  -16.,   -4.,  -17.,  -31.,  -16.,  -32.,  -15.,    3.,
        -16.,    4.,  -17.,  -39.,  -16.,  -40.,  -65.,  -91.,  -64.,
        -92., -121.,  -91., -122.,  -90., -123.,  -89., -124., -160.,
       -123.,  -85., -124., -164., -205., -163., -206., -250., -205.,
       -251., -204., -252., -301., -251.]

assert 1, eqObj(x, y, 6)
