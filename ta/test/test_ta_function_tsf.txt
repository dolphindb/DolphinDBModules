
#include "setup/settings.txt"

use ta

//tsf(close, timeperiod=14)

@testing:case="test_ta_function_tsf"
x=[89.79,11.58,99.9,81.11,84.69,31.38,60.9,83.3,97.26,98.67]

validate=[ , , , ,  91.213,  69.049,  33.277,  62.453,  94.624, 125.584]
assert 1,eqObj(ta::tsf(x,5),validate,6)

validate=[ , , , , ,  57.25733333,  66.05533333,  53.85266667,  83.71666667, 105.02733333]
assert 2,eqObj(ta::tsf(x,6),validate,6)

validate=[ , , , , , , 56.72428571, 77.18428571, 73.03,       95.29285714]
assert 3,eqObj(ta::tsf(x,7),validate,6)

close=[5.18,71.01,76.28,5.92,52.97,16.45,92.88,7.37,79.39,15.82]
t=table(take(`A`B,10) as sym,close)
re=exec ta::tsf(close,5) from t
validate=[ , , , , 51.419,  4.797, 62.019, 47.961, 62.94,  37.957]
assert 4,eqObj(re,validate,6)

@testing:case="test_ta_function_tsf_context_by"
tick = loadText(DATA_DIR + "/ticks1.csv")
res = select sym, ta::tsf(close, 10) as tsf from tick context by sym 
tick1 = exec tsf from res where sym = `tick1
validate1 = take(double(), 8)
assert 1, eqObj(tick1, validate1, 6)
tick2 = exec tsf from res where sym = `tick2
validate2 = [ , , , , , ,
  , , , , , ,
  , , , 11.684,      13.42266667, 15.01066667,
 16.93466667, 18.26533333, 18.16666667, 17.994,      16.88533333, 14.96666667,
 14.33266667, 14.67466667, 15.12466667, 15.39933333, 15.88533333, 16.41066667,
 16.56333333, 16.23,       15.72866667, 14.54066667, 13.55,       12.79533333,
 12.06133333, 11.51266667, 11.496,      12.026,      12.666,      12.86533333,
 12.652,      11.94866667, 11.644,      11.292,      10.70866667, 10.32466667,
 10.20533333, 10.50666667, 10.74933333, 11.29666667, 11.57466667, 11.62933333,
 11.996,      12.448,      12.68466667, 12.85333333, 13.05266667, 13.23466667,
 13.704,      14.24466667, 14.446,      14.53933333, 14.81933333, 15.11333333,
 15.14533333, 15.058,      14.90333333, 14.738,      14.65466667, 14.554,
 14.566,      14.644,      14.68733333, 14.85666667, 15.06733333, 15.21133333,
 15.25733333, 14.73666667, 13.88133333, 13.26466667, 12.858,      12.39733333,
 12.1,        11.908,      11.95933333, 11.97066667, 12.11533333, 11.79533333,
 11.39,       11.07333333, 11.10466667, 11.26266667, 11.35866667, 11.584,
 11.77866667, 11.984,      12.20266667, 12.18333333]
assert 2, eqObj(tick2, validate2, 6)
tick3 = exec tsf from res where sym = `tick3
validate3 = take(double(),5)
assert 3, eqObj(tick3, validate3, 6)
tick4 = exec tsf from res where sym = `tick4
validate4 = [ , , , , , , , , , 11.62733333, 11.68266667, 11.63533333,
 11.59533333, 11.27,       10.42666667, 10.14333333,  9.79666667,  9.088,
  8.746,       8.97533333,  8.976,       8.78533333,  9.13,        9.47,
  9.74533333, 10.21,       10.532,      10.69533333, 10.83333333, 11.20133333,
 11.30733333, 11.022,      10.69466667, 10.46,       10.40866667, 10.31733333,
 10.214 ,     10.35933333, 10.53466667, 10.89933333, 11.27533333, 11.346,
 11.09266667, 10.932,      10.74666667, 10.26733333,  9.84666667,  9.18933333,
  8.358,       8.05333333,  8.22,        8.37933333,  8.458,       8.63133333,
  9.234,       9.30266667,  9.516,       9.45266667,  8.88133333,  8.13466667,
  7.566,       7.272,       7.1 ,        6.748,       6.81   ,     6.85333333,
  6.748,       6.846,       6.794,       6.52733333,  6.066,       5.78,
  5.63466667,  5.578,       5.87266667,  6.23533333,  6.38866667,  6.64466667,
  6.98333333,  7.33133333,  7.45133333,  7.37466667,  7.43866667,  7.60933333,
  7.762,       7.73466667,  7.71066667,  7.63466667,  7.49266667 , 7.384,
  7.026,       6.662,       6.464,       6.43133333,  6.45533333,  6.72666667,
  7.01133333,  7.14333333,  7.12066667,  7.13933333]
assert 4, eqObj(tick4, validate4, 6)
tick5 = exec tsf from res where sym = `tick5
validate5 = [ , , , , , , , , , 9.71333333, 9.63533333, 9.622,
 9.75133333, 9.69466667, 9.156,      8.91933333, 8.72266667, 8.58333333,
 8.134,      7.94,       7.816,      7.73933333, 7.65933333, 7.86733333,
 7.92266667, 8.098,      8.352,      8.58666667, 8.718,      8.88533333,
 8.942,      9.06866667, 9.05,       8.88666667, 8.74866667, 8.69466667,
 8.68933333, 8.66733333, 8.82133333, 8.99266667, 9.10266667, 9.29866667,
 9.45,       9.37,       9.43666667, 9.34533333, 9.09,       8.80666667,
 8.28666667, 7.59666667, 7.20066667, 7.09466667, 7.07333333, 7.00333333,
 7.252,      7.47733333, 7.49133333, 7.65066667, 7.52933333, 7.13533333,
 6.834,      6.73866667, 6.86533333, 7.018,      6.98666667, 7.06733333,
 7.154,      7.078,      7.02866667, 6.82266667, 6.38066667, 5.848,
 5.53,       5.258,      5.04333333, 5.18733333, 5.43733333, 5.58133333,
 5.856,      6.19533333, 6.47733333, 6.668,      6.682,      6.61666667,
 6.46933333, 6.44666667, 6.65466667, 7.05666667, 7.28533333, 7.356,
 7.70733333, 8.146,      8.35933333, 8.24133333, 8.00733333, 7.60533333,
 7.34266667, 7.26066667, 7.04933333, 6.826     ]
assert 5, eqObj(tick5, validate5, 6)
