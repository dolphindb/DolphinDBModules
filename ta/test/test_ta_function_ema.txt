#include "setup/settings.txt"
use ta

precision=5
nan=double()
@testing:case="test_ta_function_ema_use_ticks_specify_timeperiod=10_contextby"
timePeriod=10
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec ta::ema(close, timePeriod) from tickTB where sym=`tick1
rs1=[nan, nan, nan, nan, nan, nan, nan, nan]
assert 1, eqObj(tick1, rs1, precision)

tick2=exec ta::ema(close, timePeriod) from tickTB where sym=`tick2
rs2=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
       13.146     , 13.78309091, 14.19343802, 14.58008565, 14.71097917,
       14.80534659, 15.03710176, 15.04671962, 14.88186151, 14.82879578,
       15.05083291, 15.21249965, 15.31749972, 15.45795431, 15.70741717,
       15.79697768, 15.57570901, 15.39285283, 15.03051595, 14.74678578,
       14.41100654, 14.06355081, 13.77745066, 13.64882327, 13.6108554 ,
       13.60342715, 13.51371312, 13.20940164, 12.79678316, 12.55736804,
       12.34875567, 12.07625464, 11.89511743, 11.75418699, 11.72615299,
       11.60503427, 11.62411895, 11.62882459, 11.63449285, 11.73731233,
       11.89052827, 12.02134131, 12.12291562, 12.26056732, 12.36046417,
       12.67492523, 12.9776661 , 13.15809045, 13.32571036, 13.55558121,
       13.77638462, 13.90067833, 14.00782772, 14.0864045 , 14.20160368,
       14.23585756, 14.23479255, 14.32664845, 14.44180328, 14.48511177,
       14.55872781, 14.67895912, 14.7664211 , 14.81979908, 14.5907447 ,
       14.25606385, 14.06041587, 13.90215844, 13.67449327, 13.52640359,
       13.37251202, 13.25023711, 13.06292127, 12.89329922, 12.63633573,
       12.4224565 , 12.19655532, 12.10809072, 12.11389241, 12.04954833,
       12.04417591, 12.00341665, 12.00643181, 12.01980784, 11.99984278]
assert 2, eqObj(tick2, rs2, precision)

tick3=exec ta::ema(close, timePeriod) from tickTB where sym=`tick3
rs3=[nan, nan, nan, nan, nan]
assert 3, eqObj(tick3, rs3,precision)

tick4=exec ta::ema(close, timePeriod) from tickTB where sym=`tick4
rs4=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan, 11.681     ,
       11.74263636, 11.67852066, 11.63333509, 11.4236378 , 11.0611582 ,
       10.93549307, 10.79813069, 10.50028875, 10.27659989, 10.26267263,
       10.08945943,  9.85501226,  9.82319185,  9.85715697,  9.96858297,
       10.06338607, 10.10277042, 10.18953943, 10.27871408, 10.38622061,
       10.48327141, 10.49540388, 10.43260318, 10.39758442, 10.40347816,
       10.38648213, 10.38712174, 10.46764506, 10.54261869, 10.67305165,
       10.79067863, 10.80510069, 10.72780966, 10.70275336, 10.65861638,
       10.5043225 , 10.37990022, 10.09991836,  9.72538775,  9.52622634,
        9.49054883,  9.45226722,  9.39549136,  9.32903839,  9.43830414,
        9.34770338,  9.31175731,  9.25507417,  9.07960614,  8.79240502,
        8.51924047,  8.36483311,  8.26213618,  8.06902051,  7.93465315,
        7.85744348,  7.65790831,  7.53283407,  7.38686424,  7.21834347,
        6.98591738,  6.78847786,  6.62148188,  6.53939427,  6.58495895,
        6.61496641,  6.61224525,  6.62638247,  6.69613111,  6.79865273,
        6.86617042,  6.87413943,  6.97884135,  7.12450656,  7.20914173,
        7.22566142,  7.27554116,  7.30907913,  7.29106474,  7.26723479,
        7.14228301,  7.05095883,  6.97805722,  6.92931954,  6.9058069 ,
        7.01020565,  7.08289553,  7.07509634,  7.01598792,  6.97853557]
assert 4, eqObj(tick4, rs4, precision)

tick5=exec ta::ema(close, timePeriod) from tickTB where sym=`tick5
rs5=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan, 10.043     ,
        9.98609091,  9.94316529,  9.96804433,  9.8683999 ,  9.61596356,
        9.47851564,  9.36424007,  9.28528733,  9.05887145,  8.902713  ,
        8.78585609,  8.66479135,  8.47482929,  8.45576942,  8.45290225,
        8.45782911,  8.48731473,  8.48598478,  8.53216936,  8.58813857,
        8.59574974,  8.66197706,  8.73616305,  8.6841334 ,  8.64701824,
        8.65119674,  8.66552461,  8.68997468,  8.7681611 ,  8.83940454,
        8.90496735,  8.97497328,  9.00861451,  9.00886641,  9.08907252,
        9.08924115,  9.02028822,  8.942054  ,  8.72531691,  8.4243502 ,
        8.24355925,  8.16291211,  8.106019  ,  8.01583373,  7.99113669,
        7.95638456,  7.8388601 ,  7.78088553,  7.67526998,  7.53067544,
        7.40509809,  7.33326207,  7.34539624,  7.38259692,  7.29485203,
        7.25396984,  7.26052078,  7.16588064,  7.11572052,  7.03286225,
        6.8559782 ,  6.62580035,  6.44474574,  6.24570106,  6.12102814,
        6.1208412 ,  6.11341553,  6.08915816,  6.08749304,  6.11885794,
        6.17906559,  6.25559912,  6.26367201,  6.28845891,  6.27783002,
        6.27822456,  6.39309282,  6.61253049,  6.75025222,  6.80838818,
        6.98504488,  7.19140035,  7.34023665,  7.35110272,  7.35817495,
        7.31668859,  7.29547249,  7.28538658,  7.23531629,  7.21434969]
assert 5, eqObj(tick5, rs5, precision)

maBySym=(exec ta::ema(close, timePeriod) from tickTB context by sym ).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(maBySym, rs, precision)

@testing:case="test_ta_function_ema"
x=[80.547883,88.441286,53.563787,84.333949,86.184134,79.958874,80.857146,16.09588,70.020608,46.971058,5.667949]
rs=[ , , 74.18431867, 79.25913383, 82.72163392, 81.34025396, 81.09869998, 48.59728999, 59.30894899, 53.1400035 , 29.40397625]
assert 1,eqObj(ta::ema(x,3),rs,6)

rs=[,,,,, 78.83831883, 79.4151266 , 61.32391328, 63.8086832 , 58.99793314, 43.76079482]
assert 2,eqObj(ta::ema(x,6),rs,6)
