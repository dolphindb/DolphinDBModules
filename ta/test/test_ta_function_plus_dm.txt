#include "setup/settings.txt"
use ta
//plus_dm(high,low, timePeriod)

@testing:case="test_ta_function_plus_dm_take40"
high=1..40
low=1..40
talib=take(double(),13).append!([ 13.        , 13.07142857,
       13.1377551 , 13.19934402, 13.25653374, 13.30963847, 13.35895001,
       13.40473929, 13.44725791, 13.48673949, 13.52340096, 13.55744375,
       13.58905491, 13.61840813, 13.64566469, 13.67097435, 13.69447619,
       13.71629932, 13.73656365, 13.75538053, 13.77285335, 13.78907811,
       13.80414396, 13.81813368, 13.83112413, 13.84318669, 13.85438764 ])
assert 1, eqObj(plus_dm(high,low,14),talib,5)
talib=take(double(),19).append!([19.        ,
       19.05      , 19.0975    , 19.142625  , 19.18549375, 19.22621906,
       19.26490811, 19.3016627 , 19.33657957, 19.36975059, 19.40126306,
       19.43119991, 19.45963991, 19.48665792, 19.51232502, 19.53670877,
       19.55987333, 19.58187966, 19.60278568, 19.6226464 , 19.64151408 ])
assert 2, eqObj(plus_dm(high,low,20),talib,5)
talib=array(DOUBLE,40,40,1)
talib[0]=NULL
assert 3, eqObj(plus_dm(high,low,1),talib,5)
low=reverse(low)
talib=take(double(),13).append!([0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
        0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,  0.,
        0. ])
assert 4, eqObj(plus_dm(high,low,14),talib,5)

@testing:case="test_ta_function_plus_dm_rand40"
high=[0.03934561, 0.3913419 , 0.67861662, 0.09182039, 0.53461844,
       0.39358385, 0.80795506, 0.2901035 , 0.58135459, 0.58037376,
       0.13455814, 0.61691336, 0.27538892, 0.07315521, 0.96032825,
       0.75864975, 0.2207173 , 0.87560949, 0.20545305, 0.21694055,
       0.88030261, 0.07652558, 0.80192465, 0.99102008, 0.66971843,
       0.73481874, 0.61560042, 0.93761299, 0.59134128, 0.36605644,
       0.69289853, 0.50667133, 0.30010299, 0.50581499, 0.32814743,
       0.11472156, 0.07803733, 0.83213596, 0.99851494, 0.08305684]
low=[45.62224469, 95.60919074, 98.29499584, 90.23451081, 23.25228883,
       41.97533568, 63.66097915, 76.11820692, 40.87640632,  6.33505215,
       49.51916744, 77.72182613, 86.09045162, 76.74236979, 86.25634163,
       36.98974171, 45.74496545,  6.10159124, 63.77681062, 78.41644563,
       61.27627218, 41.3584436 , 28.06523572, 14.05651424, 17.97973564,
        2.00638146, 57.49264871, 99.76312047, 34.40743842, 45.14771507,
       98.50043199, 12.4404398 , 80.04463005, 62.24407584, 73.11712071,
       48.53433488, 55.85895169, 88.27815748, 24.95265028, 40.57608371]
talib=take(double(),13).append!([1.53599744, 2.31345638,
       2.14820949, 1.99476596, 1.85228268, 1.71997677, 1.60860879,
       1.49370816, 1.38701472, 1.28794224, 1.19594637, 1.11052163,
       1.03119865, 0.95754161, 1.21115836, 1.12464704, 1.04431511,
       1.29656327, 1.20395161, 1.11795507, 1.03810113, 0.96395105,
       0.89509741, 0.83116188, 1.52589179, 1.41689952, 1.31569241])
assert 1, eqObj(plus_dm(high,low,14),talib,5)
talib=take(double(),19).append!([2.43465799,
       2.31292509, 2.19727883, 2.08741489, 1.98304415, 1.88389194,
       1.78969734, 1.70021247, 1.93721443, 1.84035371, 1.74833602,
       1.98776132, 1.88837325, 1.79395459, 1.70425686, 1.61904402,
       1.53809181, 1.46118722, 2.14222649, 2.03511516, 1.9333594  ])
assert 2, eqObj(plus_dm(high,low,20),talib,5)
talib=[        , 0.3519963 , 0.28727471, 0.        , 0.        ,
       0.        , 0.41437121, 0.        , 0.        , 0.        ,
       0.        , 0.48235522, 0.        , 0.        , 0.88717304,
       0.        , 0.        , 0.        , 0.        , 0.01148751,
       0.        , 0.        , 0.        , 0.        , 0.        ,
       0.        , 0.        , 0.32201258, 0.        , 0.        ,
       0.3268421 , 0.        , 0.        , 0.        , 0.        ,
       0.        , 0.        , 0.75409862, 0.        , 0.        ]
assert 3, eqObj(plus_dm(high,low,1),talib,5)

@testing:case="test_ta_function_plus_dm_csv"
timePeriod=14
tickTB=loadText(DATA_DIR+"/ticks1.csv")
tick1=exec plus_dm(high,low, timePeriod) from tickTB where sym=`tick1
rs1=take(double(), 8)
assert 1, eqObj(tick1, rs1, 5)

tick2=exec plus_dm(high,low, timePeriod) from tickTB where sym=`tick2
rs2=[, , , , , , , , , , , , , , , , , , , 10.31      ,
        9.57357143,  9.7597449 ,  9.06262026,  8.41529024,  7.81419808,
        8.67604108,  8.56632386,  7.95444358,  7.38626904,  8.10867839,
        7.52948708,  6.99166658,  6.49226182,  6.02852883,  5.59791963,
        5.19806823,  4.82677764,  4.48200781,  4.70186439,  4.73601694,
        5.16773001,  4.79860644,  4.45584884,  4.13757392,  3.84203293,
        4.147602  ,  3.85134472,  3.69624867,  3.4322309 ,  3.72707155,
        3.46085216,  3.53364843,  3.44124497,  3.19544176,  4.00719592,
        3.72096764,  3.88518424,  3.60767108,  3.47998029,  3.23141027,
        4.11059525,  4.2769813 ,  3.97148264,  3.86780531,  4.0715335 ,
        3.78070968,  3.51065899,  3.51989763,  3.26847637,  3.03501377,
        3.24822707,  3.01621085,  3.31076722,  3.21428385,  3.04469215,
        2.82721414,  3.20527027,  2.97632239,  2.76372794,  2.5663188 ,
        2.38301031,  2.21279529,  2.05473848,  1.90797145,  1.77168777,
        1.64513865,  1.85762874,  1.72494098,  1.60173091,  1.48732156,
        1.3810843 ,  1.28243542,  1.41083289,  1.74005911,  1.61576918,
        1.70035709,  1.57890302,  1.46612423,  1.53140107,  1.42201528 ]
assert 2, eqObj(tick2, rs2, 5)

tick3=exec plus_dm(high,low, timePeriod) from tickTB where sym=`tick3
rs3=take(double(), 5)
assert 3, eqObj(tick3, rs3,5)

tick4=exec plus_dm(high,low, timePeriod) from tickTB where sym=`tick4
rs4=[, , , , , , , , , , , , , 1.49      , 1.38357143,
       1.3547449 , 1.50797741, 1.40026473, 1.30024582, 1.91737112,
       1.78041604, 1.65324347, 1.90515465, 2.26907217, 2.89699559,
       2.69006733, 2.49791967, 2.52949683, 2.34881849, 2.84104574,
       2.6381139 , 2.58967719, 2.40470025, 2.23293595, 2.07344052,
       1.92533763, 1.78781351, 2.12011255, 2.01867594, 2.1844848 ,
       2.02845017, 1.88356087, 1.74902081, 1.62409075, 1.77808427,
       1.65107825, 1.53314409, 1.4236338 , 1.32194567, 1.22752098,
       1.92984091, 1.79199513, 2.02399548, 1.87942437, 1.99517977,
       1.85266693, 1.72033358, 1.59745261, 1.48334885, 1.37739536,
       1.27900998, 1.33765212, 1.36210554, 1.26481229, 1.17446856,
       1.39057794, 1.29125095, 1.19901874, 1.19337454, 1.1081335 ,
       1.02898111, 0.95548246, 0.88723371, 1.06385988, 1.57786988,
       1.80516489, 1.67622454, 1.55649422, 1.69531606, 1.86422206,
       1.73106334, 1.60741596, 1.67260053, 2.03312906, 1.88790556,
       1.75305516, 1.72783694, 1.74442001, 1.61981858, 1.50411726,
       1.39668031, 1.29691743, 1.25428047, 1.31468901, 1.29078265,
       1.64858389, 1.5308279 , 1.42148305, 1.31994854, 1.22566651 ]
assert 4, eqObj(tick4, rs4, 5)

tick5=exec plus_dm(high,low, timePeriod) from tickTB where sym=`tick5
rs5=[,,,,,,,,,,,,, 0.86      , 0.79857143,
       0.74153061, 0.96856414, 0.89938099, 0.83513949, 0.77548667,
       0.91009476, 0.84508799, 0.78472457, 0.87867281, 1.02591047,
       1.11263115, 1.03315749, 0.95936053, 1.11083478, 1.15148944,
       1.17924019, 1.09500875, 1.32679384, 1.23202285, 1.14402122,
       1.06230542, 1.16642646, 1.13311028, 1.30217383, 1.32916142,
       1.23422132, 1.57606265, 1.46348675, 1.35895198, 1.52188398,
       1.71317798, 1.59080813, 1.47717897, 1.37166619, 1.27369003,
       1.18271217, 1.40823273, 1.56764468, 1.45567006, 1.35169363,
       1.40514408, 1.30477665, 1.21157832, 1.12503701, 1.04467722,
       0.97005742, 0.9007676 , 1.18642706, 1.37168227, 1.27370497,
       1.18272604, 1.36824561, 1.27051378, 1.1797628 , 1.09549402,
       1.01724445, 0.94458413, 0.87711384, 0.81446285, 0.84628693,
       1.31583787, 1.44184945, 1.3388602 , 1.24322733, 1.34442538,
       1.47839499, 1.49279535, 1.54616711, 1.4357266 , 1.3431747 ,
       1.24723365, 1.74814553, 2.313278  , 2.66804385, 2.47746929,
       2.7205072 , 3.29618526, 3.31074345, 3.07426178, 2.85467165,
       2.65076653, 2.46142607, 2.65560992, 2.4659235 , 2.2897861]
assert 5, eqObj(tick5, rs5, 5)

plus_dmBySym=(exec plus_dm(high,low, timePeriod) from tickTB context by sym).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(plus_dmBySym, rs, 5)
