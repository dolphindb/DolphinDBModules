#include "setup/settings.txt"
use ta

precision=5
nan=double()
@testing:case="test_ta_function_mfi_use_ticks1_contextby"
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec ta::mfi(high, low, close, vol, 10) from tickTB where sym=`tick1
rs1=[nan, nan, nan, nan, nan, nan, nan, nan]
assert 1, eqObj(tick1, rs1, precision)

tick2=exec ta::mfi(high, low, close, vol, 10) from tickTB where sym=`tick2
rs2=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan, 90.2242686 , 75.38560342, 79.12668149, 72.14710416,
       68.493395  , 71.69061321, 66.67106942, 63.86805011, 54.05849053,
       52.46643385, 50.33591592, 52.28789277, 39.79944136, 53.10965417,
       52.23929721, 41.79322334, 43.09230929, 43.7217945 , 43.92473445,
       33.6037617 , 19.46131403, 20.76889859, 29.21015237, 20.75991708,
       33.4542177 , 35.02871878, 35.98141581, 37.8949813 , 47.20471489,
       56.69164335, 60.00109052, 66.17234454, 59.7836729 , 56.02317543,
       42.78181948, 56.3942721 , 69.54297357, 69.01105093, 72.62929992,
       73.21671364, 82.72672069, 74.50267544, 79.71708465, 79.74214784,
       87.55474751, 88.79015407, 80.67950678, 86.27644155, 86.32447515,
       86.55158972, 78.00477005, 84.23858011, 76.51159192, 77.48684619,
       75.95559371, 67.73933849, 75.95621673, 75.31869174, 65.44144397,
       55.58753106, 67.43380624, 66.51926937, 69.34394784, 55.60867643,
       43.65139932, 50.66252369, 48.58309232, 40.5423652 , 42.79878219,
       45.95220452, 39.63549542, 28.23789654, 30.75198508, 37.19680042,
       41.92006843, 28.17580183, 26.66670318, 41.7146827 , 42.75112843,
       52.06071779, 40.19025972, 51.01672821, 59.61491792, 60.10055454]
assert 2, eqObj(tick2, rs2, precision)

tick3=exec ta::mfi(high, low, close, vol, 10) from tickTB where sym=`tick3
rs3=[nan, nan, nan, nan, nan]
assert 3, eqObj(tick3, rs3,precision)

tick4=exec ta::mfi(high, low, close, vol, 10) from tickTB where sym=`tick4
rs4=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
       69.20540522, 59.1787124 , 51.87542827, 41.82121995, 44.97649397,
       54.21052289, 63.6010497 , 64.40654477, 55.8383915 , 54.56521429,
       40.41517604, 43.42064443, 49.841777  , 61.81132757, 73.49771477,
       62.40615744, 55.53830453, 63.4110781 , 68.58890751, 66.86022961,
       68.12053745, 65.59521611, 59.54785436, 50.85083061, 41.28628861,
       44.76865181, 51.21957586, 51.31799549, 52.07889549, 52.51283624,
       44.01285208, 43.44538761, 43.21814752, 43.99548962, 43.87018081,
       43.8963269 , 39.90557464, 32.5974799 , 22.63769037, 13.43452121,
       30.8825763 , 48.90038831, 59.71653558, 60.99471216, 67.13028919,
       57.2220198 , 54.75805972, 54.1979183 , 54.22274654, 47.77218736,
       39.35514439, 33.33113042, 33.26239822, 33.20969227, 13.07067908,
       23.54337973, 24.40151668, 25.02689882, 33.86781678, 36.45272355,
       38.50704573, 29.10027968, 17.84060574, 29.29689162, 50.31411178,
       55.39387712, 58.97379606, 68.81887867, 71.33442817, 79.72464862,
       72.96982508, 68.37107729, 76.41766878, 82.54086129, 71.79215774,
       63.5954051 , 67.50468095, 68.13496123, 62.7178492 , 57.370593  ,
       59.65456864, 60.08774884, 55.25994748, 37.0212509 , 51.48857581,
       71.91541746, 75.3047028 , 65.00404923, 63.52507993, 61.64170572]
assert 4, eqObj(tick4, rs4, precision)

tick5=exec ta::mfi(high, low, close, vol, 10) from tickTB where sym=`tick5
rs5=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
       49.04339533, 32.77806785, 44.97603813, 32.00555255, 35.21505051,
       36.04100136, 34.69082474, 42.99659406, 44.76702653, 34.92751076,
       41.02549926, 44.74193202, 30.14719373, 41.61577178, 52.69390038,
       65.13604422, 60.16630804, 48.94795105, 62.71490782, 72.79505661,
       62.92042444, 73.30755466, 86.35196865, 73.09259502, 65.15766348,
       64.72879914, 65.48365131, 71.48180518, 72.18568314, 73.91659384,
       71.62221978, 73.01668612, 59.49932198, 63.23598098, 73.06442089,
       74.63147352, 67.37217967, 62.58955427, 54.9211119 , 44.79711763,
       52.80206041, 47.31215875, 57.99488649, 59.63522044, 47.00680356,
       38.70893855, 42.59241384, 43.29121003, 46.50080548, 47.28469252,
       35.87752715, 32.69186265, 31.98946026, 47.9731921 , 46.05133713,
       40.24463321, 48.37635002, 48.49503381, 49.39280331, 53.68354017,
       56.21371067, 47.14839189, 33.95628822, 13.79428086, 28.04022442,
       48.10046385, 50.86765178, 49.94313594, 55.30413874, 62.06873106,
       71.89733093, 79.78887231, 67.69196165, 65.07447357, 57.92144438,
       47.1935046 , 51.40167247, 65.07686958, 79.1830868 , 69.7255388 ,
       71.96970547, 79.02979322, 86.83466746, 82.82829118, 80.53555484,
       78.66831238, 75.40741324, 74.68427171, 63.83764676, 70.88449004]
assert 5, eqObj(tick5,rs5, 3)

maBySym=(exec ta::mfi(high, low, close, vol, 10) from tickTB context by sym ).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(maBySym, rs, 3)

@testing:case="test_ta_function_mfi"
//50 periods' trading data

high=[1.32085614, 1.33209744, 1.65334543, 1.98292893, 1.62847154,
       1.61211693, 1.43071194, 1.190888  , 1.21653297, 1.6240297 ,
       1.55916562, 1.95043058, 1.83128158, 1.0707179 , 1.89224494,
       1.59317866, 1.88329497, 1.91443362, 1.41076432, 1.6845114 ,
       1.13100617, 1.02046848, 1.9499835 , 1.60047059, 1.58742749,
       1.23099301, 1.90531251, 1.45867113, 1.022339  , 1.93727506,
       1.14304117, 1.7331815 , 1.20416814, 1.37794859, 1.27718212,
       1.0476559 , 1.10734257, 1.97592021, 1.80915831, 1.53324697,
       1.16292236, 1.88196582, 1.72984907, 1.14992525, 1.59572721,
       1.24367   , 1.99962993, 1.8222214 , 1.46459796, 1.63449398]
low=[1.30108268, 1.27318733, 1.56891503, 1.50662655, 0.75611194,
       0.75633976, 1.028802  , 0.62821371, 0.27378455, 1.58131837,
       0.63604436, 1.87940108, 1.064676  , 0.78270707, 1.40808706,
       1.01905124, 1.72748107, 1.90899843, 0.75722024, 1.18230093,
       0.88702096, 0.02325871, 1.48631746, 0.83526989, 0.63112104,
       0.3343596 , 1.46448969, 1.18459049, 0.55924708, 1.47170194,
       0.92731831, 1.07993085, 0.75357028, 1.01514799, 0.92403917,
       0.72125973, 1.05392379, 1.59623559, 1.50044603, 1.47725066,
       1.13688941, 1.28651591, 1.29634426, 0.33855578, 1.44746285,
       0.57223387, 1.92598898, 1.3356523 , 0.54948566, 1.49217727]
close=[1.31096941, 1.30264238, 1.61113023, 1.74477774, 1.19229174,
       1.18422834, 1.22975697, 0.90955086, 0.74515876, 1.60267403,
       1.09760499, 1.91491583, 1.44797879, 0.92671249, 1.650166  ,
       1.30611495, 1.80538802, 1.91171602, 1.08399228, 1.43340616,
       1.00901357, 0.52186359, 1.71815048, 1.21787024, 1.10927426,
       0.78267631, 1.6849011 , 1.32163081, 0.79079304, 1.7044885 ,
       1.03517974, 1.40655617, 0.97886921, 1.19654829, 1.10061065,
       0.88445782, 1.08063318, 1.7860779 , 1.65480217, 1.50524881,
       1.14990589, 1.58424086, 1.51309666, 0.74424052, 1.52159503,
       0.90795193, 1.96280945, 1.57893685, 1.00704181, 1.56333563]
volume = [
    975625,
    971568,
    675593,
    182980,
    523823,
    724676,
    126681,
    93223,
    303527,
    289861,
    576794,
    266703,
    942804,
    533334,
    449770,
    723921,
    560223,
    414142,
    484081,
    1203,
    452034,
    701082,
    813030,
    660775,
    93196,
    55760,
    231479,
    964723,
    222036,
    154287,
    526114,
    571297,
    239644,
    696689,
    938514,
    872348,
    596035,
    726590,
    157832,
    183208,
    212648,
    484401,
    716740,
    506013,
    279505,
    263232,
    255461,
    267666,
    405459,
    224881
    ]

ans=[        NULL,         NULL,         NULL,         NULL,         NULL,
               NULL,         NULL,         NULL,         NULL,         NULL,
               NULL,         NULL,         NULL,         NULL, 37.14545449,
       38.54214173, 37.98080615, 41.27013841, 41.7377839 , 46.25485827,
       42.68367287, 41.27770756, 50.69298679, 44.35096574, 46.82018257,
       43.5923974 , 53.6900505 , 48.95503718, 43.34570835, 50.69506753,
       39.83936299, 39.93899633, 41.62862452, 47.94267821, 44.59766057,
       42.51160633, 37.04743879, 50.30139189, 49.37530686, 48.07333926,
       44.37636808, 56.55601326, 50.88165918, 47.38443844, 52.70661982,
       46.74581907, 51.04800159, 43.57234999, 47.09776806, 54.62334768]   

precision=6

rs = ta::mfi(high,low,close,volume,14)
assert 1, eqObj(rs,ans, precision)


@testing:case="test_ta_function_mfi_tbl"
t1=table(high,low,close,volume)
rs=exec ta::mfi(high,low,close,volume,14) from t1
assert 1, eqObj(rs,ans, precision)


//30 periods with nulls
high = [NULL,NULL,NULL,NULL,NULL,NULL,14.61,15.42,16.54,15.84,10.47,10.7,10.25,9.93,15,16.09,17.49,16.67,17.26,16,15.55,16.42,16.08,15.29,14.63,16.05,16.56,16.45,16.45,17.7]

low = [NULL,NULL,NULL,NULL,NULL,NULL,14.01,15.02,16.04,15.04,9.65,9.8,9.48,9.01,13.5,14.07,15.3,15.9,15.84,15,15.05,14.52,14.85,14.02,13.68,13.99,15.61,15.75,14.48,15.7]

close= [NULL,NULL,NULL,NULL,NULL,NULL,14.41,15.32,16.34,15.64,10.3,9.98,9.48,9.27,14.63,16.09,16.65,16.04,16.32,15.3,15.23,16.08,15.09,14.14,14.59,16.05,15.94,15.79,16.09,16.83]
volume = [
    NULL,
    NULL,
    NULL,
    NULL,
    NULL,
    NULL,
    975625,
    971568,
    675593,
    182980,
    523823,
    724676,
    126681,
    93223,
    303527,
    289861,
    576794,
    266703,
    942804,
    533334,
    449770,
    723921,
    560223,
    414142,
    484081,
    1203,
    452034,
    701082,
    405459,
    224881
    ]

@testing:case="test_ta_function_mfi2"
//talib 44.76454736
precision=3
ans=[  NULL,         NULL,         NULL,         NULL,         NULL,
       NULL,         NULL,         NULL,         NULL,         NULL,
       NULL,         NULL,         NULL,         NULL,         NULL,
       NULL,         NULL,         NULL,         NULL,         NULL,
      69.32052391, 68.17810331, 57.87061333, 55.92503128, 54.98299014,
       51.23799301, 55.65678712, 50.15771184, 45.12855478, 44.76454736]

rs = ta::mfi(high,low,close,volume, 14)
assert 1, eqObj(rs,ans, precision)
