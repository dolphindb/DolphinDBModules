#include "setup/settings.txt"
use ta

precision=5
nan=double()
@testing:case="test_ta_function_minus_di_use_ticks1_contextby"
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec ta::minus_di(high, low, close, 10) from tickTB where sym=`tick1
rs1=[nan, nan, nan, nan, nan, nan, nan, nan]
assert 1, eqObj(tick1, rs1, precision)

tick2=exec ta::minus_di(high, low, close, 10) from tickTB where sym=`tick2
rs2=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
               nan, 32.2069378 , 30.88975759, 28.50131011, 31.09977188,
       30.16096868, 26.75136158, 24.73966762, 27.96530997, 28.44980276,
       24.75631624, 23.21217517, 22.08441   , 27.67415444, 24.10578346,
       22.99651447, 31.40090205, 34.94376291, 34.87667733, 32.75585367,
       33.84897015, 38.31199917, 36.45033164, 33.73329717, 31.49726903,
       28.36375952, 28.14422609, 35.32840279, 40.67827688, 39.13518631,
       35.88151778, 41.26353764, 38.83168038, 37.46428034, 32.98519769,
       30.96346072, 28.18367122, 26.54452065, 25.79916566, 21.7748961 ,
       20.04990996, 18.55842275, 17.62588628, 16.0987645 , 15.10807385,
       12.68967959, 11.71910591, 12.48634137, 11.59901209, 10.01711019,
        9.32397995, 12.16487493, 11.00838883, 10.32297957, 11.52199167,
        9.94367047, 14.4942315 , 12.98231442, 12.32593158, 11.50829008,
       15.89963943, 14.03098269, 13.16052655, 14.04066693, 29.09730438,
       37.58389622, 35.47397913, 33.78094033, 35.45770987, 34.50438992,
       33.10118512, 30.25738584, 36.38009516, 34.97783887, 43.11527382,
       42.14132382, 42.22512103, 37.73729015, 33.80727834, 31.33267279,
       28.62554602, 27.06652357, 26.78557919, 25.00387009, 26.29444956]
assert 2, eqObj(tick2, rs2, precision)

tick3=exec ta::minus_di(high, low, close, 10) from tickTB where sym=`tick3
rs3=[nan, nan, nan, nan, nan]
assert 3, eqObj(tick3, rs3,precision)

tick4=exec ta::minus_di(high, low, close, 10) from tickTB where sym=`tick4
rs4=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
       13.35222537, 25.12741723, 23.39904527, 28.70997903, 38.58832535,
       33.80148581, 31.40679453, 39.53240006, 41.61478075, 36.67580134,
       35.44591619, 42.01927368, 37.50434351, 34.12471328, 30.15424331,
       28.61296179, 27.56620363, 25.92741702, 24.72210156, 22.23934537,
       23.98639066, 20.94530394, 22.69586161, 24.06714621, 23.30944983,
       24.15288891, 22.91448084, 20.570631  , 19.36377746, 17.60825942,
       19.34138431, 17.67033327, 25.88758567, 24.57649232, 22.55742694,
       33.253404  , 30.97731743, 37.86746217, 44.31230301, 40.07952347,
       32.49259632, 30.94507963, 27.32948398, 27.09263209, 23.91552938,
       33.28489992, 37.1161348 , 34.20807088, 35.21777152, 38.84437856,
       41.57621174, 38.07840735, 36.30554781, 37.74122062, 38.17877079,
       36.32878481, 41.07266611, 42.03898391, 39.41313652, 40.90208567,
       45.12495624, 41.95869394, 43.78331696, 40.29901637, 36.08943977,
       32.39065289, 30.89125886, 29.05214586, 26.47945707, 24.24607611,
       23.02030433, 23.90059296, 20.58599942, 18.5817001 , 21.19290811,
       21.86605817, 20.43499583, 19.09147447, 23.18229236, 23.28299553,
       31.5166935 , 36.61985995, 33.54505304, 30.18001251, 26.66238238,
       22.70757284, 21.3116293 , 23.13661998, 29.8962176 , 27.83162054]
assert 4, eqObj(tick4, rs4, precision)

tick5=exec ta::minus_di(high, low, close, 10) from tickTB where sym=`tick5
rs5=[        nan,         nan,         nan,         nan,         nan,
               nan,         nan,         nan,         nan,         nan,
       15.42379788, 21.5485147 , 19.60548704, 21.11681812, 33.28954818,
       35.97765732, 32.33539296, 30.58774877, 38.10977767, 37.86186606,
       34.76008206, 32.65461125, 41.18756248, 36.08501631, 33.14357503,
       29.9844578 , 28.65349289, 30.47778292, 28.59134122, 27.24462468,
       24.81645252, 23.65072117, 21.2210202 , 26.39737944, 27.70077279,
       26.07715952, 24.48272064, 23.28276729, 20.94920424, 19.63709237,
       21.42336764, 19.19428329, 22.91167253, 26.48237046, 23.69022779,
       20.17182387, 31.03438924, 28.60012583, 38.47276484, 45.57163262,
       41.25706732, 34.90238035, 31.8167961 , 30.6173965 , 31.77041334,
       29.75772701, 34.46807838, 36.24915338, 33.84064628, 39.67142974,
       37.06294759, 35.15340735, 30.78082813, 28.59813639, 33.41301671,
       34.16476097, 31.51056647, 34.19836459, 33.088614  , 31.49407283,
       40.01242911, 44.6752585 , 42.38475247, 44.16688953, 41.09285227,
       36.56812433, 33.97055952, 34.64531496, 33.15437378, 31.56559349,
       29.01637207, 26.62705278, 23.44233097, 28.17456415, 25.79603711,
       26.35833805, 22.4029096 , 18.9435015 , 15.70266433, 22.87837425,
       19.6156291 , 16.80656135, 14.42231229, 24.62171614, 25.67254819,
       25.02166806, 23.75001387, 21.30265322, 24.58907038, 23.21826133]
assert 5, eqObj(tick5,rs5, 3)

maBySym=(exec ta::minus_di(high, low, close, 10) from tickTB context by sym ).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(maBySym, rs, 3)

@testing:case="test_ta_function_mdm"
//50 periods' trading data

high=[1.32085614, 1.33209744, 1.65334543, 1.98292893, 1.62847154,
       1.61211693, 1.43071194, 1.190888  , 1.21653297, 1.6240297 ,
       1.55916562, 1.95043058, 1.83128158, 1.0707179 , 1.89224494,
       1.59317866, 1.88329497, 1.91443362, 1.41076432, 1.6845114 ,
       1.13100617, 1.02046848, 1.9499835 , 1.60047059, 1.58742749,
       1.23099301, 1.90531251, 1.45867113, 1.022339  , 1.93727506,
       1.14304117, 1.7331815 , 1.20416814, 1.37794859, 1.27718212,
       1.0476559 , 1.10734257, 1.97592021, 1.80915831, 1.53324697,
       1.16292236, 1.88196582, 1.72984907, 1.14992525, 1.59572721,
       1.24367   , 1.99962993, 1.8222214 , 1.46459796, 1.63449398]
low=[1.30108268, 1.27318733, 1.56891503, 1.50662655, 0.75611194,
       0.75633976, 1.028802  , 0.62821371, 0.27378455, 1.58131837,
       0.63604436, 1.87940108, 1.064676  , 0.78270707, 1.40808706,
       1.01905124, 1.72748107, 1.90899843, 0.75722024, 1.18230093,
       0.88702096, 0.02325871, 1.48631746, 0.83526989, 0.63112104,
       0.3343596 , 1.46448969, 1.18459049, 0.55924708, 1.47170194,
       0.92731831, 1.07993085, 0.75357028, 1.01514799, 0.92403917,
       0.72125973, 1.05392379, 1.59623559, 1.50044603, 1.47725066,
       1.13688941, 1.28651591, 1.29634426, 0.33855578, 1.44746285,
       0.57223387, 1.92598898, 1.3356523 , 0.54948566, 1.49217727]


close=[1.31096941, 1.30264238, 1.61113023, 1.74477774, 1.19229174,
       1.18422834, 1.22975697, 0.90955086, 0.74515876, 1.60267403,
       1.09760499, 1.91491583, 1.44797879, 0.92671249, 1.650166  ,
       1.30611495, 1.80538802, 1.91171602, 1.08399228, 1.43340616,
       1.00901357, 0.52186359, 1.71815048, 1.21787024, 1.10927426,
       0.78267631, 1.6849011 , 1.32163081, 0.79079304, 1.7044885 ,
       1.03517974, 1.40655617, 0.97886921, 1.19654829, 1.10061065,
       0.88445782, 1.08063318, 1.7860779 , 1.65480217, 1.50524881,
       1.14990589, 1.58424086, 1.51309666, 0.74424052, 1.52159503,
       0.90795193, 1.96280945, 1.57893685, 1.00704181, 1.56333563]



ans=[  NULL,         NULL,         NULL,         NULL,         NULL,
       NULL,         NULL,         NULL,         NULL,         NULL,
       NULL,         NULL,         NULL,         NULL,     36.00526363,
       37.76523953, 35.37357803, 34.92358291, 43.13703368, 40.27896131,
       41.11801801, 45.98653257, 39.47258165, 42.42579691, 40.50044739,
       39.87530177, 35.79918447, 36.7413222 , 39.96887282, 35.83276096,
       38.23591222, 35.80355843, 36.65738165, 35.25963934, 34.92794181,
       35.65011065, 34.79198398, 31.51089588, 31.49458245, 31.11626823,
       33.80354177, 30.90328569, 29.30013015, 36.16870129, 32.8019547 ,
       38.77245579, 34.4799033 , 38.3036587 , 42.17796697, 39.53653656]

precision=6

rs = ta::minus_di(high,low,close, 14)
assert 1, eqObj(rs,ans, precision)

@testing:case="test_ta_function_mdm_tbl"
t1=table(high,low,close)
rs=exec ta::minus_di(high,low,close,14) from t1
assert 1, eqObj(rs,ans, precision)
