
#include "setup/settings.txt"

use ta

//var(close, timePeriod, nbdev)

@testing:case="test_ta_function_var"
x=[89.79,11.58,99.9,81.11,84.69,31.38,60.9,83.3,97.26,98.67]

//nbdev=1
validate=[ , , , ,  995.900344, 1159.167976,  558.963304,  415.114344,  539.753584,  644.748976]
assert 1,eqObj(ta::var(x,5,1),validate,6)

validate=[ , , , , , 1075.31378056,  966.06945556,  484.82825556,  462.60532222,  552.27838889]
assert 2,eqObj(ta::var(x,6,1),validate,6)

validate=[ , , , , , , 925.41284082, 885.75496735, 484.42285306, 476.53729796]
assert 3,eqObj(ta::var(x,7,1),validate,6)

validate=[ , , , ,  995.900344, 1159.167976,  558.963304,  415.114344,  539.753584,  644.748976]
assert 4,eqObj(ta::var(x,5,0),validate,6)

validate=[ , , , , , 1075.31378056,  966.06945556,  484.82825556,  462.60532222,  552.27838889]
assert 5,eqObj(ta::var(x,6,-1),validate,6)

validate=[ , , , , , , 925.41284082, 885.75496735, 484.42285306, 476.53729796]
assert 6,eqObj(ta::var(x,7,6),validate,6)

close=[5.18,71.01,76.28,5.92,52.97,16.45,92.88,7.37,79.39,15.82]
t=table(take(`A`B,10) as sym,close)
re=exec ta::var(close,5,1) from t
validate=[ , , , , 958.829656,  811.940984, 1120.15052,  1125.222296, 1130.806016, 1304.697736]
assert 7,eqObj(re,validate,6)

re=exec ta::var(close,6,2) from t
validate=[ , , , , ,  891.63244722, 1001.35489167, 1173.00611389, 1209.90885556, 1102.81835556]
assert 8,eqObj(re,validate,6)

@testing:case="test_ta_function_var_context_by"
tick = loadText(DATA_DIR + "/ticks1.csv")
res = select sym, ta::var(close, 10, 1) as var from tick context by sym 
tick1 = exec var from res where sym = `tick1
validate1 = take(double(), 8)
assert 1, eqObj(tick1, validate1, 6)
tick2 = exec  var from res where sym = `tick2
validate2 = [ , , , , , , , ,
  , , , , , , , 8.020124,
 9.03798,  9.365436, 9.35388,  9.214684, 8.339609, 6.907329, 4.09728,  0.582601,
 0.590161, 0.586009, 0.475036, 0.452561, 0.41744,  0.588341, 0.60454,  0.68704,
 0.757136, 1.004444, 1.299676, 1.715161, 2.117641, 2.334121, 2.075609, 1.191836,
 0.479369, 0.326636, 0.277769, 0.615281, 0.678364, 0.769105, 0.97618,  1.078969,
 1.034704, 0.7668,   0.395069, 0.106389, 0.08946,  0.085716, 0.149364, 0.266949,
 0.298981, 0.307381, 0.319701, 0.341844, 0.493041, 0.71212,  0.690776, 0.582844,
 0.612241, 0.661516, 0.576601, 0.417116, 0.271724, 0.067545, 0.057345, 0.060304,
 0.045289, 0.042649, 0.043576, 0.04924,  0.079944, 0.095421, 0.092445, 0.233269,
 0.573405, 0.73458,  0.851605, 1.010764, 1.073736, 1.054509, 0.825189, 0.555885,
 0.171176, 0.241064, 0.348005, 0.418005, 0.338381, 0.306404, 0.238424, 0.18074,
 0.106116, 0.092596, 0.089241, 0.0812  ]
assert 2, eqObj(tick2, validate2, 6)
tick3 = exec var from res where sym = `tick3
validate3 = take(double(), 5)
assert 3, eqObj(tick3, validate3, 6)
tick4 = exec var from res where sym = `tick4
validate4 = [ , , , , , , , , , 0.114809, 0.113145, 0.108104, 0.107276, 0.186641, 0.561809, 0.620476,
 0.699689, 1.008545, 1.070876, 0.851601, 0.630736, 0.577641, 0.304816, 0.250249,
 0.303705, 0.320001, 0.329361, 0.338449, 0.33718,  0.397681, 0.371116, 0.129441,
 0.07666,  0.058881, 0.059449, 0.063409, 0.059636, 0.068661, 0.077981, 0.116084,
 0.156404, 0.160116, 0.141049, 0.120504, 0.118809, 0.183209, 0.245396, 0.519021,
 0.985349, 1.018224, 0.799921, 0.648076, 0.572684, 0.418556, 0.314305, 0.273676,
 0.217329, 0.213521, 0.168796, 0.383609, 0.606785, 0.671024, 0.6863,   0.779081,
 0.527921, 0.447984, 0.352145, 0.168836, 0.120164, 0.170916, 0.303081, 0.36096,
 0.333361, 0.319044, 0.26256,  0.162544, 0.154416, 0.13056,  0.156656, 0.220976,
 0.219869, 0.166036, 0.12148,  0.126149, 0.143589, 0.130004, 0.099224, 0.063881,
 0.054161, 0.057121, 0.110044, 0.137341, 0.165661, 0.1418,   0.117389, 0.131069,
 0.12314 , 0.101216, 0.097996, 0.092361]
assert 4,eqObj(tick4, validate4, 6)
tick5 = exec var from res where sym = `tick5
validate5 =  [ , , , , , , , , , 0.058861, 0.063124, 0.055956, 0.050405, 0.03518,  0.197041, 0.239049,
 0.267881, 0.282056, 0.423505, 0.430564, 0.420421, 0.378204, 0.255696, 0.157101,
 0.156389, 0.132069, 0.112956, 0.075201, 0.088081, 0.107921, 0.110104 ,0.120856,
 0.049661, 0.045549, 0.043845, 0.039684, 0.039145, 0.033961, 0.047185, 0.060561,
 0.069624, 0.085761, 0.089604, 0.066756, 0.057929, 0.041129, 0.042649, 0.059176,
 0.216589, 0.518176, 0.634465, 0.615244, 0.572145, 0.542745, 0.351676, 0.214549,
 0.149869, 0.064376, 0.075321, 0.096696, 0.139589, 0.14346,  0.120285, 0.117429,
 0.097829, 0.064176, 0.063644, 0.063176, 0.064881, 0.077025, 0.162201, 0.328625,
 0.403496, 0.437816, 0.470244, 0.402129, 0.267456, 0.217296, 0.130869, 0.085349,
 0.11378,  0.140949, 0.130296, 0.076641, 0.03356,  0.031704, 0.062829, 0.179469,
 0.21804,  0.215529, 0.302644 ,0.433364, 0.455081, 0.389681, 0.267881, 0.143696,
 0.118321, 0.123289, 0.142225, 0.1388  ]
assert 5, eqObj(tick5, validate5, 6)



