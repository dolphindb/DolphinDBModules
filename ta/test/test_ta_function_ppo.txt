#include "setup/settings.txt"
use ta

//ppo(close, fastPeriod, slowPeriod, maType)

precision=5
@testing:case="test_ta_function_ppo_use_ticks_specify_maType=0"
maType=0
fastPeriod=12
slowPeriod=26
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec ppo(close, fastPeriod, slowPeriod, maType) from tickTB where sym=`tick1
rs1=take(double(), 8)
assert 1, eqObj(tick1, rs1, precision)

tick2=exec ppo(close, fastPeriod, slowPeriod, maType) from tickTB where sym=`tick2
rs2=[ ,  ,  ,  , ,  ,  ,  , ,  ,  ,  ,  ,  ,  ,  ,  ,  ,  ,  , ,  ,  ,  , ,  ,  ,  ,  ,  ,  ,   5.73818366,
         5.32014081,   4.32583679,   4.18927862,   4.23410931,
         2.42570451,  -0.28266442,  -2.83886845,  -5.19854788,
        -6.35146559,  -7.72567633,  -9.04841138,  -9.91798963,
       -10.55132134, -10.77942251, -11.27018478, -11.13143136,
       -10.97832788, -10.8829402 , -11.23303801, -11.20249824,
       -11.30660728, -11.1498607 ,  -9.86118294,  -7.58547009,
        -5.78858799,  -4.40277212,  -2.5068306 ,  -1.14125686,
         0.69402852,   2.10196546,   3.60259053,   4.68664201,
         6.16499098,   7.80598517,   9.01567989,   9.82152873,
        10.15834472,  10.30019306,  10.31861724,  10.30849264,
         9.46769724,   8.63015411,   7.96530494,   7.45705828,
         6.58904978,   5.8048857 ,   5.17187786,   4.07685312,
         2.92330745,   1.84777188,   0.98127076,   0.03258213,
        -1.06802795,  -2.37493775,  -3.17464645,  -4.19820462,
        -5.55769938,  -7.08957986,  -8.45959242,  -8.98872166,
        -8.91759093,  -8.94999713,  -9.14039148,  -8.82312925,
        -8.79671788,  -8.62357834,  -8.29955895,  -7.66042124]
assert 2, eqObj(tick2, rs2,precision)    

tick3=exec ppo(close, fastPeriod, slowPeriod, maType)  from tickTB where sym=`tick3
rs3=take(double(), 5)
assert 3, eqObj(tick3, rs3,precision)

tick4=exec ppo(close, fastPeriod, slowPeriod, maType)  from tickTB where sym=`tick4
rs4=[, , , , , , , ,  , , , , , , , , , , , , , , , , ,  -9.01550388,  -7.99449234,  -7.32507464,
        -6.52531408,  -4.74593977,  -3.29160279,  -2.65596952,
        -1.5709503 ,  -0.07014953,   1.07840226,   1.95554725,
         2.51500232,   3.00867513,   3.71313909,   3.96314694,
         3.74708864,   3.55362449,   3.04041044,   2.52631969,
         2.323922  ,   2.12706978,   1.44735062,   0.25758302,
        -1.02175876,  -2.29027565,  -3.13104826,  -4.30433256,
        -5.6771227 ,  -6.63688779,  -6.74164443,  -7.42341028,
        -7.8873421 ,  -8.01465344,  -8.64323315,  -8.80174292,
        -8.30492158,  -8.16678153,  -8.55047525,  -9.04415332,
        -9.33656958,  -9.2908714 , -10.48602301, -10.83196107,
       -11.73166244, -12.58817021, -13.12522561, -13.15873625,
       -12.98587004, -13.44496185, -13.99647741, -13.67349335,
       -13.27806122, -13.03534805, -11.78377248, -10.62828699,
        -8.79696564,  -7.26685434,  -4.6178924 ,  -1.73725706,
         0.70034971,   2.16510042,   2.89603004,   3.86585591,
         4.93871665,   5.52689484,   5.44878936,   5.2103741 ,
         4.6441507 ,   4.5536983 ,   3.72301654,   2.77080894,
         1.71975227,   0.77297872,  -0.60064166,  -1.71480472]
assert 4, eqObj(tick4, rs4, precision)

tick5=exec ppo(close, fastPeriod, slowPeriod, maType)  from tickTB where sym=`tick5
rs5=[, , , , , , , , , , , , , , , , , , , , , , , , ,
       -9.15812713, -8.42139842, -8.06110806, -7.58774168, -7.02622076,
       -6.00387347, -4.85291362, -3.74444878, -2.89051817, -1.548857  ,
       -0.67970164,  0.03916005,  0.77093165,  1.68782974,  2.46568189,
        2.5812065 ,  2.81897128,  3.18790951,  3.19937168,  2.92025624,
        3.12738368,  3.1424305 ,  2.85399135,  1.86531751,  0.79739196,
       -0.37245184, -1.37964196, -2.34415594, -3.5917613 , -4.46439258,
       -5.19856301, -6.73425876, -7.67427702, -8.3859132 , -9.43743428,
       -9.66482797, -9.01959861, -8.47674584, -8.18946331, -8.19917092,
       -7.83463992, -7.59772601, -7.5680653 , -6.96989529, -6.80540697,
       -6.44807327, -6.19500176, -6.05141692, -6.35332459, -7.4234802 ,
       -8.65658923, -8.96093473, -9.35961984, -9.94095238, -9.8397159 ,
       -9.64464058, -9.08665653, -8.24069172, -6.59304873, -5.27929967,
       -3.7353574 , -2.02819762, -0.46334881,  1.21861665,  2.91893075,
        4.56885457,  6.29968516,  7.83662513,  8.43482843,  9.49711973,
       10.11838913, 10.60790098, 10.7539819 , 10.00833712,  8.32723657 ]
assert 5, eqObj(tick5, rs5, precision)

ppoBySym=(exec ppo(close, fastPeriod, slowPeriod, maType)  from tickTB context by sym).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(ppoBySym[39:], rs[39:], precision)

@testing:case="test_ta_function_ppo_use_ticks_specify_timeperiod=10_maType=1"
maType=1
fastPeriod=12
slowPeriod=26
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec ppo(close, fastPeriod, slowPeriod, maType) from tickTB where sym=`tick1
rs1=take(double(), 8)
assert 1, eqObj(tick1, rs1, precision)

tick2=exec ppo(close, fastPeriod, slowPeriod, maType) from tickTB where sym=`tick2
rs2=[, , , , , , , , , , , , , , , , , , , , , , , , , , , , , , ,  5.16594335,  4.29987951,  2.95379102,  1.89243925,
        0.71868677, -0.44744489, -1.37979283, -1.7735711 , -1.85167726,
       -1.81740204, -2.03847163, -2.94281056, -4.18545431, -4.81218959,
       -5.31084807, -6.01708917, -6.376801  , -6.57541367, -6.34819551,
       -6.46316018, -6.0502418 , -5.69915024, -5.35351864, -4.65832032,
       -3.80622376, -3.07635927, -2.49008279, -1.80722243, -1.29903996,
       -0.07030642,  1.03127873,  1.63833276,  2.15384267,  2.83027966,
        3.42054161,  3.65123711,  3.80171085,  3.84272701,  3.98690953,
        3.86285523,  3.62979468,  3.69251136,  3.818823  ,  3.71451537,
        3.70499407,  3.83383091,  3.85377719,  3.76816908,  2.83948518,
        1.62495624,  0.8867021 ,  0.29930819, -0.47986583, -0.97036848,
       -1.45445434, -1.81063648, -2.36224894, -2.83121443, -3.57723586,
       -4.15090014, -4.74688956, -4.83300932, -4.5716935 , -4.56299415,
       -4.3376936 , -4.24385195, -3.99253131, -3.7111967 , -3.56061976]
assert 2, eqObj(tick2, rs2, precision)

tick3=exec ppo(close, fastPeriod, slowPeriod, maType)  from tickTB where sym=`tick3
rs3=take(double(), 5)
assert 3, eqObj(tick3, rs3,precision)

tick4=exec ppo(close, fastPeriod, slowPeriod, maType)  from tickTB where sym=`tick4
rs4=[, , , , , , , , , , , , , , , , , , , , , , , , ,  -5.95291816,  -5.40335479,  -4.67708258,
        -3.97698121,  -3.23716658,  -2.58336794,  -2.32322525,
        -2.39753663,  -2.3611493 ,  -2.160838  ,  -2.07118293,
        -1.91626296,  -1.43668413,  -1.0075748 ,  -0.37511921,
         0.16529942,   0.25041898,  -0.04995237,  -0.12882431,
        -0.28653273,  -0.89758847,  -1.36480473,  -2.48182638,
        -3.99537407,  -4.69810244,  -4.63406327,  -4.57563974,
        -4.59768137,  -4.6593132 ,  -3.90167046,  -4.09287184,
        -4.02374104,  -4.05362363,  -4.6460875 ,  -5.77243115,
        -6.82179762,  -7.25563887,  -7.41180688,  -8.03661755,
        -8.33906477,  -8.32438124,  -8.98157499,  -9.21586253,
        -9.56660262, -10.04718699, -10.91132175, -11.56693924,
       -12.03441497, -11.95729006, -11.05517733, -10.26988536,
        -9.71456781,  -9.06689694,  -8.0824608 ,  -6.92729075,
        -6.0461703 ,  -5.58460292,  -4.54117113,  -3.30242577,
        -2.51165877,  -2.18585802,  -1.68502407,  -1.31804399,
        -1.28950101,  -1.30759968,  -1.94999432,  -2.3730277 ,
        -2.67238657,  -2.81272275,  -2.79018815,  -1.96486553,
        -1.37813815,  -1.31988506,  -1.58731698,  -1.7129984 ]
assert 4, eqObj(tick4, rs4, precision)

tick5=exec ppo(close, fastPeriod, slowPeriod, maType)  from tickTB where sym=`tick5
rs5=[, , , , , , , , , , , , , , , , , , , , , , , , ,  -7.52942281, -6.93484641, -6.51957448, -5.88055031, -5.22014247,
       -4.83560472, -4.17631027, -3.51159836, -3.51530243, -3.45290211,
       -3.19144537, -2.89520921, -2.56585797, -1.98658687, -1.47497386,
       -1.02248333, -0.57711533, -0.33859197, -0.28135981,  0.15589863,
        0.1780626 , -0.1422046 , -0.49980136, -1.53527217, -2.98020107,
       -3.77428665, -4.01561813, -4.11710065, -4.38891837, -4.29361267,
       -4.2513104 , -4.66153816, -4.72920819, -5.05976483, -5.60396482,
       -6.02730887, -6.12535398, -5.7233249 , -5.18378313, -5.3974324 ,
       -5.32817752, -4.97808393, -5.24808349, -5.24402102, -5.44242055,
       -6.22571291, -7.34677126, -8.14308926, -9.05785589, -9.45619773,
       -8.97798715, -8.55568209, -8.25899465, -7.80990645, -7.14078872,
       -6.29246633, -5.36533595, -4.95525172, -4.45143087, -4.21986617,
       -3.92797439, -2.86385621, -1.15898673, -0.11098375,  0.34548479,
        1.52309621,  2.79009631,  3.59791817,  3.50337679,  3.37701611,
        2.95316561,  2.66484861,  2.4528206 ,  2.00464567,  1.75257412]
assert 5, eqObj(tick5, rs5, precision)

ppoBySym=(exec ppo(close, fastPeriod, slowPeriod, maType)  from tickTB context by sym).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(ppoBySym, rs, precision)

@testing:case="test_ta_function_ma_close_take40_maType=1"
close=1..40
assert 1, eqObj(ppo(close,12,26,1),take(double(),25).append!([51.85185185, 48.27586207, 45.16129032, 42.42424242,
40.        , 37.83783784, 35.8974359 , 34.14634146, 32.55813953, 31.11111111,
29.78723404, 28.57142857, 27.45098039, 26.41509434, 25.45454545]),precision)
assert 2, eqObj(ppo(close,14,30,1),take(double(),29).append!([51.61290323,
       48.48484848, 45.71428571, 43.24324324, 41.02564103, 39.02439024,
       37.20930233, 35.55555556, 34.04255319, 32.65306122, 31.37254902]),precision)


@testing:case="test_ta_function_ma_close_rand40_maType=1"
close=[0.738943,54.656038,68.600639,48.727166,29.061742,80.547883,88.441286,53.563787,84.333949,86.184134,79.958874,80.857146,16.09588,70.020608,46.971058,5.667949,35.074464,50.96734,13.780723,12.020372,60.611425,17.038672,93.005266,21.724079,78.437219,17.679625,78.095357,68.494213,78.234003,24.844407,81.324836,89.290484,29.122386,47.330442,32.111762,59.484709,24.228521,55.667259,42.17003,42.415287]
talib=take(double(),25).append!([-13.45264074,  -6.57350718,  -2.94086548,
         1.23870012,  -3.46531881,   1.33511377,   5.86189486,
         1.06787124,  -0.25146706,  -3.62035368,  -2.07791226,
        -6.38374221,  -4.70348148,  -5.52301605,  -6.08859138])
assert 1, eqObj(ppo(close,12,26,1),talib,precision)
talib=take(double(),29).append!([-1.31257611,
        2.74896603,  6.71518341,  2.61531629,  1.42740604, -1.56019008,
       -0.3868311 , -4.19698151, -2.96374557, -3.81870643, -4.46453828])
assert 2,  eqObj(ppo(close,14,30,1),talib,precision)

@testing:case="test_ta_function_ma_close_maType"
close=1..40
talib=[, , , , , , , , , , , , , , , , , , , , , , , , , 51.85185185, 48.27586207, 45.16129032, 42.42424242, 40.        ,
       37.83783784, 35.8974359 , 34.14634146, 32.55813953, 31.11111111,
       29.78723404, 28.57142857, 27.45098039, 26.41509434, 25.45454545]
assert 1, eqObj(ppo(close,12,26,0), talib,5)

assert 2, eqObj(ppo(close,12,26,1),take(double(),25).append!([51.85185185, 48.27586207, 45.16129032, 42.42424242,
40.        , 37.83783784, 35.8974359 , 34.14634146, 32.55813953, 31.11111111,
29.78723404, 28.57142857, 27.45098039, 26.41509434, 25.45454545]),precision)
talib=[, , , , , , , , , , , , , , , , , , , , , , , , , 26.41509434, 25.        , 23.72881356, 22.58064516, 21.53846154,
       20.58823529, 19.71830986, 18.91891892, 18.18181818, 17.5       ,
       16.86746988, 16.27906977, 15.73033708, 15.2173913 , 14.73684211]
assert 3, eqObj(ppo(close,12,26,2), talib,5)
talib=take(double(),40)
assert 4, eqObj(ppo(close,12,26,3), talib,5)
talib=take(double(),40)
assert 5, eqObj(ppo(close,12,26,4), talib,5)
talib=take(double(),25).append!([ 51.85185185, 48.27586207, 45.16129032, 42.42424242, 40.        ,
       37.83783784, 35.8974359 , 34.14634146, 32.55813953, 31.11111111,
       29.78723404, 28.57142857, 27.45098039, 26.41509434, 25.45454545])
assert 6, eqObj(ppo(close,12,26,5)[26:], talib[26:],5)
talib=[ ,   ,   ,   ,,   ,   ,   ,,   ,   ,   , ,   ,   ,   , ,   ,   ,   , ,   ,   ,   ,,   , -2.62534979e+00, -1.42136772e+00,
       -7.66252882e-01, -4.12354978e-01, -2.21809426e-01, -1.19342527e-01,
       -6.42486002e-02, -3.46140479e-02, -1.86632263e-02, -1.00709518e-02,
       -5.43872248e-03, -2.93936795e-03, -1.58974585e-03, -8.60406360e-04]
assert 7, eqObj(ppo(close,12,26,6), talib,5)
talib=[, , , , , , , , , , , , , , , , , , , , , , , , , , , , , , , ,  0.,  0.,  0.,  0.,  0.,  0.,  0., 0.]
//assert 8, eqObj(ppo(close,12,26,7), talib,5)
talib=take(double(),40)
assert 8, eqObj(ppo(close,12,26,8), talib,5)
