
#include "setup/settings.txt"

use ta

//correl(high, low, timeperiod)

@testing:case="test_ta_function_correl"
x = [89.79, 11.58, 99.9, 81.11, 84.69, 31.38, 60.9, 83.3, 97.26, 98.67]
y = [49.56, 82.26, 99.05, 24.22, 36.71, 26.1, 23.95, 69.59, 58.4, 14.99]

validate = [ , , , ,-0.23734379, 0.03320201, 0.6464398,  0.46267016, 0.71823987, 0.32857739]
assert 1, eqObj(ta::correl(x, y, 5), validate, 6)

validate = [ , , , , , , 0.03609431, 0.09654141, 0.66461608, 0.28429978]
assert 2, eqObj(ta::correl(x, y, 7), validate, 6)

validate = [ , , , , , , , , ,-0.02654986]
assert 3, eqObj(ta::correl(x, y, 10), validate, 6)

high = [10.17, 81.33, 87.88, 44.38, 78.25, 98.26, 14.73, 26.38, 56.53, 28.07]
low = [15.81, 51.88, 58.33, 44.05, 58.87, 27.06, 35.14, 22.42, 33.41, 96.43]
t = table(take(`A`B, 10) as sym, high, low)
re = exec ta::correl(high, low, 5) from t
validate = [ , , , , 0.96023262, -0.16239279, 0.20993966, 0.24660333, 0.2873497, -0.30458156]
assert 4, eqObj(re, validate, 6)

/**
 * different with talib
 * talib returns nan
**/
high = [NULL, 81.33, 87.88, NULL, NULL, NULL, 14.73, 26.38, NULL, 28.07]
low = [NULL, 82.26, NULL, 24.22, 36.71, 26.1, NULL, 69.59, 58.4, 14.99]
validate = take(double(), 9) join double(-1)
assert 5, eqObj(ta::correl(high, low, 5),validate, 6)

@testing:case="test_ta_function_correl_context_by"
tick = loadText(DATA_DIR + "/ticks1.csv")
res = select sym, ta::correl(high, low, 10) as correl from tick context by sym 
tick1 = exec correl from res where sym = `tick1
validate1 = take(double(), 8)
assert 6, eqObj(tick1, validate1, 6)
tick2 = exec top 20 correl from res where sym = `tick2
validate2 = [,,,,,,,,,,,,,,,0.9843575 , 0.98021322, 0.98389528, 0.98895436, 0.99019315]
assert 7, eqObj(tick2, validate2, 6)
tick3 = exec correl from res where sym = `tick3
validate3 = take(double(), 5)
assert 8, eqObj(tick3, validate3, 6)
tick4 = exec correl from res where sym = `tick4
validate4 = [ , , , , , , , ,  , 0.65009713, 0.57701304, 0.46574411,
 0.44511271, 0.45292864, 0.84925232, 0.89132106, 0.91308863, 0.93943984,
 0.95544709, 0.94983047, 0.94415455, 0.96663752, 0.95558184, 0.96180868,
 0.96751688, 0.96006289, 0.94669994, 0.95088189, 0.94010364, 0.94576558,
 0.95213989, 0.90735118, 0.7864309,  0.64639543, 0.64341065, 0.65751216,
 0.65594055, 0.67855683, 0.68949827, 0.68053021, 0.69731138, 0.76126266,
 0.79913265, 0.85000005, 0.86446035, 0.86061212, 0.91513058, 0.93582728,
 0.97015039, 0.9697718,  0.96066944, 0.93067826, 0.91892399, 0.90082603,
 0.79576385, 0.75583879, 0.73365997, 0.73054375, 0.73260292, 0.81544041,
 0.913201,   0.93782384, 0.92812571, 0.93637655, 0.96391739, 0.93455083,
 0.92123015, 0.9161125,  0.85366106, 0.90806631, 0.95099872, 0.96536159,
 0.97046969, 0.97680937, 0.9703169,  0.95898483, 0.94915168, 0.94389313,
 0.9417245,  0.95510408, 0.95832214, 0.97306585, 0.91835858, 0.90932676,
 0.92227576, 0.93016732, 0.91825548, 0.89305949, 0.83948173, 0.80945915,
 0.81362425, 0.92290373, 0.93784648, 0.9352741,  0.93766959, 0.90029643,
 0.89423797, 0.86599072, 0.83702591, 0.82303015]
assert 9, eqObj(tick4, validate4, 6)
tick5 = exec correl from res where sym = `tick5
validate5 = [ , , , , , , , , , 0.70766456, 0.73129148, 0.61195283,
 0.54767871, 0.11392603, 0.8562893,  0.93645753, 0.94337401, 0.92690294,
 0.93700577, 0.93540833, 0.94684394, 0.93615199, 0.91339981, 0.83843914,
 0.81528483, 0.85421696, 0.8187866,  0.68103036, 0.87976996, 0.9304992,
 0.91641827, 0.91579398, 0.89722364, 0.75177537, 0.70295667, 0.70393866,
 0.70479371, 0.59039066, 0.62446393, 0.73683278, 0.75537662, 0.85356529,
 0.86885615, 0.94726523, 0.96322467, 0.9127869,  0.7657633,  0.83640266,
 0.9227829,  0.97180811, 0.97455001, 0.97476921, 0.97098016, 0.96933233,
 0.96427827, 0.91755194, 0.88575722, 0.77155285, 0.67311244, 0.85207245,
 0.90494122, 0.9383286,  0.91928922, 0.90483739, 0.88928308, 0.81250042,
 0.76060506, 0.7705966,  0.76806329, 0.81083278, 0.84184426, 0.93873389,
 0.96507114, 0.9711195,  0.97785901, 0.97314937, 0.96267404, 0.9488577,
 0.91992828, 0.86551152, 0.94293442, 0.96133026, 0.9740652,  0.96282887,
 0.9389247,  0.92970079, 0.91396183, 0.96902732, 0.94030171, 0.94069713,
 0.93519434, 0.95531601, 0.9660625,  0.96117283, 0.94037465, 0.89024484,
 0.8815134,  0.95236512, 0.96417335, 0.96590753]
assert 10, eqObj(tick5, validate5, 6)
