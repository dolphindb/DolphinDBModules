#include "setup/settings.txt"
use ta

precision=5
nan=double()
@testing:case="test_ta_function_minus_dm_use_ticksxtby"
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec ta::minus_dm(high, low, 10) from tickTB where sym=`tick1
rs1=[nan, nan, nan, nan, nan, nan, nan, nan]
assert 1, eqObj(tick1, rs1, precision)

tick2=exec ta::minus_dm(high, low, 10) from tickTB where sym=`tick2
rs2=[       nan,        nan,        nan,        nan,        nan,
              nan,        nan,        nan,        nan,        nan,
              nan,        nan,        nan,        nan,        nan,
       7.18      , 6.462     , 5.8158    , 5.23422   , 5.550798  ,
       4.9957182 , 4.49614638, 4.04653174, 4.47187857, 4.36469071,
       3.92822164, 3.53539948, 3.18185953, 4.13367358, 3.72030622,
       3.3482756 , 4.62344804, 4.93110323, 4.84799291, 4.36319362,
       4.42687426, 5.08418683, 4.57576815, 4.11819133, 3.7063722 ,
       3.33573498, 3.14216148, 4.04794533, 4.5731508 , 4.31583572,
       3.88425215, 4.46582693, 4.01924424, 3.61731982, 3.25558783,
       2.93002905, 2.63702615, 2.37332353, 2.15599118, 1.94039206,
       1.74635285, 1.57171757, 1.42454581, 1.28209123, 1.15388211,
       1.0384939 , 0.93464451, 0.96118006, 0.86506205, 0.77855585,
       0.70070026, 0.90063024, 0.81056721, 0.72951049, 0.80655944,
       0.7259035 , 1.02331315, 0.92098183, 0.82888365, 0.74599528,
       1.02139576, 0.91925618, 0.82733056, 0.86459751, 2.07813776,
       2.75032398, 2.59529158, 2.33576242, 2.41218618, 2.26096756,
       2.03487081, 1.83138373, 2.21824535, 1.99642082, 2.54677874,
       2.47210086, 2.52489078, 2.2724017 , 2.04516153, 1.84064538,
       1.65658084, 1.49092275, 1.46183048, 1.31564743, 1.32408269]
assert 2, eqObj(tick2, rs2, precision)

tick3=exec ta::minus_dm(high, low, 10) from tickTB where sym=`tick3
rs3=[nan, nan, nan, nan, nan]
assert 3, eqObj(tick3, rs3,precision)

tick4=exec ta::minus_dm(high, low, 10) from tickTB where sym=`tick4
rs4=[       nan,        nan,        nan,        nan,        nan,
              nan,        nan,        nan,        nan, 0.89      ,
       0.801     , 1.7009    , 1.53081   , 2.017729  , 2.8459561 ,
       2.56136049, 2.30522444, 3.014702  , 3.1932318 , 2.87390862,
       2.83651776, 3.41286598, 3.07157938, 2.76442144, 2.4879793 ,
       2.23918137, 2.03526323, 1.83173691, 1.64856322, 1.4837069 ,
       1.61533621, 1.45380259, 1.60842233, 1.72758009, 1.55482209,
       1.53933988, 1.38540589, 1.2468653 , 1.12217877, 1.00996089,
       1.1589648 , 1.04306832, 1.54876149, 1.43388534, 1.29049681,
       2.01144713, 1.81030241, 2.38927217, 3.03034496, 2.72731046,
       2.45457941, 2.20912147, 1.98820933, 2.03938839, 1.83544955,
       2.6419046 , 3.00771414, 2.70694272, 2.84624845, 3.22162361,
       3.36946125, 3.03251512, 2.72926361, 2.80633725, 2.66570352,
       2.39913317, 2.74921985, 2.73429787, 2.46086808, 2.49478127,
       2.72530315, 2.58277283, 2.64449555, 2.38004599, 2.14204139,
       1.92783725, 1.73505353, 1.56154818, 1.40539336, 1.26485402,
       1.13836862, 1.15453176, 1.03907858, 0.93517072, 1.06165365,
       1.07548829, 0.96793946, 0.87114551, 1.05403096, 1.00862786,
       1.47776508, 1.81998857, 1.63798971, 1.47419074, 1.32677167,
       1.1940945 , 1.07468505, 1.14721655, 1.52249489, 1.3702454 ]
assert 4, eqObj(tick4, rs4, precision)

tick5=exec ta::minus_dm(high, low, 10) from tickTB where sym=`tick5
rs5=[       nan,        nan,        nan,        nan,        nan,
              nan,        nan,        nan,        nan, 0.83      ,
       0.757     , 1.1113    , 1.00017   , 1.170153  , 1.9731377 ,
       2.23582393, 2.01224154, 1.81101738, 2.36991564, 2.26292408,
       2.03663167, 1.83296851, 2.45967165, 2.21370449, 1.99233404,
       1.79310064, 1.61379057, 1.64241152, 1.47817036, 1.33035333,
       1.19731799, 1.1475862 , 1.03282758, 1.35954482, 1.43359034,
       1.2902313 , 1.16120817, 1.04508736, 0.94057862, 0.84652076,
       0.90186868, 0.81168181, 0.97051363, 1.12346227, 1.01111604,
       0.91000444, 1.49900399, 1.34910359, 1.96419324, 2.51777391,
       2.26599652, 2.03939687, 1.83545718, 1.75191146, 1.82672032,
       1.64404829, 1.88964346, 1.98067911, 1.7826112 , 2.17435008,
       2.04691507, 1.84222356, 1.65800121, 1.49220109, 1.80298098,
       1.80268288, 1.62241459, 1.80017313, 1.67015582, 1.50314024,
       2.02282621, 2.26054359, 2.18448923, 2.29604031, 2.06643628,
       1.85979265, 1.67381339, 1.62643205, 1.46378884, 1.31740996,
       1.18566896, 1.06710207, 0.96039186, 1.15435267, 1.03891741,
       1.04502567, 0.9405231 , 0.84647079, 0.76182371, 1.11564134,
       1.00407721, 0.90366948, 0.81330254, 1.42197228, 1.53977505,
       1.50579755, 1.35521779, 1.21969601, 1.37772641, 1.27995377]
assert 5, eqObj(tick5,rs5, 3)

maBySym=(exec ta::minus_dm(high, low, 10) from tickTB context by sym ).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(maBySym, rs, 3)

@testing:case="test_ta_function_mdm"

//50 periods' trading data

high=[1.32085614, 1.33209744, 1.65334543, 1.98292893, 1.62847154,
       1.61211693, 1.43071194, 1.190888  , 1.21653297, 1.6240297 ,
       1.55916562, 1.95043058, 1.83128158, 1.0707179 , 1.89224494,
       1.59317866, 1.88329497, 1.91443362, 1.41076432, 1.6845114 ,
       1.13100617, 1.02046848, 1.9499835 , 1.60047059, 1.58742749,
       1.23099301, 1.90531251, 1.45867113, 1.022339  , 1.93727506,
       1.14304117, 1.7331815 , 1.20416814, 1.37794859, 1.27718212,
       1.0476559 , 1.10734257, 1.97592021, 1.80915831, 1.53324697,
       1.16292236, 1.88196582, 1.72984907, 1.14992525, 1.59572721,
       1.24367   , 1.99962993, 1.8222214 , 1.46459796, 1.63449398]
low=[1.30108268, 1.27318733, 1.56891503, 1.50662655, 0.75611194,
       0.75633976, 1.028802  , 0.62821371, 0.27378455, 1.58131837,
       0.63604436, 1.87940108, 1.064676  , 0.78270707, 1.40808706,
       1.01905124, 1.72748107, 1.90899843, 0.75722024, 1.18230093,
       0.88702096, 0.02325871, 1.48631746, 0.83526989, 0.63112104,
       0.3343596 , 1.46448969, 1.18459049, 0.55924708, 1.47170194,
       0.92731831, 1.07993085, 0.75357028, 1.01514799, 0.92403917,
       0.72125973, 1.05392379, 1.59623559, 1.50044603, 1.47725066,
       1.13688941, 1.28651591, 1.29634426, 0.33855578, 1.44746285,
       0.57223387, 1.92598898, 1.3356523 , 0.54948566, 1.49217727]


ans=[   NULL,        NULL,        NULL,        NULL,        NULL,
        NULL,        NULL,        NULL,        NULL,        NULL,
        NULL,        NULL,        NULL,    3.57539543, 3.32001004,
       3.47190229, 3.22390927, 2.99363003, 3.93157751, 3.65075054,
       3.68526262, 4.28579182, 3.97966384, 4.3464497 , 4.24013786,
       4.23403231, 3.93160143, 3.93067196, 4.27525308, 3.96987786,
       4.23069879, 3.92850602, 3.97425902, 3.69038337, 3.51789338,
       3.46939472, 3.22158081, 2.9914679 , 2.87358118, 2.69152075,
       2.83963052, 2.63679977, 2.44845693, 3.23135563, 3.00054451,
       3.66144888, 3.39991682, 3.7474023 , 4.26589734, 3.96119039]

precision=6

rs = ta::minus_dm(high,low, 14)
assert 1, eqObj(rs,ans, precision)

@testing:case="test_ta_function_mdm_tbl"
t1=table(high,low)
rs=exec ta::minus_dm(high,low,14) from t1
assert 1, eqObj(rs,ans, precision)

