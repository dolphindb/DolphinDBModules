#include "setup/settings.txt"
use ta

@testing:case="test_ta_function_stoch_different_length", exception=1
close = [0,100.243874,99.677051,100.676061,98.729214,99.811684,101.812203,99.706868,98.214068,99.034305,101.39895,99.739858,98.857177,100.976889,98.488709,99.175023,99.511593,99.997514,99.617737,100.372465,100.106315,100.600162,100.382803,100.136037,100.630854,99.995787,99.57589,102.56802,100.004189,99.821923,102.296099,100.156529,100.320803,101.438503,100.210978,98.201,99.909849,99.709805,100.728769,100.236768,99.456067]
low = [95.401008,94.447881,95.326995,95.746915,95.198542,92.241103,95.51542,96.047782,95.731797,95.768023,94.752951,94.835143,94.889078,96.764887,94.090907,96.445943,96.004783,95.375574,94.133554,94.610997,95.402233,96.695455,95.453434,93.24295,95.410741,95.962799,93.871181,94.916658,93.363155,95.244303,92.966322,95.014757,95.382246,95.910769,96.063154,94.119766,95.249352,93.487744,95.117606,94.431727]
high = [103.810071,103.376478,106.505625,104.882828,106.650134,104.851509,104.997041,102.39901,106.016652,106.119703,105.923447,105.016197,105.475379,105.680278,105.221281,104.706711,105.562832,103.630945,104.348365,101.928638,103.427024,103.717182,102.235982,105.059598,104.616881,104.771264,105.196628,104.601302,105.333064,105.143304,104.937159,106.393391,104.396807,105.240313,105.226435,102.110833,105.446478,103.893739,103.609393,103.860969]
slowk, slowd = stoch(high, low, close, 5, 3, 0, 3, 0)

@testing:case="test_ta_function_stoch_args_5_3_0_3_0"
close = [100.243874,99.677051,100.676061,98.729214,99.811684,101.812203,99.706868,98.214068,99.034305,101.39895,99.739858,98.857177,100.976889,98.488709,99.175023,99.511593,99.997514,99.617737,100.372465,100.106315,100.600162,100.382803,100.136037,100.630854,99.995787,99.57589,102.56802,100.004189,99.821923,102.296099,100.156529,100.320803,101.438503,100.210978,98.201,99.909849,99.709805,100.728769,100.236768,99.456067]
low = [95.401008,94.447881,95.326995,95.746915,95.198542,92.241103,95.51542,96.047782,95.731797,95.768023,94.752951,94.835143,94.889078,96.764887,94.090907,96.445943,96.004783,95.375574,94.133554,94.610997,95.402233,96.695455,95.453434,93.24295,95.410741,95.962799,93.871181,94.916658,93.363155,95.244303,92.966322,95.014757,95.382246,95.910769,96.063154,94.119766,95.249352,93.487744,95.117606,94.431727]
high = [103.810071,103.376478,106.505625,104.882828,106.650134,104.851509,104.997041,102.39901,106.016652,106.119703,105.923447,105.016197,105.475379,105.680278,105.221281,104.706711,105.562832,103.630945,104.348365,101.928638,103.427024,103.717182,102.235982,105.059598,104.616881,104.771264,105.196628,104.601302,105.333064,105.143304,104.937159,106.393391,104.396807,105.240313,105.226435,102.110833,105.446478,103.893739,103.609393,103.860969]
slowk, slowd = stoch(high, low, close, 5, 3, 0, 3, 0)
outk = [46.80382278, 51.52791772, 52.33452654, 48.65514072, 44.9118945 , 41.2428634 , 43.52951411, 40.86860334, 46.90195867, 48.47580598, 51.13680929, 51.56771011, 54.53122307, 56.6720208 , 58.84006014, 60.82066885, 59.47683359, 57.7537753 , 62.91674207, 62.7218055 , 62.84347243, 61.71623521, 62.24272999, 62.5144527 , 58.67093016, 57.27563725, 52.01312612, 46.70553751, 45.17123899, 52.35926904, 55.44624809, 55.63122875]
outd = [51.36629938, 50.52061748, 50.22208901, 50.83919499, 48.63385392, 44.93663287, 43.22809067, 41.88032695, 43.76669204, 45.415456, 48.83819131, 50.39344179, 52.41191415, 54.25698466, 56.68110133, 58.77758326, 59.71252086, 59.35042591, 60.04911699, 61.13077429, 62.82734, 62.42717105, 62.26747921, 62.15780596, 61.14270428, 59.4870067, 55.98656451, 51.99810029, 47.96330088, 48.07868185, 50.99225204, 54.47891529]
assert 1, eqObj(slowk[8:], outk, 6)
assert 2, eqObj(slowd[8:], outd, 6)

@testing:case="test_ta_function_stoch_args_5_3_0_3_0_starting_NULL"
close = [NULL,NULL,NULL,100.243874,99.677051,100.676061,98.729214,99.811684,101.812203,99.706868,98.214068,99.034305,101.39895,99.739858,98.857177,100.976889,98.488709,99.175023,99.511593,99.997514,99.617737,100.372465,100.106315,100.600162,100.382803,100.136037,100.630854,99.995787,99.57589,102.56802,100.004189,99.821923,102.296099,100.156529,100.320803,101.438503,100.210978,98.201,99.909849,99.709805,100.728769,100.236768,99.456067]
low = [NULL,NULL,NULL,95.401008,94.447881,95.326995,95.746915,95.198542,92.241103,95.51542,96.047782,95.731797,95.768023,94.752951,94.835143,94.889078,96.764887,94.090907,96.445943,96.004783,95.375574,94.133554,94.610997,95.402233,96.695455,95.453434,93.24295,95.410741,95.962799,93.871181,94.916658,93.363155,95.244303,92.966322,95.014757,95.382246,95.910769,96.063154,94.119766,95.249352,93.487744,95.117606,94.431727]
high = [NULL,NULL,NULL,103.810071,103.376478,106.505625,104.882828,106.650134,104.851509,104.997041,102.39901,106.016652,106.119703,105.923447,105.016197,105.475379,105.680278,105.221281,104.706711,105.562832,103.630945,104.348365,101.928638,103.427024,103.717182,102.235982,105.059598,104.616881,104.771264,105.196628,104.601302,105.333064,105.143304,104.937159,106.393391,104.396807,105.240313,105.226435,102.110833,105.446478,103.893739,103.609393,103.860969]
slowk, slowd = stoch(high, low, close, 5, 3, 0, 3, 0)
outk = [46.80382278, 51.52791772, 52.33452654, 48.65514072, 44.9118945 , 41.2428634 , 43.52951411, 40.86860334, 46.90195867, 48.47580598, 51.13680929, 51.56771011, 54.53122307, 56.6720208 , 58.84006014, 60.82066885, 59.47683359, 57.7537753 , 62.91674207, 62.7218055 , 62.84347243, 61.71623521, 62.24272999, 62.5144527 , 58.67093016, 57.27563725, 52.01312612, 46.70553751, 45.17123899, 52.35926904, 55.44624809, 55.63122875]
outd = [51.36629938, 50.52061748, 50.22208901, 50.83919499, 48.63385392, 44.93663287, 43.22809067, 41.88032695, 43.76669204, 45.415456, 48.83819131, 50.39344179, 52.41191415, 54.25698466, 56.68110133, 58.77758326, 59.71252086, 59.35042591, 60.04911699, 61.13077429, 62.82734, 62.42717105, 62.26747921, 62.15780596, 61.14270428, 59.4870067, 55.98656451, 51.99810029, 47.96330088, 48.07868185, 50.99225204, 54.47891529]
assert 1, eqObj(slowk[11:], outk, 6)
assert 2, eqObj(slowd[11:], outd, 6)

@testing:case="test_ta_function_stoch_args_2_6_1_5_0"
close = [100.243874,99.677051,100.676061,98.729214,99.811684,101.812203,99.706868,98.214068,99.034305,101.39895,99.739858,98.857177,100.976889,98.488709,99.175023,99.511593,99.997514,99.617737,100.372465,100.106315,100.600162,100.382803,100.136037,100.630854,99.995787,99.57589,102.56802,100.004189,99.821923,102.296099,100.156529,100.320803,101.438503,100.210978,98.201,99.909849,99.709805,100.728769,100.236768,99.456067]
low = [95.401008,94.447881,95.326995,95.746915,95.198542,92.241103,95.51542,96.047782,95.731797,95.768023,94.752951,94.835143,94.889078,96.764887,94.090907,96.445943,96.004783,95.375574,94.133554,94.610997,95.402233,96.695455,95.453434,93.24295,95.410741,95.962799,93.871181,94.916658,93.363155,95.244303,92.966322,95.014757,95.382246,95.910769,96.063154,94.119766,95.249352,93.487744,95.117606,94.431727]
high = [103.810071,103.376478,106.505625,104.882828,106.650134,104.851509,104.997041,102.39901,106.016652,106.119703,105.923447,105.016197,105.475379,105.680278,105.221281,104.706711,105.562832,103.630945,104.348365,101.928638,103.427024,103.717182,102.235982,105.059598,104.616881,104.771264,105.196628,104.601302,105.333064,105.143304,104.937159,106.393391,104.396807,105.240313,105.226435,102.110833,105.446478,103.893739,103.609393,103.860969]
slowk, slowd = stoch(high, low, close, 2, 6, 1, 5, 0)
outk = [44.46645547, 42.25937192, 46.67723606, 42.8714819 , 43.15642504, 44.74080124, 43.89299909, 43.24981449, 48.34332651, 51.23711214, 56.00792771, 57.11965818, 56.98958365, 58.57003064, 58.16339525, 54.25870198, 60.69628697, 58.82662172, 57.43569317, 62.34787706, 61.40492052, 59.51024035, 58.6371593 , 55.87869777, 46.92711436, 48.41410702, 48.68227848, 52.07308368, 55.72565268, 55.02822759]
outd = [44.93760908, 43.28354915, 43.77407846, 44.19569638, 43.88619408, 43.94106323, 44.26778867, 43.58230435, 44.67667327, 46.2928107, 48.54623599, 51.19156781, 53.93952164, 55.98486246, 57.37011909, 57.02027394, 57.7355997, 58.10300731, 57.87613982, 58.71303618, 60.14227989, 59.90507056, 59.86717808, 59.555779, 56.47162646, 53.87346376, 51.70787139, 50.39505626, 50.36444725, 51.98466989]
assert 1, eqObj(slowk[10:], outk, 6)
assert 2, eqObj(slowd[10:], outd, 6)


@testing:case="test_ta_function_stoch_context_by"
precision = 6
tickTB = loadText(DATA_DIR+"/ticks1.csv")

slowk = (exec stoch(high, low, close, 5, 3, 0, 3, 0)[0] as slowk from tickTB context by sym).slowk
slowd = (exec stoch(high, low, close, 5, 3, 0, 3, 0)[1] as slowd from tickTB context by sym).slowd

outk = [00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,32.543258,65.876591,94.639126,90.998428,81.223992,63.180849,38.626184,34.045389,28.991391,27.579075,19.671533,41.569343,66.060084,79.41082,78.472222,77.831437,71.215523,44.357201,25.353005,7.547622,7.186799,0.674374,8.804455,16.344367,33.910065,50.741932,65.484845,62.911869,37.94992,15.281739,7.301768,15.265363,20.912419,27.268652,33.387053,50.089127,53.386809,68.638146,70.586288,78.742317,71.140107,75.2831,74.684008,76.555369,77.639752,79.606625,89.337474,89.732143,88.244048,80.564309,78.031817,81.107214,74.167069,64.701105,53.589994,58.013798,47.406261,38.768791,36.069492,54.257908,65.206813,72.268856,73.044518,77.99804,71.580661,45.186066,22.200069,8.590757,16.037984,16.374409,19.798535,19.197031,26.134158,20.251471,15.680411,9.355172,8.807777,12.382799,29.109549,55.259479,70.472542,79.506173,68.826584,69.130477,65.356753,60.841944,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,35.155087,56.151022,78.665093,67.946722,55.538258,28.272629,14.797452,11.729305,22.873394,22.873394,21.658194,36.254296,47.079038,44.492225,42.132293,61.141805,80.464545,83.839422,75.039036,72.946353,67.775354,66.741486,63.349673,48.319582,29.652915,17.414353,24.410601,34.264482,42.078441,58.757561,77.415308,93.214555,95.381603,83.805873,56.305498,35.679281,25.884627,25.552435,19.971199,11.496623,7.478899,10.028888,32.414509,54.299195,66.56036,62.841406,73.376812,58.299213,56.500016,37.022104,33.785955,17.449693,7.980236,15.659669,28.047121,28.359143,30.070859,35.009342,30.311355,29.292666,18.10219,19.954042,9.167869,5.626203,12.316017,28.451537,58.65987,75.866706,81.836327,71.360137,72.595761,79.298634,82.410484,71.317829,74.806202,77.650769,85.205623,67.514124,59.60452,48.438894,37.351323,21.209273,11.150794,19.410162,28.323471,44.049967,52.196848,71.854968,85.07909,83.600024,59.975429,39.346807,00F,00F,00F,00F,00F,00F,00F,00F,26.092685,39.023088,42.308802,53.245758,59.611385,53.020375,35.012712,16.378538,23.891273,36.909871,25.467417,21.204859,17.372613,22.680253,21.486924,42.500003,66.044733,86.709847,86.834491,81.267057,84.659914,84.065569,75.274413,74.527953,67.151164,53.15794,31.322947,22.420298,36.549708,48.722998,66.869928,80.129669,89.169623,78.494387,65.971996,46.333712,51.54809,46.717172,44.901796,23.45679,12.675712,6.104424,8.262381,22.549103,40.799404,51.746699,62.4173,66.072472,49.042146,39.64264,22.743878,28.414376,21.693192,31.784678,55.620005,75.103476,69.666048,51.275128,41.766904,33.538826,31.181447,14.149237,13.288361,4.592708,7.526863,11.000222,19.894287,48.183761,69.564742,83.727034,75.848246,77.544188,83.868007,90.431005,77.207151,63.665484,41.049649,38.414055,55.080722,79.012346,88.317757,71.962617,63.441314,66.642294,69.423551,53.889872,35.513991,19.319603,14.854087,19.25509,22.356694,30.730673]
outk.nullFill!(slowk)
outd = [00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,13.383286,33.761759,64.352992,83.838048,88.953848,78.467756,61.010342,45.284141,33.887655,30.205285,25.414,29.60665,42.433653,62.346749,74.647709,78.571493,75.839727,64.468054,46.975243,25.752609,13.362475,5.136265,5.555209,8.607732,19.686296,33.665455,50.045614,59.712882,55.448878,38.714509,20.177809,12.61629,14.493183,21.148811,27.189375,36.914944,45.620996,57.371361,64.203748,72.655584,73.489571,75.055175,73.702405,75.507492,76.293043,77.933915,82.194617,86.225414,89.104555,86.180167,82.280058,79.901113,77.7687,73.325129,64.152722,58.768299,53.003351,48.06295,40.748181,43.032064,51.844738,63.911192,70.173396,74.437138,74.20774,64.921589,46.322265,25.325631,15.609603,13.667717,17.403642,18.456658,21.709908,21.860887,20.68868,15.095685,11.28112,10.181916,16.766708,32.250609,51.613856,68.412731,72.935099,72.487745,67.771271,65.109725,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,00F,29.352358,38.348475,56.657067,67.587612,67.383358,50.585869,32.869446,18.266462,16.466717,19.158698,22.468328,26.928628,34.997176,42.60852,44.567852,49.255441,61.246214,75.148591,79.781001,77.274937,71.920248,69.154398,65.955504,59.470247,47.10739,31.795617,23.825956,25.363145,33.584508,45.033495,59.417103,76.462474,88.670488,90.800677,78.497658,58.596884,39.289802,29.038781,23.802754,19.006753,12.98224,9.668137,16.640765,32.247531,51.091355,61.233653,67.592859,64.839143,62.725347,50.607111,42.436025,29.419251,19.738628,13.696533,17.229009,24.021978,28.825708,31.146448,31.797186,31.537788,25.90207,22.449632,15.741367,11.582704,9.036696,15.464585,33.142475,54.326038,72.120968,76.35439,75.264075,74.418177,78.101626,77.675649,76.178172,74.5916,79.220865,76.790172,70.774756,58.519179,48.464912,35.666497,23.23713,17.256743,19.628143,30.594534,41.523429,56.033928,69.710302,80.178027,76.218181,60.974086,00F,00F,00F,00F,00F,00F,00F,00F,31.157519,32.490361,35.808192,44.859216,51.721982,55.292506,49.214824,34.803875,25.094174,25.726561,28.756187,27.860716,21.348296,20.419242,20.513263,28.88906,43.343887,65.084861,79.863024,84.937131,84.25382,83.330847,81.333299,77.955978,72.317843,64.945685,50.544017,35.633728,30.097651,35.897668,50.714211,65.240865,78.723073,82.597893,77.878668,63.600031,54.617932,48.199658,47.722352,38.358586,27.011433,14.078975,9.014172,12.305302,23.870296,38.365069,51.654468,60.078824,59.177306,51.585753,37.142888,30.266964,24.283815,27.297415,36.365958,54.169387,66.79651,65.348217,54.236027,42.193619,35.495726,26.289837,19.539682,10.676769,8.469311,7.706598,12.807124,26.359423,45.88093,67.158512,76.380007,79.039823,79.086814,83.947733,83.835388,77.101213,60.640761,47.709729,44.848142,57.502374,74.136941,79.76424,74.573896,67.348742,66.502386,63.318572,52.942471,36.241155,23.229227,17.809593,18.821957,24.114152]
outd.nullFill!(slowd)
assert 1, eqObj(slowk, outk, precision)
assert 2, eqObj(slowd, outd, precision)
