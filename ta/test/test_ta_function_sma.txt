#include "setup/settings.txt"
use ta

precision=5
nan=double()
@testing:case="test_ta_function_sma_use_ticksxtby"
tickTB=loadText(DATA_DIR+"/ticks1.csv")

tick1=exec ta::sma(close,10) from tickTB where sym=`tick1
rs1=[nan, nan, nan, nan, nan, nan, nan, nan]
assert 1, eqObj(tick1, rs1, precision)

tick2=exec ta::sma(close,10) from tickTB where sym=`tick2
rs2=[   nan,    nan,    nan,    nan,    nan,    nan,    nan,    nan,
          nan,    nan,    nan,    nan,    nan,    nan,    nan, 13.146,
       13.37 , 13.442, 13.44 , 13.406, 13.899, 14.509, 15.07 , 15.557,
       15.553, 15.549, 15.478, 15.453, 15.43 , 15.583, 15.68 , 15.53 ,
       15.478, 15.404, 15.292, 14.977, 14.633, 14.303, 14.001, 13.662,
       13.399, 13.252, 12.979, 12.733, 12.534, 12.385, 12.22 , 12.079,
       11.884, 11.7  , 11.449, 11.309, 11.29 , 11.362, 11.434, 11.551,
       11.727, 11.877, 12.053, 12.174, 12.477, 12.74 , 12.972, 13.214,
       13.453, 13.672, 13.857, 14.048, 14.204, 14.395, 14.425, 14.414,
       14.491, 14.579, 14.588, 14.6  , 14.676, 14.743, 14.805, 14.689,
       14.525, 14.42 , 14.265, 14.034, 13.852, 13.631, 13.379, 13.085,
       12.792, 12.584, 12.455, 12.255, 12.107, 12.056, 11.946, 11.88 ,
       11.792, 11.772, 11.767, 11.81 ]
assert 2, eqObj(tick2, rs2, precision)

tick3=exec ta::sma(close,10) from tickTB where sym=`tick3
rs3=[nan, nan, nan, nan, nan]
assert 3, eqObj(tick3, rs3,precision)

tick4=exec ta::sma(close,10) from tickTB where sym=`tick4
rs4=[   nan,    nan,    nan,    nan,    nan,    nan,    nan,    nan,
          nan, 11.681, 11.745, 11.674, 11.628, 11.463, 11.271, 11.152,
       11.039, 10.835, 10.572, 10.393, 10.122,  9.863,  9.688,  9.641,
        9.745,  9.757,  9.767,  9.909, 10.05 , 10.117, 10.278, 10.453,
       10.5  , 10.523, 10.519, 10.501, 10.512, 10.537, 10.557, 10.596,
       10.636, 10.668, 10.691, 10.726, 10.729, 10.679, 10.622, 10.423,
       10.139,  9.876,  9.677,  9.518,  9.394,  9.238,  9.185,  9.098,
        9.031,  9.047,  9.072,  8.959,  8.755,  8.594,  8.46 ,  8.277,
        8.017,  7.874,  7.635,  7.432,  7.276,  7.172,  7.037,  6.86 ,
        6.667,  6.564,  6.51 ,  6.434,  6.418,  6.39 ,  6.418,  6.498,
        6.621,  6.722,  6.88 ,  7.041,  7.121,  7.176,  7.266,  7.343,
        7.363,  7.353,  7.294,  7.267,  7.187,  7.08 ,  7.001,  7.019,
        7.01 ,  6.968,  6.922,  6.887]
assert 4, eqObj(tick4, rs4, precision)

tick5=exec ta::sma(close,10) from tickTB where sym=`tick5
rs5=[   nan,    nan,    nan,    nan,    nan,    nan,    nan,    nan,
          nan, 10.043,  9.994,  9.938,  9.925,  9.82 ,  9.687,  9.569,
        9.463,  9.382,  9.215,  9.034,  8.887,  8.724,  8.478,  8.373,
        8.369,  8.331,  8.308,  8.263,  8.333,  8.397,  8.434,  8.518,
        8.663,  8.671,  8.675,  8.694,  8.705,  8.737,  8.775,  8.807,
        8.864,  8.897,  8.906,  8.962,  9.059,  9.101,  9.099,  9.078,
        8.941,  8.732,  8.555,  8.406,  8.275,  8.135,  7.978,  7.849,
        7.709,  7.602,  7.547,  7.528,  7.469,  7.39 ,  7.345,  7.339,
        7.241,  7.168,  7.166,  7.088,  7.057,  7.035,  6.957,  6.815,
        6.638,  6.418,  6.284,  6.189,  6.068,  5.992,  5.911,  5.871,
        5.91 ,  6.011,  6.078,  6.183,  6.25 ,  6.266,  6.349,  6.511,
        6.64 ,  6.721,  6.854,  7.006,  7.177,  7.277,  7.393,  7.478,
        7.507,  7.471,  7.435,  7.44 ]
assert 5, eqObj(tick5,rs5, 3)

maBySym=(exec ta::sma(close,10) from tickTB context by sym ).values()[0]
rs=rs1.join(rs2).join(rs3).join(rs4).join(rs5)
assert 6, eqObj(maBySym, rs, 3)

@testing:case="test_ta_function_sma"
x=[89.79,11.58,99.9,81.11,84.69,31.38,60.9,83.3,97.26,98.67]
validate=[ , , , , 73.414, 61.732, 71.596, 68.276,71.506, 74.302]
assert 1,eqObj(ta::sma(x,5),validate,6)

validate=[  ,, 67.09, 64.19666667, 88.56666667, 65.72666667, 58.99      , 58.52666667, 80.48666667, 93.07666667]
assert 2,eqObj(ta::sma(x,3),validate,6)